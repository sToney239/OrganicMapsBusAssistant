<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>公共交通路线规划</title>
    <style>
html, body {
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif, 'Courier New', monospace;
    background-color: #1e1e1e;
    color: #d4d4d4;
}

.container {
    max-width: 800px;
    margin: 5px auto;
    padding: 20px;
}

.input-group {
    display: flex;
    gap: 10px;
    margin-bottom: 0px;
    align-items: flex-end;
}

.swap-container {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 0 10px;
    width: 40px;
    height: 76px;
}

.target-container {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 0 10px;
    width: 40px;
    height: 76px;
}

.swap-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #4ec9b0;
    color: white;
    border: none;
    cursor: pointer;
    font-size: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s, transform 0.2s;
    flex-shrink: 0;
    line-height: 1;
    padding: 0;
}

.swap-btn:hover {
    background-color: #3ba996;
    transform: scale(1.05);
}

.swap-btn:active {
    transform: scale(0.95);
}

.target-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #4ec9b0;
    color: white;
    border: none;
    cursor: pointer;
    font-size: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s, transform 0.2s;
    flex-shrink: 0;
    line-height: 1;
    padding: 0;
}

.target-btn:hover {
    background-color: #4ec9b0;
    transform: scale(1.05);
}

.target-btn:active {
    transform: scale(0.95);
}

.input-item {
    flex: 1;
    margin-bottom: 15px;
}

.input-item-wide {
    flex: 1;
    margin-bottom: 15px;
}

.input-item-prepend {
    margin-bottom: 8px;
}

.input-item-text {
    font-weight: bold;
    color: #cccccc;
    font-size: 14px;
}

#cityinput, #startinput, #endinput, #departuretime {
    width: 100%;
    padding: 12px;
    padding-right: 70px;
    border: 1px solid #3e3e42;
    border-radius: 4px;
    font-size: 14px;
    box-sizing: border-box;
    background-color: #3c3c3c;
    color: #d4d4d4;
    font-family: Arial, sans-serif, 'Courier New', monospace;
    transition: border-color 0.2s, background-color 0.2s;
}
#cityinput {
    padding-left: 50px;
    padding-right: 12px;
}

#policy-select {
    width: 100%;
    padding: 12px 35px 12px 12px;
    border: 1px solid #3e3e42;
    border-radius: 4px;
    font-size: 14px;
    box-sizing: border-box;
    background-color: #3c3c3c;
    color: #d4d4d4;
    font-family: Arial, sans-serif, 'Courier New', monospace;
    transition: border-color 0.2s, background-color 0.2s;
    cursor: pointer;
}

#cityinput:focus, #startinput:focus, #endinput:focus, #departuretime:focus, #policy-select:focus {
    outline: none;
    border-color: #0078d4;
    background-color: #404040;
}

#cityinput::placeholder, #startinput::placeholder, #endinput::placeholder, #departuretime::placeholder, #policy-select::placeholder {
    color: #858585;
}

.search-btn {
    background-color: #0078d4;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-family: Arial, sans-serif, 'Courier New', monospace;
    transition: background-color 0.2s;
    margin-top: 20px;
    width: 100%;
}

.search-btn:hover {
    background-color: #106ebe;
}

.search-btn:disabled {
    background-color: #555;
    cursor: not-allowed;
}

.result-container {
    margin-top: 20px;
    padding: 15px;
    border-left: 4px solid #0078d4;
    background-color: #2d2d30;
    border-radius: 4px;
}

.result-title {
    font-weight: bold;
    margin-bottom: 10px;
    color: #cccccc;
    font-size: 16px;
}

.route-item {
    margin-bottom: 15px;
    background-color: #252526;
    border-radius: 4px;
    border: 1px solid #3e3e42;
    overflow: hidden;
    transition: all 0.3s ease;
}

.route-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s ease;
}

.route-header:hover {
    background-color: #2d2d30;
}

.route-header.expanded {
    border-bottom: 1px solid #3e3e42;
}

.route-title {
    color: #569cd6;
    font-weight: bold;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.expand-icon {
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-top: 8px solid #569cd6;
    transition: transform 0.3s ease;
    transform-origin: center;
}

.expand-icon.expanded {
    transform: rotate(180deg);
}

.route-summary {
    display: flex;
    gap: 20px;
    align-items: center;
    flex-wrap: wrap;
}

.route-time, .route-cost, .route-distance {
    color: #ce9178;
    font-size: 14px;
}

.route-transport {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
}

.transport-badge {
    padding: 4px 8px;
    border-radius: 3px;
    font-size: 12px;
    font-weight: bold;
    color: white;
}

.transport-badge.walk {
    background-color: #4ec9b0;
}

.transport-badge.bus {
    background-color: #dcdcaa;
}

.transport-badge.metro {
    background-color: #c586c0;
}

.route-steps {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
}

.route-steps.expanded {
    max-height: 2000px;
}

.route-steps-content {
    padding: 0 15px 15px 15px;
}

.step-item {
    display: flex;
    align-items: flex-start;
    margin-bottom: 12px;
    padding: 8px;
    background-color: #1e1e1e;
    border-radius: 4px;
}

.step-icon {
    width: 30px;
    height: 30px;
    background-color: #0078d4;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 10px;
    font-weight: bold;
    margin-right: 12px;
    flex-shrink: 0;
}

.step-icon.walk {
    background-color: #12B571;
}

.step-icon.metro {
    background-color: #0482BA;
}

.step-icon.bus {
    background-color: #F67B4D;
}

.step-content {
    flex: 1;
}

.step-instruction {
    color: #d4d4d4;
    font-size: 14px;
    margin-bottom: 4px;
}

.step-details {
    color: #858585;
    font-size: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 4px;
}

.subway-stops {
    margin-top: 8px;
    padding-left: 12px;
    font-size: 12px;
    color: #9cdcfe;
}

.subway-stops-header {
    cursor: pointer;
    color: #569cd6;
    font-size: 12px;
    margin-bottom: 4px;
    user-select: none;
    transition: color 0.2s;
}

.subway-stops-header:hover {
    color: #4a9eff;
    text-decoration: underline;
}

.bus-stops {
    margin-top: 8px;
    padding-left: 12px;
    font-size: 12px;
    color: #9cdcfe;
}

.bus-stops-header {
    cursor: pointer;
    color: #dcdcaa;
    font-size: 12px;
    margin-bottom: 4px;
    user-select: none;
    transition: color 0.2s;
}

.bus-stops-header:hover {
    color: #b8b869;
    text-decoration: underline;
}

.subway-stops-list {
    display: none;
    line-height: 1.4;
    margin-left: 8px;
}

.subway-stops-list.expanded {
    display: block;
}

.subway-stop-item {
    padding: 2px 0;
    border-left: 2px solid #569cd6;
    padding-left: 8px;
    margin-bottom: 2px;
}

.subway-stop-item:last-child {
    border-left-color: #c586c0;
}

.om-walk-link {
    color: #569cd6;
    text-decoration: none;
    font-size: 12px;
    padding: 2px 6px;
    border-radius: 3px;
    background-color: #1e1e1e;
    transition: background-color 0.2s;
    white-space: nowrap;
}

.om-walk-link:hover {
    background-color: #3c3c3c;
    text-decoration: underline;
}

.autocomplete-container {
    position: relative;
}

.clear-btn {
    position: absolute;
    right: 44px;
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    border: none;
    background: #666;
    color: #d4d4d4;
    border-radius: 50%;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s, color 0.2s;
    z-index: 10;
    line-height: 1;
    padding: 0;
}

.clear-btn:hover {
    background: #0078d4;
    color: white;
}

.clear-btn:active {
    transform: translateY(-50%) scale(0.9);
}

.settings-btn {
    position: fixed;
    top: 20px;
    right: 20px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #3C3C3C;
    color: white;
    border: none;
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s, transform 0.2s;
    z-index: 1000;
    line-height: 1;
    padding: 0;
}

.settings-btn:hover {
    background-color: #3C3C3C;
    transform: scale(1.05);
}

.settings-btn:active {
    transform: scale(0.95);
}

.city-input-container {
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 1000;
    width: 120px;
}

.city-input-wrapper {
    position: relative;
    width: 100%;
}

.city-label {
    position: absolute;
    left: 0;
    top: 0;
    background-color: #666666;
    color: #d4d4d4;
    padding: 0 8px;
    font-size: 12px;
    font-weight: bold;
    font-family: Arial, sans-serif, 'Courier New', monospace;
    height: 40px;
    width: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1;
    border-radius: 4px 0 0 4px;
}

.city-input-container input {
    width: 160px;
    padding: 12px 12px 12px 45px;
    border: 1px solid #3e3e42;
    border-radius: 4px;
    font-size: 14px;
    box-sizing: border-box;
    background-color: #3c3c3c;
    color: #d4d4d4;
    font-family: Arial, sans-serif, 'Courier New', monospace;
    transition: border-color 0.2s, background-color 0.2s;
    height: 40px;
}

.city-input-container input:focus {
    outline: none;
    border-color: #0078d4;
    background-color: #404040;
}

.city-input-container input::placeholder {
    color: #858585;
}

.settings-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}

.settings-modal.show {
    display: flex;
}

.settings-card {
    background-color: #252526;
    border: 1px solid #3e3e42;
    border-radius: 8px;
    padding: 30px;
    max-width: 500px;
    width: 80%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.settings-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
}

.settings-title {
    color: #cccccc;
    font-size: 20px;
    font-weight: bold;
}

.close-btn {
    background: none;
    border: none;
    color: #858585;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.2s;
}

.close-btn:hover {
    color: #d4d4d4;
}

.setting-item {
    margin-bottom: 20px;
}

.setting-label {
    display: block;
    color: #cccccc;
    font-size: 14px;
    font-weight: bold;
    margin-bottom: 8px;
}

.setting-input-group {
    position: relative;
}

.setting-input {
    width: 100%;
    padding: 12px;
    padding-right: 35px;
    border: 1px solid #3e3e42;
    border-radius: 4px;
    font-size: 14px;
    box-sizing: border-box;
    background-color: #3c3c3c;
    color: #d4d4d4;
    font-family: Arial, sans-serif, 'Courier New', monospace;
    transition: border-color 0.2s, background-color 0.2s;
}

.setting-input:focus {
    outline: none;
    border-color: #0078d4;
    background-color: #404040;
}

.setting-input::placeholder {
    color: #858585;
}

.save-settings-btn {
    background-color: #3C3C3C;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-family: Arial, sans-serif, 'Courier New', monospace;
    transition: background-color 0.2s;
    width: 100%;
    margin-top: 20px;
}

.save-settings-btn:hover {
    background-color: #3C3C3C;
}

.autocomplete-dropdown {
    position: absolute;
    right: 0;
    top: 0;
    width: 35px;
    height: 100%;
    border: none;
    background: #666;
    color: #d4d4d4;
    border-radius: 0 4px 4px 0;
    cursor: pointer;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s;
    z-index: 10;
    padding: 0;
}

.autocomplete-dropdown:hover {
    background: #0078d4;
    color: white;
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    right: 0;
    background: #252526;
    border: 1px solid #3e3e42;
    border-radius: 4px;
    min-width: 200px;
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    display: none;
}

.dropdown-menu.show {
    display: block;
}

.dropdown-item {
    padding: 10px 15px;
    color: #d4d4d4;
    cursor: pointer;
    border-bottom: 1px solid #3e3e42;
    font-size: 13px;
    transition: background-color 0.2s;
}

.dropdown-item:hover {
    background-color: #3c3c3c;
}

.dropdown-item:last-child {
    border-bottom: none;
}

.dropdown-item.header {
    color: #858585;
    font-size: 11px;
    font-weight: bold;
    text-transform: uppercase;
    padding: 8px 15px;
    cursor: default;
}

.dropdown-item.header:hover {
    background-color: transparent;
}

.amap-sug-result {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #252526;
    border: 1px solid #3e3e42;
    border-top: none;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    border-radius: 0 0 4px 4px;
}

.amap-sug-result .auto-item {
    padding: 8px 12px;
    color: #d4d4d4;
    cursor: pointer;
    border-bottom: 1px solid #3e3e42;
    font-family: Arial, sans-serif, 'Courier New', monospace;
    font-size: 13px;
}

.amap-sug-result .auto-item:hover {
    background-color: #3c3c3c;
}

.amap-sug-result .auto-item:last-child {
    border-bottom: none;
}

.hidden {
    display: none;
}

.loading {
    text-align: center;
    color: #cccccc;
    padding: 20px;
}

.error {
    color: #f48771;
    background-color: #2d1b1b;
    padding: 15px;
    border-radius: 4px;
    border: 1px solid #8c2d2d;
}


    </style>
</head>
<body>

    <!-- 设置按钮 -->
    <button class="settings-btn" onclick="openSettings()" title="设置常用地址">=</button>
    
    <!-- 城市输入框 -->
    <div class="city-input-container">
        <div class="city-label">城市</div>
        <div class="city-input-wrapper">
            <input id='cityinput' type="text" placeholder="输入城市名称">
        </div>
    </div>
    
    <!-- 设置弹窗 -->
    <div id="settings-modal" class="settings-modal">
        <div class="settings-card">
            <div class="settings-header">
                <h2 class="settings-title">设置常用地址</h2>
                <button class="close-btn" onclick="closeSettings()">×</button>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">家庭地址</label>
                <div class="setting-input-group">
                    <input id="home-input" type="text" class="setting-input" placeholder="输入家庭地址">
                    <button class="clear-btn" onclick="clearSettingInput('home-input')" title="清除内容" style="right: 10px;">×</button>
                </div>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">公司地址</label>
                <div class="setting-input-group">
                    <input id="company-input" type="text" class="setting-input" placeholder="输入公司地址">
                    <button class="clear-btn" onclick="clearSettingInput('company-input')" title="清除内容" style="right: 10px;">×</button>
                </div>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">收藏地址</label>
                <div class="setting-input-group">
                    <input id="favorite-input" type="text" class="setting-input" placeholder="输入收藏地址">
                    <button class="clear-btn" onclick="clearSettingInput('favorite-input')" title="清除内容" style="right: 10px;">×</button>
                </div>
            </div>
            
            <button class="save-settings-btn" onclick="saveSettings()">保存设置</button>
        </div>
    </div>

    <div class="container">
        <h1 style="text-align: center; color: #cccccc; margin-bottom: 15px; font-weight: 300; font-size: 24px;padding-top: 20px;">公共交通路线规划</h1>
        
        <div class="input-group">
            <div class="input-item" style="flex: 6.5;">
                <div class="input-item-prepend">
                    <span class="input-item-text">出发时间</span>
                </div>
                <div class="autocomplete-container">
                    <input id='departuretime' type="text" placeholder="现在出发，或输入8:30、14:30等">
                    <button class="clear-btn" onclick="clearDepartureTime()" title="清除时间">×</button>
                    <button class="autocomplete-dropdown" onclick="toggleTimeDropdown()" title="快速选择时间">▼</button>
                    <div id="time-dropdown" class="dropdown-menu">
                        <div class="dropdown-item header">快速选择</div>
                        <div class="dropdown-item" onclick="selectQuickTime('now')">现在出发</div>
                        <div class="dropdown-item" onclick="selectQuickTime('morning')">早高峰 (8:00)</div>
                        <div class="dropdown-item" onclick="selectQuickTime('noon')">中午 (12:00)</div>
                        <div class="dropdown-item" onclick="selectQuickTime('evening')">晚高峰 (18:00)</div>
                        <div class="dropdown-item" onclick="selectQuickTime('night')">夜间 (22:00)</div>
                    </div>
                </div>
            </div>
            <div class="input-item" style="flex: 3.5;">
                <div class="input-item-prepend">
                    <span class="input-item-text">路线选择依据</span>
                </div>
                <div class="autocomplete-container">
                    <input id="policy-select" type="text" readonly value="默认" data-value="0">
                    <button class="autocomplete-dropdown" onclick="togglePolicyDropdown()" title="选择路线依据">▼</button>
                    <div id="policy-dropdown" class="dropdown-menu">
                        <div class="dropdown-item" onclick="selectPolicy('0', '默认')">默认</div>
                        <div class="dropdown-item" onclick="selectPolicy('1', '最经济')">最经济</div>
                        <div class="dropdown-item" onclick="selectPolicy('2', '最少换乘')">最少换乘</div>
                        <div class="dropdown-item" onclick="selectPolicy('3', '最少步行')">最少步行</div>
                        <div class="dropdown-item" onclick="selectPolicy('4', '最舒适')">最舒适</div>
                        <div class="dropdown-item" onclick="selectPolicy('5', '不乘地铁')">不乘地铁</div>
                        <div class="dropdown-item" onclick="selectPolicy('7', '地铁优先')">地铁优先</div>
                        <div class="dropdown-item" onclick="selectPolicy('8', '时间短')">时间短</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="input-group">
            <div class="input-item-wide">
                <div class="input-item-prepend">
                    <span class="input-item-text">出发地</span>
                </div>
                <div class="autocomplete-container">
                    <input id='startinput' type="text" placeholder="输入出发地名称">
                    <button class="clear-btn" onclick="clearInput('startinput')" title="清除内容">×</button>
                    <button class="autocomplete-dropdown" onclick="toggleDropdown('start')" title="历史记录和常用地址">▼</button>
                    <div id="start-dropdown" class="dropdown-menu">
                        <div class="dropdown-item header">历史记录</div>
                        <div id="start-history"></div>
                        <div class="dropdown-item header">常用地址</div>
                        <div class="dropdown-item" onclick="selectFromDropdown('start', 'home')">🏠 家</div>
                        <div class="dropdown-item" onclick="selectFromDropdown('start', 'company')">🏢 公司</div>
                        <div class="dropdown-item" onclick="selectFromDropdown('start', 'favorite')">⭐ 收藏</div>
                    </div>
                </div>
            </div>
            <div class="swap-container">
                <button id="swap-btn" class="swap-btn" onclick="swapStartEnd()" title="交换起终点">⇵</button>
            </div>
        </div>
        
        <div class="input-group">
            <div class="input-item-wide">
                <div class="input-item-prepend">
                    <span class="input-item-text">目的地</span>
                </div>
                <div class="autocomplete-container">
                    <input id='endinput' type="text" placeholder="输入目的地名称">
                    <button class="clear-btn" onclick="clearInput('endinput')" title="清除内容">×</button>
                    <button class="autocomplete-dropdown" onclick="toggleDropdown('end')" title="历史记录和常用地址">▼</button>
                    <div id="end-dropdown" class="dropdown-menu">
                        <div class="dropdown-item header">历史记录</div>
                        <div id="end-history"></div>
                        <div class="dropdown-item header">常用地址</div>
                        <div class="dropdown-item" onclick="selectFromDropdown('end', 'home')">🏠 家</div>
                        <div class="dropdown-item" onclick="selectFromDropdown('end', 'company')">🏢 公司</div>
                        <div class="dropdown-item" onclick="selectFromDropdown('end', 'favorite')">⭐ 收藏</div>
                    </div>
                </div>
            </div>
            <div class="target-container">
                <button class="target-btn" onclick="locateTarget()" title="定位到终点">⌖</button>
            </div>
        </div>
        <button id="search-btn" class="search-btn">规划路线</button>
        

        
        <div id="loading" class="loading hidden">
            正在规划路线...
        </div>
        
        <div id="error" class="error hidden"></div>
        
        <div id="result" class="result-container hidden">
            <div class="result-title">路线方案</div>
            <div id="routes-container"></div>
        </div>
    </div>  
    <!-- 引入高德地图API -->
    <script type="text/javascript">
		// API Keys 配置
		window.AMAP_CONFIG = {
			// 用于高德地图Web端JS API
			JSwebApiKey: '******',
			
			// 用于高德地图web服务API
			webApiKey: '******',

			safetyKey: '******'
		};
        // 设置高德地图安全密钥（必须在加载API之前设置）
        window._AMapSecurityConfig = {
            securityJsCode: window.AMAP_CONFIG.safetyKey
        };
        
        document.write('<script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=' + window.AMAP_CONFIG.JSwebApiKey + '&plugin=AMap.PlaceSearch"><\/script>');
    </script>
    
    <!-- 引入城市编码数据 -->
     
    
    <!-- 坐标转换函数 -->
    
    <!-- 坐标转换函数 -->
    

    <script type="text/javascript">
var citycode = ["[{\"cityname\":\"北京市\",\"adcode\":110000,\"citycode\":\"010\"},{\"cityname\":\"广州市\",\"adcode\":440100,\"citycode\":\"020\"},{\"cityname\":\"上海市\",\"adcode\":310000,\"citycode\":\"021\"},{\"cityname\":\"天津市\",\"adcode\":120000,\"citycode\":\"022\"},{\"cityname\":\"重庆市\",\"adcode\":500000,\"citycode\":\"023\"},{\"cityname\":\"沈阳市\",\"adcode\":210100,\"citycode\":\"024\"},{\"cityname\":\"南京市\",\"adcode\":320100,\"citycode\":\"025\"},{\"cityname\":\"武汉市\",\"adcode\":420100,\"citycode\":\"027\"},{\"cityname\":\"成都市\",\"adcode\":510100,\"citycode\":\"028\"},{\"cityname\":\"西安市\",\"adcode\":610100,\"citycode\":\"029\"},{\"cityname\":\"邯郸市\",\"adcode\":130400,\"citycode\":\"0310\"},{\"cityname\":\"石家庄市\",\"adcode\":130100,\"citycode\":\"0311\"},{\"cityname\":\"保定市\",\"adcode\":130600,\"citycode\":\"0312\"},{\"cityname\":\"张家口市\",\"adcode\":130700,\"citycode\":\"0313\"},{\"cityname\":\"承德市\",\"adcode\":130800,\"citycode\":\"0314\"},{\"cityname\":\"唐山市\",\"adcode\":130200,\"citycode\":\"0315\"},{\"cityname\":\"廊坊市\",\"adcode\":131000,\"citycode\":\"0316\"},{\"cityname\":\"沧州市\",\"adcode\":130900,\"citycode\":\"0317\"},{\"cityname\":\"衡水市\",\"adcode\":131100,\"citycode\":\"0318\"},{\"cityname\":\"邢台市\",\"adcode\":130500,\"citycode\":\"0319\"},{\"cityname\":\"秦皇岛市\",\"adcode\":130300,\"citycode\":\"0335\"},{\"cityname\":\"朔州市\",\"adcode\":140600,\"citycode\":\"0349\"},{\"cityname\":\"忻州市\",\"adcode\":140900,\"citycode\":\"0350\"},{\"cityname\":\"太原市\",\"adcode\":140100,\"citycode\":\"0351\"},{\"cityname\":\"大同市\",\"adcode\":140200,\"citycode\":\"0352\"},{\"cityname\":\"阳泉市\",\"adcode\":140300,\"citycode\":\"0353\"},{\"cityname\":\"晋中市\",\"adcode\":140700,\"citycode\":\"0354\"},{\"cityname\":\"长治市\",\"adcode\":140400,\"citycode\":\"0355\"},{\"cityname\":\"晋城市\",\"adcode\":140500,\"citycode\":\"0356\"},{\"cityname\":\"临汾市\",\"adcode\":141000,\"citycode\":\"0357\"},{\"cityname\":\"吕梁市\",\"adcode\":141100,\"citycode\":\"0358\"},{\"cityname\":\"运城市\",\"adcode\":140800,\"citycode\":\"0359\"},{\"cityname\":\"商丘市\",\"adcode\":411400,\"citycode\":\"0370\"},{\"cityname\":\"郑州市\",\"adcode\":410100,\"citycode\":\"0371\"},{\"cityname\":\"安阳市\",\"adcode\":410500,\"citycode\":\"0372\"},{\"cityname\":\"新乡市\",\"adcode\":410700,\"citycode\":\"0373\"},{\"cityname\":\"许昌市\",\"adcode\":411000,\"citycode\":\"0374\"},{\"cityname\":\"平顶山市\",\"adcode\":410400,\"citycode\":\"0375\"},{\"cityname\":\"信阳市\",\"adcode\":411500,\"citycode\":\"0376\"},{\"cityname\":\"南阳市\",\"adcode\":411300,\"citycode\":\"0377\"},{\"cityname\":\"开封市\",\"adcode\":410200,\"citycode\":\"0378\"},{\"cityname\":\"洛阳市\",\"adcode\":410300,\"citycode\":\"0379\"},{\"cityname\":\"焦作市\",\"adcode\":410800,\"citycode\":\"0391\"},{\"cityname\":\"鹤壁市\",\"adcode\":410600,\"citycode\":\"0392\"},{\"cityname\":\"濮阳市\",\"adcode\":410900,\"citycode\":\"0393\"},{\"cityname\":\"周口市\",\"adcode\":411600,\"citycode\":\"0394\"},{\"cityname\":\"漯河市\",\"adcode\":411100,\"citycode\":\"0395\"},{\"cityname\":\"驻马店市\",\"adcode\":411700,\"citycode\":\"0396\"},{\"cityname\":\"三门峡市\",\"adcode\":411200,\"citycode\":\"0398\"},{\"cityname\":\"铁岭市\",\"adcode\":211200,\"citycode\":\"0410\"},{\"cityname\":\"大连市\",\"adcode\":210200,\"citycode\":\"0411\"},{\"cityname\":\"鞍山市\",\"adcode\":210300,\"citycode\":\"0412\"},{\"cityname\":\"抚顺市\",\"adcode\":210400,\"citycode\":\"0413\"},{\"cityname\":\"本溪市\",\"adcode\":210500,\"citycode\":\"0414\"},{\"cityname\":\"丹东市\",\"adcode\":210600,\"citycode\":\"0415\"},{\"cityname\":\"锦州市\",\"adcode\":210700,\"citycode\":\"0416\"},{\"cityname\":\"营口市\",\"adcode\":210800,\"citycode\":\"0417\"},{\"cityname\":\"阜新市\",\"adcode\":210900,\"citycode\":\"0418\"},{\"cityname\":\"辽阳市\",\"adcode\":211000,\"citycode\":\"0419\"},{\"cityname\":\"朝阳市\",\"adcode\":211300,\"citycode\":\"0421\"},{\"cityname\":\"盘锦市\",\"adcode\":211100,\"citycode\":\"0427\"},{\"cityname\":\"葫芦岛市\",\"adcode\":211400,\"citycode\":\"0429\"},{\"cityname\":\"长春市\",\"adcode\":220100,\"citycode\":\"0431\"},{\"cityname\":\"吉林市\",\"adcode\":220200,\"citycode\":\"0432\"},{\"cityname\":\"四平市\",\"adcode\":220300,\"citycode\":\"0434\"},{\"cityname\":\"通化市\",\"adcode\":220500,\"citycode\":\"0435\"},{\"cityname\":\"白城市\",\"adcode\":220800,\"citycode\":\"0436\"},{\"cityname\":\"辽源市\",\"adcode\":220400,\"citycode\":\"0437\"},{\"cityname\":\"松原市\",\"adcode\":220700,\"citycode\":\"0438\"},{\"cityname\":\"白山市\",\"adcode\":220600,\"citycode\":\"0439\"},{\"cityname\":\"哈尔滨市\",\"adcode\":230100,\"citycode\":\"0451\"},{\"cityname\":\"齐齐哈尔市\",\"adcode\":230200,\"citycode\":\"0452\"},{\"cityname\":\"牡丹江市\",\"adcode\":231000,\"citycode\":\"0453\"},{\"cityname\":\"佳木斯市\",\"adcode\":230800,\"citycode\":\"0454\"},{\"cityname\":\"绥化市\",\"adcode\":231200,\"citycode\":\"0455\"},{\"cityname\":\"黑河市\",\"adcode\":231100,\"citycode\":\"0456\"},{\"cityname\":\"大兴安岭地区\",\"adcode\":232700,\"citycode\":\"0457\"},{\"cityname\":\"伊春市\",\"adcode\":230700,\"citycode\":\"0458\"},{\"cityname\":\"大庆市\",\"adcode\":230600,\"citycode\":\"0459\"},{\"cityname\":\"七台河市\",\"adcode\":230900,\"citycode\":\"0464\"},{\"cityname\":\"鸡西市\",\"adcode\":230300,\"citycode\":\"0467\"},{\"cityname\":\"鹤岗市\",\"adcode\":230400,\"citycode\":\"0468\"},{\"cityname\":\"双鸭山市\",\"adcode\":230500,\"citycode\":\"0469\"},{\"cityname\":\"呼伦贝尔市\",\"adcode\":150700,\"citycode\":\"0470\"},{\"cityname\":\"呼和浩特市\",\"adcode\":150100,\"citycode\":\"0471\"},{\"cityname\":\"包头市\",\"adcode\":150200,\"citycode\":\"0472\"},{\"cityname\":\"乌海市\",\"adcode\":150300,\"citycode\":\"0473\"},{\"cityname\":\"乌兰察布市\",\"adcode\":150900,\"citycode\":\"0474\"},{\"cityname\":\"通辽市\",\"adcode\":150500,\"citycode\":\"0475\"},{\"cityname\":\"赤峰市\",\"adcode\":150400,\"citycode\":\"0476\"},{\"cityname\":\"鄂尔多斯市\",\"adcode\":150600,\"citycode\":\"0477\"},{\"cityname\":\"巴彦淖尔市\",\"adcode\":150800,\"citycode\":\"0478\"},{\"cityname\":\"锡林郭勒盟\",\"adcode\":152500,\"citycode\":\"0479\"},{\"cityname\":\"兴安盟\",\"adcode\":152200,\"citycode\":\"0482\"},{\"cityname\":\"阿拉善盟\",\"adcode\":152900,\"citycode\":\"0483\"},{\"cityname\":\"无锡市\",\"adcode\":320200,\"citycode\":\"0510\"},{\"cityname\":\"镇江市\",\"adcode\":321100,\"citycode\":\"0511\"},{\"cityname\":\"苏州市\",\"adcode\":320500,\"citycode\":\"0512\"},{\"cityname\":\"南通市\",\"adcode\":320600,\"citycode\":\"0513\"},{\"cityname\":\"扬州市\",\"adcode\":321000,\"citycode\":\"0514\"},{\"cityname\":\"盐城市\",\"adcode\":320900,\"citycode\":\"0515\"},{\"cityname\":\"徐州市\",\"adcode\":320300,\"citycode\":\"0516\"},{\"cityname\":\"淮安市\",\"adcode\":320800,\"citycode\":\"0517\"},{\"cityname\":\"连云港市\",\"adcode\":320700,\"citycode\":\"0518\"},{\"cityname\":\"常州市\",\"adcode\":320400,\"citycode\":\"0519\"},{\"cityname\":\"泰州市\",\"adcode\":321200,\"citycode\":\"0523\"},{\"cityname\":\"宿迁市\",\"adcode\":321300,\"citycode\":\"0527\"},{\"cityname\":\"菏泽市\",\"adcode\":371700,\"citycode\":\"0530\"},{\"cityname\":\"济南市\",\"adcode\":370100,\"citycode\":\"0531\"},{\"cityname\":\"青岛市\",\"adcode\":370200,\"citycode\":\"0532\"},{\"cityname\":\"淄博市\",\"adcode\":370300,\"citycode\":\"0533\"},{\"cityname\":\"德州市\",\"adcode\":371400,\"citycode\":\"0534\"},{\"cityname\":\"烟台市\",\"adcode\":370600,\"citycode\":\"0535\"},{\"cityname\":\"潍坊市\",\"adcode\":370700,\"citycode\":\"0536\"},{\"cityname\":\"济宁市\",\"adcode\":370800,\"citycode\":\"0537\"},{\"cityname\":\"泰安市\",\"adcode\":370900,\"citycode\":\"0538\"},{\"cityname\":\"临沂市\",\"adcode\":371300,\"citycode\":\"0539\"},{\"cityname\":\"滨州市\",\"adcode\":371600,\"citycode\":\"0543\"},{\"cityname\":\"东营市\",\"adcode\":370500,\"citycode\":\"0546\"},{\"cityname\":\"滁州市\",\"adcode\":341100,\"citycode\":\"0550\"},{\"cityname\":\"合肥市\",\"adcode\":340100,\"citycode\":\"0551\"},{\"cityname\":\"蚌埠市\",\"adcode\":340300,\"citycode\":\"0552\"},{\"cityname\":\"芜湖市\",\"adcode\":340200,\"citycode\":\"0553\"},{\"cityname\":\"淮南市\",\"adcode\":340400,\"citycode\":\"0554\"},{\"cityname\":\"马鞍山市\",\"adcode\":340500,\"citycode\":\"0555\"},{\"cityname\":\"安庆市\",\"adcode\":340800,\"citycode\":\"0556\"},{\"cityname\":\"宿州市\",\"adcode\":341300,\"citycode\":\"0557\"},{\"cityname\":\"亳州市\",\"adcode\":341600,\"citycode\":\"0558\"},{\"cityname\":\"黄山市\",\"adcode\":341000,\"citycode\":\"0559\"},{\"cityname\":\"淮北市\",\"adcode\":340600,\"citycode\":\"0561\"},{\"cityname\":\"铜陵市\",\"adcode\":340700,\"citycode\":\"0562\"},{\"cityname\":\"宣城市\",\"adcode\":341800,\"citycode\":\"0563\"},{\"cityname\":\"六安市\",\"adcode\":341500,\"citycode\":\"0564\"},{\"cityname\":\"池州市\",\"adcode\":341700,\"citycode\":\"0566\"},{\"cityname\":\"衢州市\",\"adcode\":330800,\"citycode\":\"0570\"},{\"cityname\":\"杭州市\",\"adcode\":330100,\"citycode\":\"0571\"},{\"cityname\":\"湖州市\",\"adcode\":330500,\"citycode\":\"0572\"},{\"cityname\":\"嘉兴市\",\"adcode\":330400,\"citycode\":\"0573\"},{\"cityname\":\"宁波市\",\"adcode\":330200,\"citycode\":\"0574\"},{\"cityname\":\"绍兴市\",\"adcode\":330600,\"citycode\":\"0575\"},{\"cityname\":\"台州市\",\"adcode\":331000,\"citycode\":\"0576\"},{\"cityname\":\"温州市\",\"adcode\":330300,\"citycode\":\"0577\"},{\"cityname\":\"丽水市\",\"adcode\":331100,\"citycode\":\"0578\"},{\"cityname\":\"金华市\",\"adcode\":330700,\"citycode\":\"0579\"},{\"cityname\":\"舟山市\",\"adcode\":330900,\"citycode\":\"0580\"},{\"cityname\":\"福州市\",\"adcode\":350100,\"citycode\":\"0591\"},{\"cityname\":\"厦门市\",\"adcode\":350200,\"citycode\":\"0592\"},{\"cityname\":\"宁德市\",\"adcode\":350900,\"citycode\":\"0593\"},{\"cityname\":\"莆田市\",\"adcode\":350300,\"citycode\":\"0594\"},{\"cityname\":\"泉州市\",\"adcode\":350500,\"citycode\":\"0595\"},{\"cityname\":\"漳州市\",\"adcode\":350600,\"citycode\":\"0596\"},{\"cityname\":\"龙岩市\",\"adcode\":350800,\"citycode\":\"0597\"},{\"cityname\":\"三明市\",\"adcode\":350400,\"citycode\":\"0598\"},{\"cityname\":\"南平市\",\"adcode\":350700,\"citycode\":\"0599\"},{\"cityname\":\"威海市\",\"adcode\":371000,\"citycode\":\"0631\"},{\"cityname\":\"枣庄市\",\"adcode\":370400,\"citycode\":\"0632\"},{\"cityname\":\"日照市\",\"adcode\":371100,\"citycode\":\"0633\"},{\"cityname\":\"聊城市\",\"adcode\":371500,\"citycode\":\"0635\"},{\"cityname\":\"汕尾市\",\"adcode\":441500,\"citycode\":\"0660\"},{\"cityname\":\"阳江市\",\"adcode\":441700,\"citycode\":\"0662\"},{\"cityname\":\"揭阳市\",\"adcode\":445200,\"citycode\":\"0663\"},{\"cityname\":\"茂名市\",\"adcode\":440900,\"citycode\":\"0668\"},{\"cityname\":\"西双版纳傣族自治州\",\"adcode\":532800,\"citycode\":\"0691\"},{\"cityname\":\"德宏傣族景颇族自治州\",\"adcode\":533100,\"citycode\":\"0692\"},{\"cityname\":\"鹰潭市\",\"adcode\":360600,\"citycode\":\"0701\"},{\"cityname\":\"襄阳市\",\"adcode\":420600,\"citycode\":\"0710\"},{\"cityname\":\"鄂州市\",\"adcode\":420700,\"citycode\":\"0711\"},{\"cityname\":\"孝感市\",\"adcode\":420900,\"citycode\":\"0712\"},{\"cityname\":\"黄冈市\",\"adcode\":421100,\"citycode\":\"0713\"},{\"cityname\":\"黄石市\",\"adcode\":420200,\"citycode\":\"0714\"},{\"cityname\":\"咸宁市\",\"adcode\":421200,\"citycode\":\"0715\"},{\"cityname\":\"荆州市\",\"adcode\":421000,\"citycode\":\"0716\"},{\"cityname\":\"宜昌市\",\"adcode\":420500,\"citycode\":\"0717\"},{\"cityname\":\"恩施土家族苗族自治州\",\"adcode\":422800,\"citycode\":\"0718\"},{\"cityname\":\"十堰市\",\"adcode\":420300,\"citycode\":\"0719\"},{\"cityname\":\"随州市\",\"adcode\":421300,\"citycode\":\"0722\"},{\"cityname\":\"荆门市\",\"adcode\":420800,\"citycode\":\"0724\"},{\"cityname\":\"仙桃市\",\"adcode\":429004,\"citycode\":\"0728\"},{\"cityname\":\"岳阳市\",\"adcode\":430600,\"citycode\":\"0730\"},{\"cityname\":\"长沙市\",\"adcode\":430100,\"citycode\":\"0731\"},{\"cityname\":\"湘潭市\",\"adcode\":430300,\"citycode\":\"0732\"},{\"cityname\":\"株洲市\",\"adcode\":430200,\"citycode\":\"0733\"},{\"cityname\":\"衡阳市\",\"adcode\":430400,\"citycode\":\"0734\"},{\"cityname\":\"郴州市\",\"adcode\":431000,\"citycode\":\"0735\"},{\"cityname\":\"常德市\",\"adcode\":430700,\"citycode\":\"0736\"},{\"cityname\":\"益阳市\",\"adcode\":430900,\"citycode\":\"0737\"},{\"cityname\":\"娄底市\",\"adcode\":431300,\"citycode\":\"0738\"},{\"cityname\":\"邵阳市\",\"adcode\":430500,\"citycode\":\"0739\"},{\"cityname\":\"湘西土家族苗族自治州\",\"adcode\":433100,\"citycode\":\"0743\"},{\"cityname\":\"张家界市\",\"adcode\":430800,\"citycode\":\"0744\"},{\"cityname\":\"怀化市\",\"adcode\":431200,\"citycode\":\"0745\"},{\"cityname\":\"永州市\",\"adcode\":431100,\"citycode\":\"0746\"},{\"cityname\":\"江门市\",\"adcode\":440700,\"citycode\":\"0750\"},{\"cityname\":\"韶关市\",\"adcode\":440200,\"citycode\":\"0751\"},{\"cityname\":\"惠州市\",\"adcode\":441300,\"citycode\":\"0752\"},{\"cityname\":\"梅州市\",\"adcode\":441400,\"citycode\":\"0753\"},{\"cityname\":\"汕头市\",\"adcode\":440500,\"citycode\":\"0754\"},{\"cityname\":\"深圳市\",\"adcode\":440300,\"citycode\":\"0755\"},{\"cityname\":\"珠海市\",\"adcode\":440400,\"citycode\":\"0756\"},{\"cityname\":\"佛山市\",\"adcode\":440600,\"citycode\":\"0757\"},{\"cityname\":\"肇庆市\",\"adcode\":441200,\"citycode\":\"0758\"},{\"cityname\":\"湛江市\",\"adcode\":440800,\"citycode\":\"0759\"},{\"cityname\":\"中山市\",\"adcode\":442000,\"citycode\":\"0760\"},{\"cityname\":\"河源市\",\"adcode\":441600,\"citycode\":\"0762\"},{\"cityname\":\"清远市\",\"adcode\":441800,\"citycode\":\"0763\"},{\"cityname\":\"云浮市\",\"adcode\":445300,\"citycode\":\"0766\"},{\"cityname\":\"潮州市\",\"adcode\":445100,\"citycode\":\"0768\"},{\"cityname\":\"东莞市\",\"adcode\":441900,\"citycode\":\"0769\"},{\"cityname\":\"防城港市\",\"adcode\":450600,\"citycode\":\"0770\"},{\"cityname\":\"南宁市\",\"adcode\":450100,\"citycode\":\"0771\"},{\"cityname\":\"柳州市\",\"adcode\":450200,\"citycode\":\"0772\"},{\"cityname\":\"桂林市\",\"adcode\":450300,\"citycode\":\"0773\"},{\"cityname\":\"梧州市\",\"adcode\":450400,\"citycode\":\"0774\"},{\"cityname\":\"玉林市\",\"adcode\":450900,\"citycode\":\"0775\"},{\"cityname\":\"百色市\",\"adcode\":451000,\"citycode\":\"0776\"},{\"cityname\":\"钦州市\",\"adcode\":450700,\"citycode\":\"0777\"},{\"cityname\":\"河池市\",\"adcode\":451200,\"citycode\":\"0778\"},{\"cityname\":\"北海市\",\"adcode\":450500,\"citycode\":\"0779\"},{\"cityname\":\"新余市\",\"adcode\":360500,\"citycode\":\"0790\"},{\"cityname\":\"南昌市\",\"adcode\":360100,\"citycode\":\"0791\"},{\"cityname\":\"九江市\",\"adcode\":360400,\"citycode\":\"0792\"},{\"cityname\":\"上饶市\",\"adcode\":361100,\"citycode\":\"0793\"},{\"cityname\":\"抚州市\",\"adcode\":361000,\"citycode\":\"0794\"},{\"cityname\":\"宜春市\",\"adcode\":360900,\"citycode\":\"0795\"},{\"cityname\":\"吉安市\",\"adcode\":360800,\"citycode\":\"0796\"},{\"cityname\":\"赣州市\",\"adcode\":360700,\"citycode\":\"0797\"},{\"cityname\":\"景德镇市\",\"adcode\":360200,\"citycode\":\"0798\"},{\"cityname\":\"萍乡市\",\"adcode\":360300,\"citycode\":\"0799\"},{\"cityname\":\"保亭黎族苗族自治县\",\"adcode\":469029,\"citycode\":\"0801\"},{\"cityname\":\"白沙黎族自治县\",\"adcode\":469025,\"citycode\":\"0802\"},{\"cityname\":\"昌江黎族自治县\",\"adcode\":469026,\"citycode\":\"0803\"},{\"cityname\":\"澄迈县\",\"adcode\":469023,\"citycode\":\"0804\"},{\"cityname\":\"儋州市\",\"adcode\":460400,\"citycode\":\"0805\"},{\"cityname\":\"定安县\",\"adcode\":469021,\"citycode\":\"0806\"},{\"cityname\":\"东方市\",\"adcode\":469007,\"citycode\":\"0807\"},{\"cityname\":\"陵水黎族自治县\",\"adcode\":469028,\"citycode\":\"0809\"},{\"cityname\":\"攀枝花市\",\"adcode\":510400,\"citycode\":\"0812\"},{\"cityname\":\"自贡市\",\"adcode\":510300,\"citycode\":\"0813\"},{\"cityname\":\"绵阳市\",\"adcode\":510700,\"citycode\":\"0816\"},{\"cityname\":\"南充市\",\"adcode\":511300,\"citycode\":\"0817\"},{\"cityname\":\"达州市\",\"adcode\":511700,\"citycode\":\"0818\"},{\"cityname\":\"遂宁市\",\"adcode\":510900,\"citycode\":\"0825\"},{\"cityname\":\"广安市\",\"adcode\":511600,\"citycode\":\"0826\"},{\"cityname\":\"巴中市\",\"adcode\":511900,\"citycode\":\"0827\"},{\"cityname\":\"泸州市\",\"adcode\":510500,\"citycode\":\"0830\"},{\"cityname\":\"宜宾市\",\"adcode\":511500,\"citycode\":\"0831\"},{\"cityname\":\"资阳市\",\"adcode\":512000,\"citycode\":\"0832\"},{\"cityname\":\"乐山市\",\"adcode\":511100,\"citycode\":\"0833\"},{\"cityname\":\"凉山彝族自治州\",\"adcode\":513400,\"citycode\":\"0834\"},{\"cityname\":\"雅安市\",\"adcode\":511800,\"citycode\":\"0835\"},{\"cityname\":\"甘孜藏族自治州\",\"adcode\":513300,\"citycode\":\"0836\"},{\"cityname\":\"阿坝藏族羌族自治州\",\"adcode\":513200,\"citycode\":\"0837\"},{\"cityname\":\"德阳市\",\"adcode\":510600,\"citycode\":\"0838\"},{\"cityname\":\"广元市\",\"adcode\":510800,\"citycode\":\"0839\"},{\"cityname\":\"贵阳市\",\"adcode\":520100,\"citycode\":\"0851\"},{\"cityname\":\"遵义市\",\"adcode\":520300,\"citycode\":\"0852\"},{\"cityname\":\"安顺市\",\"adcode\":520400,\"citycode\":\"0853\"},{\"cityname\":\"黔南布依族苗族自治州\",\"adcode\":522700,\"citycode\":\"0854\"},{\"cityname\":\"黔东南苗族侗族自治州\",\"adcode\":522600,\"citycode\":\"0855\"},{\"cityname\":\"铜仁市\",\"adcode\":520600,\"citycode\":\"0856\"},{\"cityname\":\"毕节市\",\"adcode\":520500,\"citycode\":\"0857\"},{\"cityname\":\"六盘水市\",\"adcode\":520200,\"citycode\":\"0858\"},{\"cityname\":\"黔西南布依族苗族自治州\",\"adcode\":522300,\"citycode\":\"0859\"},{\"cityname\":\"昭通市\",\"adcode\":530600,\"citycode\":\"0870\"},{\"cityname\":\"昆明市\",\"adcode\":530100,\"citycode\":\"0871\"},{\"cityname\":\"大理白族自治州\",\"adcode\":532900,\"citycode\":\"0872\"},{\"cityname\":\"红河哈尼族彝族自治州\",\"adcode\":532500,\"citycode\":\"0873\"},{\"cityname\":\"曲靖市\",\"adcode\":530300,\"citycode\":\"0874\"},{\"cityname\":\"保山市\",\"adcode\":530500,\"citycode\":\"0875\"},{\"cityname\":\"文山壮族苗族自治州\",\"adcode\":532600,\"citycode\":\"0876\"},{\"cityname\":\"玉溪市\",\"adcode\":530400,\"citycode\":\"0877\"},{\"cityname\":\"楚雄彝族自治州\",\"adcode\":532300,\"citycode\":\"0878\"},{\"cityname\":\"普洱市\",\"adcode\":530800,\"citycode\":\"0879\"},{\"cityname\":\"临沧市\",\"adcode\":530900,\"citycode\":\"0883\"},{\"cityname\":\"怒江傈僳族自治州\",\"adcode\":533300,\"citycode\":\"0886\"},{\"cityname\":\"迪庆藏族自治州\",\"adcode\":533400,\"citycode\":\"0887\"},{\"cityname\":\"丽江市\",\"adcode\":530700,\"citycode\":\"0888\"},{\"cityname\":\"拉萨市\",\"adcode\":540100,\"citycode\":\"0891\"},{\"cityname\":\"日喀则市\",\"adcode\":540200,\"citycode\":\"0892\"},{\"cityname\":\"山南市\",\"adcode\":540500,\"citycode\":\"0893\"},{\"cityname\":\"林芝市\",\"adcode\":540400,\"citycode\":\"0894\"},{\"cityname\":\"昌都市\",\"adcode\":540300,\"citycode\":\"0895\"},{\"cityname\":\"那曲市\",\"adcode\":540600,\"citycode\":\"0896\"},{\"cityname\":\"阿里地区\",\"adcode\":542500,\"citycode\":\"0897\"},{\"cityname\":\"海口市\",\"adcode\":460100,\"citycode\":\"0898\"},{\"cityname\":\"三亚市\",\"adcode\":460200,\"citycode\":\"0899\"},{\"cityname\":\"塔城地区\",\"adcode\":654200,\"citycode\":\"0901\"},{\"cityname\":\"哈密市\",\"adcode\":650500,\"citycode\":\"0902\"},{\"cityname\":\"和田地区\",\"adcode\":653200,\"citycode\":\"0903\"},{\"cityname\":\"阿勒泰地区\",\"adcode\":654300,\"citycode\":\"0906\"},{\"cityname\":\"克孜勒苏柯尔克孜自治州\",\"adcode\":653000,\"citycode\":\"0908\"},{\"cityname\":\"博尔塔拉蒙古自治州\",\"adcode\":652700,\"citycode\":\"0909\"},{\"cityname\":\"咸阳市\",\"adcode\":610400,\"citycode\":\"0910\"},{\"cityname\":\"延安市\",\"adcode\":610600,\"citycode\":\"0911\"},{\"cityname\":\"榆林市\",\"adcode\":610800,\"citycode\":\"0912\"},{\"cityname\":\"渭南市\",\"adcode\":610500,\"citycode\":\"0913\"},{\"cityname\":\"商洛市\",\"adcode\":611000,\"citycode\":\"0914\"},{\"cityname\":\"安康市\",\"adcode\":610900,\"citycode\":\"0915\"},{\"cityname\":\"汉中市\",\"adcode\":610700,\"citycode\":\"0916\"},{\"cityname\":\"宝鸡市\",\"adcode\":610300,\"citycode\":\"0917\"},{\"cityname\":\"铜川市\",\"adcode\":610200,\"citycode\":\"0919\"},{\"cityname\":\"临夏回族自治州\",\"adcode\":622900,\"citycode\":\"0930\"},{\"cityname\":\"兰州市\",\"adcode\":620100,\"citycode\":\"0931\"},{\"cityname\":\"定西市\",\"adcode\":621100,\"citycode\":\"0932\"},{\"cityname\":\"平凉市\",\"adcode\":620800,\"citycode\":\"0933\"},{\"cityname\":\"庆阳市\",\"adcode\":621000,\"citycode\":\"0934\"},{\"cityname\":\"金昌市\",\"adcode\":620300,\"citycode\":\"0935\"},{\"cityname\":\"张掖市\",\"adcode\":620700,\"citycode\":\"0936\"},{\"cityname\":\"酒泉市\",\"adcode\":620900,\"citycode\":\"0937\"},{\"cityname\":\"天水市\",\"adcode\":620500,\"citycode\":\"0938\"},{\"cityname\":\"甘南藏族自治州\",\"adcode\":623000,\"citycode\":\"0941\"},{\"cityname\":\"白银市\",\"adcode\":620400,\"citycode\":\"0943\"},{\"cityname\":\"银川市\",\"adcode\":640100,\"citycode\":\"0951\"},{\"cityname\":\"石嘴山市\",\"adcode\":640200,\"citycode\":\"0952\"},{\"cityname\":\"吴忠市\",\"adcode\":640300,\"citycode\":\"0953\"},{\"cityname\":\"固原市\",\"adcode\":640400,\"citycode\":\"0954\"},{\"cityname\":\"海北藏族自治州\",\"adcode\":632200,\"citycode\":\"0970\"},{\"cityname\":\"西宁市\",\"adcode\":630100,\"citycode\":\"0971\"},{\"cityname\":\"海东市\",\"adcode\":630200,\"citycode\":\"0972\"},{\"cityname\":\"黄南藏族自治州\",\"adcode\":632300,\"citycode\":\"0973\"},{\"cityname\":\"海南藏族自治州\",\"adcode\":632500,\"citycode\":\"0974\"},{\"cityname\":\"果洛藏族自治州\",\"adcode\":632600,\"citycode\":\"0975\"},{\"cityname\":\"玉树藏族自治州\",\"adcode\":632700,\"citycode\":\"0976\"},{\"cityname\":\"海西蒙古族藏族自治州\",\"adcode\":632800,\"citycode\":\"0977\"},{\"cityname\":\"克拉玛依市\",\"adcode\":650200,\"citycode\":\"0990\"},{\"cityname\":\"乌鲁木齐市\",\"adcode\":650100,\"citycode\":\"0991\"},{\"cityname\":\"胡杨河市\",\"adcode\":659010,\"citycode\":\"0992\"},{\"cityname\":\"石河子市\",\"adcode\":659001,\"citycode\":\"0993\"},{\"cityname\":\"昌吉回族自治州\",\"adcode\":652300,\"citycode\":\"0994\"},{\"cityname\":\"吐鲁番市\",\"adcode\":650400,\"citycode\":\"0995\"},{\"cityname\":\"巴音郭楞蒙古自治州\",\"adcode\":652800,\"citycode\":\"0996\"},{\"cityname\":\"阿克苏地区\",\"adcode\":652900,\"citycode\":\"0997\"},{\"cityname\":\"喀什地区\",\"adcode\":653100,\"citycode\":\"0998\"},{\"cityname\":\"伊犁哈萨克自治州\",\"adcode\":654000,\"citycode\":\"0999\"},{\"cityname\":\"济源市\",\"adcode\":419001,\"citycode\":\"1391\"},{\"cityname\":\"延边朝鲜族自治州\",\"adcode\":222400,\"citycode\":\"1433\"},{\"cityname\":\"阜阳市\",\"adcode\":341200,\"citycode\":\"1558\"},{\"cityname\":\"神农架林区\",\"adcode\":429021,\"citycode\":\"1719\"},{\"cityname\":\"天门市\",\"adcode\":429006,\"citycode\":\"1728\"},{\"cityname\":\"贵港市\",\"adcode\":450800,\"citycode\":\"1755\"},{\"cityname\":\"崇左市\",\"adcode\":451400,\"citycode\":\"1771\"},{\"cityname\":\"来宾市\",\"adcode\":451300,\"citycode\":\"1772\"},{\"cityname\":\"贺州市\",\"adcode\":451100,\"citycode\":\"1774\"},{\"cityname\":\"内江市\",\"adcode\":511000,\"citycode\":\"1832\"},{\"cityname\":\"眉山市\",\"adcode\":511400,\"citycode\":\"1833\"},{\"cityname\":\"香港特别行政区\",\"adcode\":810000,\"citycode\":\"1852\"},{\"cityname\":\"澳门特别行政区\",\"adcode\":820000,\"citycode\":\"1853\"},{\"cityname\":\"台湾省\",\"adcode\":710000,\"citycode\":\"1886\"},{\"cityname\":\"屯昌县\",\"adcode\":469022,\"citycode\":\"1892\"},{\"cityname\":\"文昌市\",\"adcode\":469005,\"citycode\":\"1893\"},{\"cityname\":\"琼海市\",\"adcode\":469002,\"citycode\":\"1894\"},{\"cityname\":\"临高县\",\"adcode\":469024,\"citycode\":\"1896\"},{\"cityname\":\"五指山市\",\"adcode\":469001,\"citycode\":\"1897\"},{\"cityname\":\"万宁市\",\"adcode\":469006,\"citycode\":\"1898\"},{\"cityname\":\"琼中黎族苗族自治县\",\"adcode\":469030,\"citycode\":\"1899\"},{\"cityname\":\"外国\",\"adcode\":900000,\"citycode\":\"1900\"},{\"cityname\":\"昆玉市\",\"adcode\":659009,\"citycode\":\"1903\"},{\"cityname\":\"北屯市\",\"adcode\":659005,\"citycode\":\"1906\"},{\"cityname\":\"双河市\",\"adcode\":659007,\"citycode\":\"1909\"},{\"cityname\":\"武威市\",\"adcode\":620600,\"citycode\":\"1935\"},{\"cityname\":\"嘉峪关市\",\"adcode\":620200,\"citycode\":\"1937\"},{\"cityname\":\"中卫市\",\"adcode\":640500,\"citycode\":\"1953\"},{\"cityname\":\"五家渠市\",\"adcode\":659004,\"citycode\":\"1994\"},{\"cityname\":\"铁门关市\",\"adcode\":659006,\"citycode\":\"1996\"},{\"cityname\":\"阿拉尔市\",\"adcode\":659002,\"citycode\":\"1997\"},{\"cityname\":\"图木舒克市\",\"adcode\":659003,\"citycode\":\"1998\"},{\"cityname\":\"可克达拉市\",\"adcode\":659008,\"citycode\":\"1999\"},{\"cityname\":\"潜江市\",\"adcode\":429005,\"citycode\":\"2728\"},{\"cityname\":\"乐东黎族自治县\",\"adcode\":469027,\"citycode\":\"2802\"},{\"cityname\":\"三沙市\",\"adcode\":460300,\"citycode\":\"2898\"},{\"cityname\":\"陇南市\",\"adcode\":621200,\"citycode\":\"2935\"}]"];
    </script>
    <script type="text/javascript">
// eviltransform.js - 坐标转换库
// 来源：https://github.com/googollee/eviltransform/blob/master/javascript/transform.js

function outOfChina(lat, lng) {
    if (lng < 72.004 || lng > 137.8347)
        return true;
    if (lat < 0.8293 || lat > 55.8271)
        return true;
    return false;
}
var earthR = 6378137.0;
function transform(x, y) {
    var xy = x * y;
    var absX = Math.sqrt(Math.abs(x));
    var xPi = x * Math.PI;
    var yPi = y * Math.PI;
    var d = 20.0 * Math.sin(6.0 * xPi) + 20.0 * Math.sin(2.0 * xPi);

    var lat = d;
    var lng = d;

    lat += 20.0 * Math.sin(yPi) + 40.0 * Math.sin(yPi / 3.0);
    lng += 20.0 * Math.sin(xPi) + 40.0 * Math.sin(xPi / 3.0);

    lat += 160.0 * Math.sin(yPi / 12.0) + 320 * Math.sin(yPi / 30.0);
    lng += 150.0 * Math.sin(xPi / 12.0) + 300.0 * Math.sin(xPi / 30.0);

    lat *= 2.0 / 3.0;
    lng *= 2.0 / 3.0;

    lat += -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * xy + 0.2 * absX;
    lng += 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * xy + 0.1 * absX;

    return { lat: lat, lng: lng }
}
function delta(lat, lng) {
    var ee = 0.00669342162296594323;
    var d = transform(lng - 105.0, lat - 35.0);
    var radLat = lat / 180.0 * Math.PI;
    var magic = Math.sin(radLat);
    magic = 1 - ee * magic * magic;
    var sqrtMagic = Math.sqrt(magic);
    d.lat = (d.lat * 180.0) / ((earthR * (1 - ee)) / (magic * sqrtMagic) * Math.PI);
    d.lng = (d.lng * 180.0) / (earthR / sqrtMagic * Math.cos(radLat) * Math.PI);
    return d;
}

function gcj2wgs_exact(gcjLat, gcjLng) {
    var newLat = gcjLat, newLng = gcjLng;
    var oldLat = newLat, oldLng = newLng;
    var threshold = 1e-6;

    for (var i = 0; i < 50; i++) {
        oldLat = newLat;
        oldLng = newLng;
        var d = delta(newLat, newLng);
        newLat = gcjLat - d.lat;
        newLng = gcjLng - d.lng;
        if (Math.max(Math.abs(oldLat - newLat), Math.abs(oldLng - newLng)) < threshold) {
            break;
        }
    }
    return { lat: newLat, lng: newLng };
}


    </script>
    <script type="text/javascript">
// 全局变量
var startLocation = null;
var endLocation = null;
var currentCity = '';
var startAuto = null;
var endAuto = null;
var startPlaceSearch = null;
var endPlaceSearch = null;
var cityData = []; // 存储城市编码数据
var currentCityCode = ''; // 当前选择的城市的编码

// 加载时恢复上一次的城市选择
window.addEventListener('DOMContentLoaded', function () {
    // 初始化城市数据
    initializeCityData();

    var savedCity = localStorage.getItem('selectedCity');
    if (savedCity) {
        document.getElementById('cityinput').value = savedCity;
        currentCity = savedCity;
        // 设置当前城市编码
        updateCurrentCityCode(savedCity);
    }

    // 不恢复上一次的起点和终点，保持空白

    // 设置默认出发时间为当前时间
    setDefaultDepartureTime();

    // 设置自动完成
    setupAutocomplete();

    // 设置城市输入自动完成
    setupCityAutocomplete();
});

// 设置默认出发时间
function setDefaultDepartureTime() {
    // 不设置默认时间，让用户自己选择
    // 如果用户没有输入时间，将使用当前时间进行路线规划
    document.getElementById('departuretime').value = '';
}

// 智能转换时间格式
function parseTimeInput(input) {
    input = input.trim();
    if (!input) return null;

    // 处理纯数字（如：8、15、23）
    if (/^\d+$/.test(input)) {
        var hour = parseInt(input);
        if (hour >= 0 && hour <= 23) {
            return hour + ':00';
        }
    }

    // 处理小时:分钟格式（如：8:30、14:30、8:3）
    if (/^\d{1,2}:\d{1,2}$/.test(input)) {
        var parts = input.split(':');
        var hour = parseInt(parts[0]);
        var minute = parseInt(parts[1]);

        if (hour >= 0 && hour <= 23 && minute >= 0 && minute <= 59) {
            return hour + ':' + (minute < 10 ? '0' + minute : minute);
        }
    }

    // 处理带冒号的三位数（如：8:3 转换为 8:30）
    if (/^\d{1,2}:\d$/.test(input)) {
        var parts = input.split(':');
        var hour = parseInt(parts[0]);
        var minute = parseInt(parts[1]) * 10; // 将个位数转换为整十分钟

        if (hour >= 0 && hour <= 23 && minute <= 50) {
            return hour + ':' + (minute < 10 ? '0' + minute : minute);
        }
    }

    return null; // 无效格式
}

// 获取出发时间戳（用于API调用）
function getDepartureTimestamp() {
    var timeInput = document.getElementById('departuretime').value;
    var parsedTime = parseTimeInput(timeInput);

    if (!parsedTime) {
        return null; // 使用API默认（当前时间）
    }

    var now = new Date();
    var parts = parsedTime.split(':');
    var departureDate = new Date();
    departureDate.setHours(parseInt(parts[0]), parseInt(parts[1]), 0, 0);

    // 如果设定的时间已经过去，设置为明天
    if (departureDate.getTime() < now.getTime()) {
        departureDate.setDate(departureDate.getDate() + 1);
    }

    return Math.floor(departureDate.getTime() / 1000); // 转换为秒时间戳
}

// 格式化用户输入的时间为显示格式
function formatTimeForDisplay(timestamp) {
    if (!timestamp) return '现在出发';

    var date = new Date(timestamp * 1000);
    var now = new Date();
    var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    var targetDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

    var hours = date.getHours();
    var minutes = date.getMinutes();
    var timeString = hours + ':' + (minutes < 10 ? '0' + minutes : minutes);

    if (targetDate.getTime() === today.getTime()) {
        return '今天 ' + timeString;
    } else if (targetDate.getTime() === today.getTime() + 24 * 60 * 60 * 1000) {
        return '明天 ' + timeString;
    } else {
        return date.getMonth() + 1 + '月' + date.getDate() + '日 ' + timeString;
    }
}
//格式化json返回的时间信息
function formatTime(input) {
    // Ensure the input is a string
    const timeString = input.toString();

    // Pad with leading zeros if necessary and slice the string
    const hours = timeString.slice(0, -2).padStart(2, '0');
    const minutes = timeString.slice(-2).padEnd(2, '0');

    // Return the formatted time
    return `${hours}:${minutes}`;
}
// 设置自动完成
function setupAutocomplete() {
    var city = getCurrentCity();

    // 如果PlaceSearch服务不存在，则创建新的；否则只更新城市设置
    if (!startPlaceSearch) {
        startPlaceSearch = new AMap.PlaceSearch({
            city: city,
            pageSize: 5
        });
    } else {
        startPlaceSearch.setCity(city);
    }

    if (!endPlaceSearch) {
        endPlaceSearch = new AMap.PlaceSearch({
            city: city,
            pageSize: 5
        });
    } else {
        endPlaceSearch.setCity(city);
    }

    // 设置输入提示（如果还没有设置过）
    if (!document.getElementById('startinput').hasAttribute('data-suggestion-setup')) {
        setupInputSuggestion('startinput', startPlaceSearch, function (location) {
            startLocation = location;
        });
        document.getElementById('startinput').setAttribute('data-suggestion-setup', 'true');
    }

    if (!document.getElementById('endinput').hasAttribute('data-suggestion-setup')) {
        setupInputSuggestion('endinput', endPlaceSearch, function (location) {
            endLocation = location;
        });
        document.getElementById('endinput').setAttribute('data-suggestion-setup', 'true');
    }
}

// 设置输入提示功能
function setupInputSuggestion(inputId, placeSearch, onLocationSet) {
    var inputElement = document.getElementById(inputId);
    var suggestionDiv = null;
    var currentSuggestions = [];
    var selectedIndex = -1;

    // 创建建议下拉框
    function createSuggestionDiv() {
        if (suggestionDiv) {
            suggestionDiv.remove();
        }

        suggestionDiv = document.createElement('div');
        suggestionDiv.className = 'amap-sug-result';
        suggestionDiv.style.display = 'none';
        inputElement.parentNode.appendChild(suggestionDiv);
    }

    // 显示建议
    function showSuggestions(suggestions) {
        createSuggestionDiv();
        currentSuggestions = suggestions;
        selectedIndex = -1;

        suggestionDiv.innerHTML = '';
        suggestions.forEach(function (item, index) {
            var div = document.createElement('div');
            div.className = 'auto-item';
            div.textContent = item.name + ' - ' + item.address;
            div.addEventListener('click', function () {
                inputElement.value = item.name + ' - ' + item.address;
                if (item.location) {
                    onLocationSet(item.location);

                }
                hideSuggestions();
            });
            suggestionDiv.appendChild(div);
        });

        suggestionDiv.style.display = suggestions.length > 0 ? 'block' : 'none';
    }

    // 隐藏建议
    function hideSuggestions() {
        if (suggestionDiv) {
            suggestionDiv.style.display = 'none';
        }
    }

    // 搜索建议
    function searchSuggestions(keyword) {
        if (keyword.length < 2) {
            hideSuggestions();
            return;
        }

        placeSearch.search(keyword, function (status, result) {
            if (status === 'complete' && result.poiList && result.poiList.pois.length > 0) {
                showSuggestions(result.poiList.pois);
            } else {
                hideSuggestions();
            }
        });
    }

    // 键盘事件处理
    inputElement.addEventListener('input', function (e) {
        var keyword = e.target.value.trim();
        searchSuggestions(keyword);
    });

    inputElement.addEventListener('keydown', function (e) {
        if (!currentSuggestions.length) return;

        var items = suggestionDiv.querySelectorAll('.auto-item');

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, currentSuggestions.length - 1);
            updateSelection(items);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, -1);
            updateSelection(items);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (selectedIndex >= 0) {
                items[selectedIndex].click();
            } else {
                hideSuggestions();
            }
        } else if (e.key === 'Escape') {
            hideSuggestions();
        }
    });

    // 更新选中状态
    function updateSelection(items) {
        items.forEach(function (item, index) {
            if (index === selectedIndex) {
                item.style.backgroundColor = '#3c3c3c';
            } else {
                item.style.backgroundColor = 'transparent';
            }
        });
    }

    // 点击其他地方隐藏建议
    document.addEventListener('click', function (e) {
        if (!inputElement.contains(e.target) && (!suggestionDiv || !suggestionDiv.contains(e.target))) {
            hideSuggestions();
        }
    });
}

// 点击页面其他地方关闭所有下拉菜单
document.addEventListener('click', function (e) {
    if (!e.target.closest('.autocomplete-container')) {
        ['time-dropdown', 'policy-dropdown', 'start-dropdown', 'end-dropdown'].forEach(function (id) {
            document.getElementById(id).classList.remove('show');
        });
    }
});


// 保存城市选择
function saveCity(city) {
    if (city && city.trim()) {
        localStorage.setItem('selectedCity', city.trim());
        currentCity = city.trim();
        // 更新当前城市编码
        updateCurrentCityCode(city.trim());
        // 重新设置自动完成的城市
        setupAutocomplete();

        // 如果设置弹窗是打开的，也要更新设置页面的自动完成
        var modal = document.getElementById('settings-modal');
        if (modal && modal.classList.contains('show')) {
            setupSettingsAutocomplete();
        }
    }
}

// 不再保存起点和终点到localStorage
function saveStartEnd() {
    // 空函数，不再保存起点和终点
}

// 清除输入框内容
function clearInput(inputId) {
    var input = document.getElementById(inputId);
    input.value = '';

    // 清除对应的位置变量
    if (inputId === 'startinput') {
        startLocation = null;
    } else if (inputId === 'endinput') {
        endLocation = null;
    }

    // 隐藏自动完成建议
    hideAllSuggestions();

    // 保存到本地存储
    saveStartEnd();

    // 让输入框获得焦点
    input.focus();
}

// 清除出发时间
function clearDepartureTime() {
    var timeInput = document.getElementById('departuretime');
    timeInput.value = '';
    timeInput.focus();
}

// 切换时间下拉菜单
function toggleTimeDropdown() {
    var dropdown = document.getElementById('time-dropdown');
    dropdown.classList.toggle('show');

    // 关闭其他下拉菜单
    ['start-dropdown', 'end-dropdown', 'policy-dropdown'].forEach(function (id) {
        document.getElementById(id).classList.remove('show');
    });
}

// 快速选择时间
function selectQuickTime(type) {
    var timeInput = document.getElementById('departuretime');
    var now = new Date();
    var timeString = '';

    switch (type) {
        case 'now':
            timeString = now.getHours() + ':' + (now.getMinutes() < 10 ? '0' + now.getMinutes() : now.getMinutes());
            break;
        case 'morning':
            timeString = '8:00';
            break;
        case 'noon':
            timeString = '12:00';
            break;
        case 'evening':
            timeString = '18:00';
            break;
        case 'night':
            timeString = '22:00';
            break;
    }

    timeInput.value = timeString;
    document.getElementById('time-dropdown').classList.remove('show');
    timeInput.focus();
}

// 切换路线选择依据下拉菜单
function togglePolicyDropdown() {
    var dropdown = document.getElementById('policy-dropdown');
    dropdown.classList.toggle('show');

    // 关闭其他下拉菜单
    ['time-dropdown', 'start-dropdown', 'end-dropdown'].forEach(function (id) {
        document.getElementById(id).classList.remove('show');
    });
}

// 选择路线选择依据
function selectPolicy(value, text) {
    var policyInput = document.getElementById('policy-select');
    policyInput.value = text;
    policyInput.setAttribute('data-value', value);
    document.getElementById('policy-dropdown').classList.remove('show');
}

// 获取当前选择的路线选择依据值
function getPolicyValue() {
    var policyInput = document.getElementById('policy-select');
    var value = policyInput.getAttribute('data-value');
    return value || '0'; // 默认使用推荐策略
}

// 隐藏所有建议下拉框
function hideAllSuggestions() {
    var suggestions = document.querySelectorAll('.amap-sug-result');
    suggestions.forEach(function (suggestion) {
        suggestion.style.display = 'none';
    });
}

// 打开设置弹窗
function openSettings() {
    var modal = document.getElementById('settings-modal');
    modal.classList.add('show');

    // 加载已保存的设置
    loadSettings();

    // 设置自动完成功能
    setupSettingsAutocomplete();
}

// 关闭设置弹窗
function closeSettings() {
    var modal = document.getElementById('settings-modal');
    modal.classList.remove('show');
}

// 清除设置输入框
function clearSettingInput(inputId) {
    var input = document.getElementById(inputId);
    input.value = '';
    input.focus();
}

// 加载设置
function loadSettings() {
    var homeAddress = localStorage.getItem('homeAddress');
    var companyAddress = localStorage.getItem('companyAddress');
    var favoriteAddress = localStorage.getItem('favoriteAddress');

    if (homeAddress) {
        document.getElementById('home-input').value = homeAddress;
    }
    if (companyAddress) {
        document.getElementById('company-input').value = companyAddress;
    }
    if (favoriteAddress) {
        document.getElementById('favorite-input').value = favoriteAddress;
    }
}

// 保存设置
function saveSettings() {
    var homeAddress = document.getElementById('home-input').value.trim();
    var companyAddress = document.getElementById('company-input').value.trim();
    var favoriteAddress = document.getElementById('favorite-input').value.trim();

    if (homeAddress) {
        localStorage.setItem('homeAddress', homeAddress);
    } else {
        localStorage.removeItem('homeAddress');
    }

    if (companyAddress) {
        localStorage.setItem('companyAddress', companyAddress);
    } else {
        localStorage.removeItem('companyAddress');
    }

    if (favoriteAddress) {
        localStorage.setItem('favoriteAddress', favoriteAddress);
    } else {
        localStorage.removeItem('favoriteAddress');
    }

    // 关闭弹窗
    closeSettings();
}

// 切换下拉菜单显示状态
function toggleDropdown(type) {
    var dropdownId = type + '-dropdown';
    var dropdown = document.getElementById(dropdownId);

    // 关闭所有其他下拉菜单
    ['start-dropdown', 'end-dropdown', 'time-dropdown', 'policy-dropdown'].forEach(function (id) {
        if (id !== dropdownId) {
            document.getElementById(id).classList.remove('show');
        }
    });

    // 切换当前下拉菜单
    dropdown.classList.toggle('show');

    // 如果是显示状态，加载历史记录
    if (dropdown.classList.contains('show')) {
        loadSearchHistory(type);
    }
}

// 从下拉菜单选择地址
function selectFromDropdown(type, itemType) {
    var address = '';
    var addressName = '';

    switch (itemType) {
        case 'home':
            address = localStorage.getItem('homeAddress');
            addressName = '家';
            break;
        case 'company':
            address = localStorage.getItem('companyAddress');
            addressName = '公司';
            break;
        case 'favorite':
            address = localStorage.getItem('favoriteAddress');
            addressName = '收藏';
            break;
    }

    if (address) {
        document.getElementById(type + 'input').value = address;
        // 触发地点搜索以获取坐标
        searchLocationForSetPoint(address, type);
        saveStartEnd();

        // 不添加常用地址到历史记录
        // addToSearchHistory(address, addressName);

        // 关闭下拉菜单
        document.getElementById(type + '-dropdown').classList.remove('show');
    } else {
        showMessage('请先在设置中添加' + addressName + '地址');
    }
}

// 加载搜索历史记录
function loadSearchHistory(type) {
    var historyKey = type + 'History';
    var history = JSON.parse(localStorage.getItem(historyKey) || '[]');
    var historyContainer = document.getElementById(type + '-history');

    historyContainer.innerHTML = '';

    if (history.length === 0) {
        var emptyItem = document.createElement('div');
        emptyItem.className = 'dropdown-item';
        emptyItem.textContent = '暂无历史记录';
        emptyItem.style.cursor = 'default';
        emptyItem.style.color = '#858585';
        historyContainer.appendChild(emptyItem);
    } else {
        history.forEach(function (item, index) {
            var historyItem = document.createElement('div');
            historyItem.className = 'dropdown-item';
            historyItem.textContent = item.name;
            historyItem.onclick = function () {
                selectHistoryItem(type, item);
            };
            historyContainer.appendChild(historyItem);
        });
    }
}

// 从历史记录选择
function selectHistoryItem(type, item) {
    document.getElementById(type + 'input').value = item.address;
    // 触发地点搜索以获取坐标
    searchLocationForSetPoint(item.address, type);
    saveStartEnd();

    // 更新历史记录（把选中的移到最前面）
    updateSearchHistory(item.address, item.name, type);

    // 关闭下拉菜单
    document.getElementById(type + '-dropdown').classList.remove('show');
}

// 添加到搜索历史记录
function addToSearchHistory(address, name) {
    ['start', 'end'].forEach(function (type) {
        updateSearchHistory(address, name, type);
    });
}

// 检查是否为常用地址
function isCommonAddress(address) {
    var homeAddress = localStorage.getItem('homeAddress');
    var companyAddress = localStorage.getItem('companyAddress');
    var favoriteAddress = localStorage.getItem('favoriteAddress');

    return address === homeAddress || address === companyAddress || address === favoriteAddress;
}

// 更新搜索历史记录
function updateSearchHistory(address, name, type) {
    // 不将常用地址添加到历史记录
    if (isCommonAddress(address)) {
        return;
    }

    var historyKey = type + 'History';
    var history = JSON.parse(localStorage.getItem(historyKey) || '[]');

    // 检查是否已存在相同地址
    var existingIndex = history.findIndex(function (item) {
        return item.address === address;
    });

    if (existingIndex !== -1) {
        // 移除已存在的项
        history.splice(existingIndex, 1);
    }

    // 添加到最前面
    history.unshift({
        address: address,
        name: name,
        timestamp: Date.now()
    });

    // 只保留最近5条记录
    history = history.slice(0, 5);

    // 保存到本地存储
    localStorage.setItem(historyKey, JSON.stringify(history));
}

// 点击页面其他地方关闭下拉菜单
document.addEventListener('click', function (e) {
    if (!e.target.matches('.autocomplete-dropdown') && !e.target.closest('.dropdown-menu')) {
        ['start-dropdown', 'end-dropdown', 'time-dropdown'].forEach(function (id) {
            document.getElementById(id).classList.remove('show');
        });
    }
});

// 为设置点搜索位置
function searchLocationForSetPoint(address, type, callback) {
    var city = getCurrentCity();
    var placeSearch = type === 'start' ? startPlaceSearch : endPlaceSearch;

    if (placeSearch) {
        placeSearch.setCity(city);
        placeSearch.search(address, function (status, result) {
            if (status === 'complete' && result.poiList && result.poiList.pois.length > 0) {
                var poi = result.poiList.pois[0];
                if (poi.location) {
                    if (type === 'start') {
                        startLocation = poi.location;
                    } else {
                        endLocation = poi.location;
                    }
                    // 如果有回调函数，执行回调
                    if (callback) {
                        callback();
                    }
                } else {
                    showMessage('未找到该地址的位置信息');
                }
            } else {
                showMessage('搜索地址失败，请检查地址是否正确');
            }
        });
    }
}

// 显示消息
function showMessage(message) {
    // 创建临时消息提示
    var messageDiv = document.createElement('div');
    messageDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: #2d1b1b;
                color: #f48771;
                padding: 15px 20px;
                border-radius: 4px;
                border: 1px solid #8c2d2d;
                z-index: 3000;
                font-size: 14px;
                font-family: Arial, sans-serif, 'Courier New', monospace;
            `;
    messageDiv.textContent = message;
    document.body.appendChild(messageDiv);

    // 3秒后移除
    setTimeout(function () {
        if (messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
        }
    }, 3000);
}

// 设置弹窗的自动完成功能
function setupSettingsAutocomplete() {
    var city = getCurrentCity();

    // 创建地点搜索服务
    if (!window.settingsPlaceSearch) {
        window.settingsPlaceSearch = new AMap.PlaceSearch({
            city: city,
            pageSize: 5
        });
    }

    // 为每个设置输入框设置自动完成
    setupInputSuggestion('home-input', window.settingsPlaceSearch, function (location) {
        // 设置页面不需要保存坐标，只需要保存地址文本
    });

    setupInputSuggestion('company-input', window.settingsPlaceSearch, function (location) {
        // 设置页面不需要保存坐标，只需要保存地址文本
    });

    setupInputSuggestion('favorite-input', window.settingsPlaceSearch, function (location) {
        // 设置页面不需要保存坐标，只需要保存地址文本
    });
}

// 点击弹窗背景关闭
document.getElementById('settings-modal').addEventListener('click', function (e) {
    if (e.target === this) {
        closeSettings();
    }
});

// 交换起点和终点
function swapStartEnd() {
    var startInput = document.getElementById('startinput');
    var endInput = document.getElementById('endinput');
    var startValue = startInput.value;
    var endValue = endInput.value;

    // 交换值
    startInput.value = endValue;
    endInput.value = startValue;

    // 交换位置变量
    var tempLocation = startLocation;
    startLocation = endLocation;
    endLocation = tempLocation;

    // 保存到本地存储
    saveStartEnd();

    // 重新获取位置信息
    if (startValue) {
        searchLocationForSetPoint(startValue, 'end');
    }
    if (endValue) {
        searchLocationForSetPoint(endValue, 'start');
    }
}

// 定位到终点
function locateTarget() {
    var endInput = document.getElementById('endinput');

    // 检查终点输入框是否有内容
    if (!endInput.value.trim()) {
        showMessage('请先输入终点地址');
        return;
    }

    // 检查是否有终点位置信息
    if (!endLocation) {
        showMessage('正在获取终点位置信息，请稍候...');
        // 重新搜索终点位置，搜索完成后自动跳转
        searchLocationForSetPoint(endInput.value.trim(), 'end', function () {
            if (endLocation) {
                // 转换GCJ坐标到WGS坐标
                var wgsCoords = gcj2wgs_exact(endLocation.lat, endLocation.lng);

                // 生成om跳转链接
                var omLink = 'om://map?ll=' + wgsCoords.lat.toFixed(7) + ',' + wgsCoords.lng.toFixed(7);

                // 跳转到om地图
                window.location.href = omLink;
            }
        });
        return;
    }

    // 转换GCJ坐标到WGS坐标
    var wgsCoords = gcj2wgs_exact(endLocation.lat, endLocation.lng);

    // 生成om跳转链接
    var omLink = 'om://map?ll=' + wgsCoords.lat.toFixed(7) + ',' + wgsCoords.lng.toFixed(7);

    // 跳转到om地图
    window.location.href = omLink;
}

// 获取当前城市
function getCurrentCity() {
    return document.getElementById('cityinput').value.trim() || '全国';
}

// 初始化城市数据
function initializeCityData() {
    try {
        // citycode.json是一个包含JSON字符串的数组，需要先解析字符串，再解析数组
        var cityCodeString = citycode[0]; // 获取字符串
        cityData = JSON.parse(cityCodeString); // 解析字符串为数组
    } catch (error) {
        console.error('城市数据加载失败:', error);
        cityData = [];
    }
}

// 城市模糊匹配
function fuzzyMatchCity(input) {
    if (!input || input.trim() === '') {
        return null;
    }

    var inputStr = input.trim().toLowerCase();
    var bestMatch = null;
    var bestScore = 0;

    for (var i = 0; i < cityData.length; i++) {
        var city = cityData[i];
        var cityName = city.cityname;

        // 完全匹配（最高优先级）
        if (cityName === inputStr) {
            return city;
        }

        // 包含匹配
        if (cityName.indexOf(inputStr) !== -1) {
            var score = cityName.length - inputStr.length;
            if (score > bestScore) {
                bestScore = score;
                bestMatch = city;
            }
        }
    }

    return bestMatch;
}

// 更新当前城市编码
function updateCurrentCityCode(cityName) {
    var matchedCity = fuzzyMatchCity(cityName);
    if (matchedCity) {
        currentCityCode = matchedCity.citycode;
    } else {
        currentCityCode = '';
    }
}

// 获取当前城市编码
function getCurrentCityCode() {
    return currentCityCode;
}

// 设置城市输入自动完成
function setupCityAutocomplete() {
    var cityInput = document.getElementById('cityinput');
    var cityWrapper = cityInput.parentNode;
    var suggestionDiv = null;
    var currentSuggestions = [];
    var selectedIndex = -1;

    // 创建城市建议下拉框
    function createCitySuggestionDiv() {
        if (suggestionDiv) {
            suggestionDiv.remove();
        }

        suggestionDiv = document.createElement('div');
        suggestionDiv.className = 'amap-sug-result';
        suggestionDiv.style.display = 'none';
        suggestionDiv.style.position = 'absolute';
        suggestionDiv.style.top = '100%';
        suggestionDiv.style.left = '0';
        suggestionDiv.style.right = '0';
        suggestionDiv.style.zIndex = '1000';
        cityWrapper.appendChild(suggestionDiv);
    }

    // 显示城市建议
    function showCitySuggestions(suggestions) {
        createCitySuggestionDiv();
        currentSuggestions = suggestions;
        selectedIndex = -1;

        suggestionDiv.innerHTML = '';
        suggestions.forEach(function (item, index) {
            var div = document.createElement('div');
            div.className = 'auto-item';
            div.textContent = item.cityname;
            div.addEventListener('click', function () {
                cityInput.value = item.cityname;
                currentCity = item.cityname;
                currentCityCode = item.citycode;
                saveCity(item.cityname);
                hideCitySuggestions();
            });
            suggestionDiv.appendChild(div);
        });

        suggestionDiv.style.display = suggestions.length > 0 ? 'block' : 'none';
    }

    // 隐藏城市建议
    function hideCitySuggestions() {
        if (suggestionDiv) {
            suggestionDiv.style.display = 'none';
        }
    }

    // 搜索城市建议
    function searchCitySuggestions(keyword) {
        if (keyword.length < 1) {
            hideCitySuggestions();
            return;
        }

        var suggestions = [];
        var inputStr = keyword.toLowerCase();

        // 模糊匹配城市
        for (var i = 0; i < cityData.length; i++) {
            var city = cityData[i];
            var cityName = city.cityname;

            // 完全匹配或包含匹配
            if (cityName.indexOf(keyword) !== -1) {
                suggestions.push(city);
            }

            // 限制建议数量
            if (suggestions.length >= 5) {
                break;
            }
        }

        showCitySuggestions(suggestions);
    }

    // 键盘事件处理
    cityInput.addEventListener('input', function (e) {
        var keyword = e.target.value.trim();
        searchCitySuggestions(keyword);
    });

    cityInput.addEventListener('keydown', function (e) {
        if (!currentSuggestions.length) return;

        var items = suggestionDiv.querySelectorAll('.auto-item');

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, currentSuggestions.length - 1);
            updateCitySelection(items);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, -1);
            updateCitySelection(items);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (selectedIndex >= 0) {
                items[selectedIndex].click();
            } else {
                hideCitySuggestions();
            }
        } else if (e.key === 'Escape') {
            hideCitySuggestions();
        }
    });

    // 更新选中状态
    function updateCitySelection(items) {
        items.forEach(function (item, index) {
            if (index === selectedIndex) {
                item.style.backgroundColor = '#3c3c3c';
            } else {
                item.style.backgroundColor = 'transparent';
            }
        });
    }

    // 点击其他地方隐藏建议
    document.addEventListener('click', function (e) {
        if (!cityInput.contains(e.target) && (!suggestionDiv || !suggestionDiv.contains(e.target))) {
            hideCitySuggestions();
        }
    });
}

// 城市输入框失去焦点时保存
document.getElementById('cityinput').addEventListener('blur', function () {
    saveCity(this.value);
});

// 城市输入框内容变化时更新自动完成城市
document.getElementById('cityinput').addEventListener('input', function () {
    var city = this.value.trim() || '全国';
    currentCity = city;
    // 更新城市编码
    updateCurrentCityCode(city);

    // 立即更新现有地点搜索服务的城市设置
    if (startPlaceSearch) {
        startPlaceSearch.setCity(city);
    }
    if (endPlaceSearch) {
        endPlaceSearch.setCity(city);
    }
    if (window.settingsPlaceSearch) {
        window.settingsPlaceSearch.setCity(city);
    }
});

// 起点和终点输入框失去焦点时保存
document.getElementById('startinput').addEventListener('blur', function () {
    saveStartEnd();
});

document.getElementById('endinput').addEventListener('blur', function () {
    saveStartEnd();
});

// 地点搜索服务
function searchLocation(keyword, city, isStart, callback) {
    var placeSearch = isStart ? startPlaceSearch : endPlaceSearch;
    placeSearch.setCity(city);
    placeSearch.search(keyword, function (status, result) {
        if (status === 'complete' && result.poiList && result.poiList.pois.length > 0) {
            var poi = result.poiList.pois[0];
            if (poi.location) {
                callback(poi.location);
            } else {
                callback(null);
            }
        } else {
            callback(null);
        }
    });
}

// 获取策略值 - Web API版本
function getPolicyValue() {
    var policyInput = document.getElementById('policy-select');
    var policyValue = policyInput.getAttribute('data-value');
    return policyValue || '0'; // 默认推荐模式
}

// 格式化时间
function formatDuration(seconds) {
    var hours = Math.floor(seconds / 3600);
    var minutes = Math.floor((seconds % 3600) / 60);

    if (hours > 0) {
        return hours + '小时' + minutes + '分';
    } else {
        return minutes + '分钟';
    }
}

// 格式化距离
function formatDistance(meters) {
    if (meters >= 1000) {
        return (meters / 1000).toFixed(1) + '公里';
    } else {
        return Math.round(meters) + '米';
    }
}

// 获取步骤图标
function getStepIcon(instruction) {
    if (instruction.indexOf('步行') >= 0 || instruction.indexOf('走路') >= 0) {
        return 'walk';
    } else if (instruction.indexOf('地铁') >= 0 || instruction.indexOf('MTR') >= 0) {
        return 'metro';
    } else {
        return 'bus';
    }
}

// 获取交通方式摘要
function getTransportSummary(segments) {
    var transportTypes = [];
    var hasWalking = false;

    segments.forEach(function (segment) {
        if (segment.transit_mode === 'WALK') {
            hasWalking = true;
        } else if (segment.transit_mode === 'SUBWAY') {
            if (!transportTypes.includes('地铁')) {
                transportTypes.push('地铁');
            }
        } else if (segment.transit_mode === 'BUS') {
            if (!transportTypes.includes('公交')) {
                transportTypes.push('公交');
            }
        }
    });

    if (hasWalking && transportTypes.length > 0) {
        transportTypes.push('步行');
    } else if (hasWalking) {
        transportTypes = ['步行'];
    }

    return transportTypes;
}

// 计算步行总距离
function getWalkingDistance(segments) {
    var walkingDistance = 0;
    segments.forEach(function (segment) {
        if (segment.transit_mode === 'WALK' && segment.distance) {
            walkingDistance += segment.distance;
        }
    });
    return walkingDistance;
}

// 获取高德API返回的实际费用
function getActualCost(route) {
    // 高德API返回的数据中，费用信息通常在route对象的某个属性中
    // 根据高德地图文档，费用信息通常在route.cost属性中
    if (route.cost !== undefined && route.cost !== null) {
        return route.cost;
    }

    // 如果route.cost不存在，尝试从segments中查找费用信息
    var totalCost = 0;
    if (route.segments && route.segments.length > 0) {
        route.segments.forEach(function (segment) {
            if (segment.cost !== undefined && segment.cost !== null) {
                totalCost += segment.cost;
            }
        });
        return totalCost > 0 ? totalCost : null;
    }

    // 如果都没有找到费用信息，返回null
    return null;
}

// 检查是否为站内换乘（步行前后都是地铁，且前一个地铁没有出站口）
function checkStationTransfer(allSegments, currentIndex) {
    // 如果是第一个或最后一个步行路段，不可能是站内换乘
    if (currentIndex === 0 || currentIndex === allSegments.length - 1) {
        return false;
    }

    var prevSegment = allSegments[currentIndex - 1];
    var nextSegment = allSegments[currentIndex + 1];

    // 严格检查前一个路段是否为地铁（只根据transit_mode判断）
    var prevIsSubway = prevSegment && prevSegment.transit_mode === 'SUBWAY';

    // 严格检查后一个路段是否为地铁（只根据transit_mode判断）
    var nextIsSubway = nextSegment && nextSegment.transit_mode === 'SUBWAY';

    // 检查前一个地铁路段是否有出站口信息（只根据transit.exit属性判断）
    var prevHasExit = false;
    if (prevIsSubway && prevSegment && prevSegment.transit && prevSegment.transit.exit && prevSegment.transit.exit.name) {
        prevHasExit = true;
    }

    // 只有当前后都是地铁且前一个地铁没有出站口时，才是站内换乘
    return prevIsSubway && nextIsSubway && !prevHasExit;
}

// 格式化公交路段的显示内容
function formatBusInstruction(segment) {
    try {
        var busInfo = {
            line: '',          // 公交线路
            direction: '',     // 方向
            stations: '',      // 乘坐站数
            exit: '',          // 出站口
            tips: '',
            startTime: '',
            endTime: ''
        };

        // 获取站点数据的来源
        var linesSource = null;
        
        // 优先从transit.lines获取
        if (segment.transit && segment.transit.lines && segment.transit.lines.length > 0) {
            linesSource = segment.transit.lines;
        }
        // 其次从bus.buslines获取
        else if (segment.bus && segment.bus.buslines && segment.bus.buslines.length > 0) {
            linesSource = segment.bus.buslines;
        }
        // 再其次从buslines获取
        else if (segment.buslines && segment.buslines.length > 0) {
            linesSource = segment.buslines;
        }

        // 从linesSource获取所有线路名称
        if (linesSource) {
            var lineNames = [];
            for (var i = 0; i < linesSource.length; i++) {
                var line = linesSource[i];
                if (line.name) {
                    var lineName = line.name;
                    // 去掉每个线路名称中括号内的内容
                    lineName = lineName.replace(/\([^)]*\)/g, '');
                    lineNames.push(lineName);
                }
            }
            if (lineNames.length > 0) {
                busInfo.line = lineNames.join('/');
            }
        }

        var departureStop = null;
        var arrivalStop = null;

        // 从linesSource的第一条线路获取站点信息
        if (linesSource && linesSource.length > 0) {
            var firstLine = linesSource[0];
            if (!departureStop && firstLine.departure_stop) {
                departureStop = firstLine.departure_stop;
            }
            if (!arrivalStop && firstLine.arrival_stop) {
                arrivalStop = firstLine.arrival_stop;
            }
            
        }

        // 传统数据源获取站点信息
        if (!departureStop || !arrivalStop) {
            if (segment.bus && segment.bus.buslines && segment.bus.buslines[0]) {
                if (!departureStop) departureStop = segment.bus.buslines[0].departure_stop;
                if (!arrivalStop) arrivalStop = segment.bus.buslines[0].arrival_stop;
            } else if (segment.railway && segment.railway.lines && segment.railway.lines[0]) {
                if (!departureStop) departureStop = segment.railway.lines[0].departure_stop;
                if (!arrivalStop) arrivalStop = segment.railway.lines[0].arrival_stop;
            }
        }
        if (firstLine.via_num != '0') {
            busInfo.direction = firstLine.via_stops[0].name;
        } else if (arrivalStop && arrivalStop.name) {
            busInfo.direction = arrivalStop.name;
        }

        if (linesSource[0].bus_time_tips && linesSource[0].bus_time_tips !== '') {
            busInfo.tips = linesSource[0].bus_time_tips
        }
        if (linesSource[0].start_time && linesSource[0].start_time !== '') {
            busInfo.startTime = formatTime(linesSource[0].start_time)
        }
        if (linesSource[0].end_time && linesSource[0].end_time !== '') {
            busInfo.endTime = formatTime(linesSource[0].end_time)
        }

        var result = '';
        var stationInfoHtml = '';

        // 构建站点信息行
        if (departureStop && departureStop.name) {
            var stationInfo = '上车站：' + departureStop.name;
            if (busInfo.direction) {
                stationInfo += '&nbsp;&nbsp;&nbsp;&nbsp;下一站: ' + busInfo.direction;
            }
            stationInfoHtml = '<div class="subway-stop-item final-destination" style="border-left-color: #dcdcaa;font-size: 12px;margin-top: 5px">' + stationInfo + '</div>';
        }

        // 组合最终结果
        if (busInfo.line) {
            result = "<div>"+busInfo.line + '</div>';;
        }
        if (busInfo.startTime && busInfo.endTime) {
            result += '<div style="font-size: 12px;color: #8C8C8C">运营时间：' + busInfo.startTime+' - '+ busInfo.endTime+'</div>';
        }
        if (busInfo.tips) {
            result += '<div style="font-size: 12px;color: #8C8C8C">' + busInfo.tips + '</div>';
        }
        if (stationInfoHtml) {
            result = result ? (result +  stationInfoHtml) : stationInfoHtml;
        }

        return result || segment.instruction || ''; // 如果格式化失败，返回原始指令

    } catch (error) {
        console.error('formatBusInstruction error:', error);
        return segment.instruction || ''; // 出错时返回原始指令
    }
}

// 格式化地铁路段的显示内容
function formatSubwayInstruction(segment) {
    try {
        var subwayInfo = {
            line: '',          // 地铁线路
            direction: '',     // 方向
            stations: '',      // 乘坐站数
            exit: '',          // 出站口
            tips: '',
            startTime: '',
            endTime: ''
        };

        // 获取站点数据的来源
        var linesSource = null;
        
        if (segment.transit && segment.transit.buslines && segment.transit.buslines.length > 0) {
            linesSource = segment.transit.buslines;
        }
        // 其次从bus.buslines获取
        else if (segment.bus && segment.bus.buslines && segment.bus.buslines.length > 0) {
            linesSource = segment.bus.buslines;
        }
        // 再其次从buslines获取
        else if (segment.buslines && segment.buslines.length > 0) {
            linesSource = segment.buslines;
        }

        // 从linesSource获取所有线路名称
        if (linesSource) {
            var lineNames = [];
            for (var i = 0; i < linesSource.length; i++) {
                var line = linesSource[i];
                if (line.name) {
                    var lineName = line.name;
                    // 去掉每个线路名称中括号内的内容
                    lineName = lineName.replace(/\([^)]*\)/g, '');
                    lineNames.push(lineName);
                }
            }
            if (lineNames.length > 0) {
                subwayInfo.line = lineNames.join('/');
            }
        }

        var departureStop = null;
        var arrivalStop = null;

        // 从linesSource的第一条线路获取站点信息
        if (linesSource && linesSource.length > 0) {
            var firstLine = linesSource[0];
            if (!departureStop && firstLine.departure_stop) {
                departureStop = firstLine.departure_stop;
            }
            if (!arrivalStop && firstLine.arrival_stop) {
                arrivalStop = firstLine.arrival_stop;
            }
        }

        // 传统数据源获取站点信息
        if (!departureStop || !arrivalStop) {
            if (segment.bus && segment.bus.buslines && segment.bus.buslines[0]) {
                if (!departureStop) departureStop = segment.bus.buslines[0].departure_stop;
                if (!arrivalStop) arrivalStop = segment.bus.buslines[0].arrival_stop;
            } else if (segment.bus && segment.bus.buslines && segment.bus.buslines[0]) {
                if (!departureStop) departureStop = segment.bus.buslines[0].departure_stop;
                if (!arrivalStop) arrivalStop = segment.bus.buslines[0].arrival_stop;
            }
        }
        if (firstLine.via_num != '0') {
            subwayInfo.direction = firstLine.via_stops[0].name;
        } else if (arrivalStop && arrivalStop.name) {
            subwayInfo.direction = arrivalStop.name;
        }

        
        if (linesSource[0].bus_time_tips && linesSource[0].bus_time_tips !== '') {
            subwayInfo.tips = linesSource[0].bus_time_tips
        }
        if (linesSource[0].start_time && linesSource[0].start_time !== '') {
            subwayInfo.startTime = formatTime(linesSource[0].start_time)
        } else if (linesSource[0].station_start_time && linesSource[0].station_start_time !== '') {
            subwayInfo.startTime = formatTime(linesSource[0].station_start_time)
        }
        if (linesSource[0].end_time && linesSource[0].end_time !== '') {
            subwayInfo.endTime = formatTime(linesSource[0].end_time)
        } else if (linesSource[0].station_end_time && linesSource[0].station_end_time !== '') {
            subwayInfo.endTime = formatTime(linesSource[0].station_end_time)
        }
        
        var result = '';
        var stationInfoHtml = '';

        // 构建站点信息行
        if (departureStop && departureStop.name) {
            var stationInfo = '上车站：' + departureStop.name;
            if (subwayInfo.direction) {
                stationInfo += '&nbsp;&nbsp;&nbsp;&nbsp;下一站: ' + subwayInfo.direction;
            }
            stationInfoHtml = '<div class="subway-stop-item final-destination" style="border-left-color: #dcdcaa;font-size: 12px;margin-top: 5px">' + stationInfo + '</div>';
        }

        // 组合最终结果
        if (subwayInfo.line) {
            result = "<div>"+subwayInfo.line + '</div>';;
        }
        if (subwayInfo.startTime && subwayInfo.endTime) {
            result += '<div style="font-size: 12px;color: #8C8C8C">运营时间：' + subwayInfo.startTime+' - '+ subwayInfo.endTime+'</div>';
        }
        if (subwayInfo.tips) {
            result += '<div style="font-size: 12px;color: #8C8C8C">' + subwayInfo.tips + '</div>';
        }
        if (stationInfoHtml) {
            result = result ? (result +  stationInfoHtml) : stationInfoHtml;
        }

        return result || segment.instruction || ''; // 如果格式化失败，返回原始指令

    } catch (error) {
        console.error('formatSubwayInstruction error:', error);
        return segment.instruction || ''; // 出错时返回原始指令
    }
}

// 生成步行OM链接
function generateWalkOMLink(segment) {
    // 检查是否是步行路段
    if (!segment.instruction || segment.instruction !== '步行') {
        return '';
    }

    // 从不同可能的属性获取坐标
    var startLocation = null;
    var endLocation = null;

    // 从origin获取起点坐标
    if (segment.walking && segment.walking.origin) {
        var [lng, lat] = segment.walking.origin.split(',');
        var startLocation = {
            lng: parseFloat(lng), 
            lat: parseFloat(lat)  
        };

    }
    // 从destination获取终点坐标
    if (segment.walking && segment.walking.destination) {
        var [lng1, lat1] = segment.walking.destination.split(',');
        var endLocation = {
            lng: parseFloat(lng1), 
            lat: parseFloat(lat1)  
        };
    }

    if (!startLocation || !endLocation) {

        return '';
    }



    var startGcjLat = startLocation.lat;
    var startGcjLng = startLocation.lng;
    var endGcjLat = endLocation.lat;
    var endGcjLng = endLocation.lng;



    // 检查坐标是否为有效数字
    if (isNaN(startGcjLat) || isNaN(startGcjLng) || isNaN(endGcjLat) || isNaN(endGcjLng)) {

        return '';
    }

    try {
        // 转换为WGS-84坐标
        var startWgs = gcj2wgs_exact(startGcjLat, startGcjLng);
        var endWgs = gcj2wgs_exact(endGcjLat, endGcjLng);



        // 检查转换后的坐标是否有效
        if (isNaN(startWgs.lat) || isNaN(startWgs.lng) || isNaN(endWgs.lat) || isNaN(endWgs.lng)) {

            return '';
        }

        // 构建起点和终点地址
        var saddr = '步行起点';
        var daddr = '步行终点';

        // 从instruction中提取地点信息
        var instruction = segment.instruction || '';
        if (instruction) {
            // 尝试从指令中提取地点名称
            var matches = instruction.match(/到达(.+)/);
            if (matches && matches[1]) {
                daddr = matches[1].trim();
            }
        }

        // 编码地址
        saddr = encodeURIComponent(saddr);
        daddr = encodeURIComponent(daddr);

        // 生成OM链接
        var omLink = 'om://route?sll=' + startWgs.lat.toFixed(7) + ',' + startWgs.lng.toFixed(7) +
            '&saddr=' + saddr + '&dll=' + endWgs.lat.toFixed(7) + ',' + endWgs.lng.toFixed(7) +
            '&daddr=' + daddr + '&type=pedestrian';


        return '<a href="' + omLink + '" class="om-walk-link" title="在OM中打开步行导航">导航</a>';

    } catch (error) {
        console.error('generateWalkOMLink error:');
        return '';
    }
}

// 渲染公交站点列表
function renderBusStops(segment, segmentIndex, stepIndex) {

    var uniqueId = 'bus-stops-' + segmentIndex + '-' + stepIndex;
    var stops = null;

    // 统一直接从原始bus数据获取
    if (segment.bus && segment.bus.buslines && segment.bus.buslines[0] && segment.bus.buslines[0].via_stops) {
        stops = segment.bus.buslines[0].via_stops;
    }
    // 其他备用数据源
    else if (segment.bus && segment.bus.via_stops) {
        stops = segment.bus.via_stops;
    } else if (segment.via_stops) {
        stops = segment.via_stops;
    } else if (segment.railway && segment.railway.via_stops) {
        stops = segment.railway.via_stops;
    } else if (segment.transit && segment.transit.buslines && segment.transit.lines[0] && segment.transit.lines[0].via_stops) {
        stops = segment.transit.buslines[0].via_stops;
    }
    var stopsHtml = '';

    // 安全检查：确保stops存在且是数组
    if (!stops || !Array.isArray(stops)) {
        stops = [];
    }

    // 获取上车站和下车站信息 - 统一使用transit数据
    var departureStop = null;
    var arrivalStop = null;

    // 备用数据源
    if (!departureStop || !arrivalStop) {
        if (segment.bus && segment.bus.buslines && segment.bus.buslines[0]) {
            if (!departureStop) departureStop = segment.bus.buslines[0].departure_stop;
            if (!arrivalStop) arrivalStop = segment.bus.buslines[0].arrival_stop;
        } else if (segment.railway && segment.railway.lines && segment.railway.lines[0]) {
            if (!departureStop) departureStop = segment.railway.lines[0].departure_stop;
            if (!arrivalStop) arrivalStop = segment.railway.lines[0].arrival_stop;
        }
    }

    // 添加departure_stop作为第一站（上车站）
    if (departureStop && departureStop.name) {
        var onStationName = departureStop.name;
        stopsHtml += `<div class="subway-stop-item" style="border-left-color: #dcdcaa; font-weight: bold;">${onStationName}</div>`;
    }

    // 生成站点列表
    stops.forEach(function (stop, index) {
        if (stop && stop.name) {
            var stopInfo = stop.name;            
            stopsHtml += `<div class="subway-stop-item">${stopInfo}</div>`;
        }
    });

    // 添加arrival_stop作为最后一站
    if (arrivalStop && arrivalStop.name) {
        var offStationName = arrivalStop.name;
        stopsHtml += `<div class="subway-stop-item"  style="border-left-color: #dcdcaa; font-weight: bold;">${offStationName}</div>`;
    }

    // 计算实际乘坐的站点数（从出发站到到达站）
    var totalRidingStops = stops.length; // via_stops中的站点数
    if (departureStop && departureStop.name && arrivalStop && arrivalStop.name) {
        // 如果有明确的起止站，乘坐站数 = via_stops站点数 + 1
        totalRidingStops = stops.length + 1;
    } else if (departureStop && departureStop.name && !arrivalStop) {
        // 只有出发站
        totalRidingStops = stops.length;
    } else if (!departureStop && arrivalStop && arrivalStop.name) {
        // 只有到达站
        totalRidingStops = stops.length + 1;
    }
    var viaStopsCount = Math.max(0, totalRidingStops);

    // 构建下车站信息（类似地铁的处理方式）
    var stationInfoHtml = '';
    if (arrivalStop && arrivalStop.name) {
        var offStationName = arrivalStop.name;
        stationInfoHtml += `<div class="subway-stop-item final-destination" style="border-left-color: #dcdcaa;font-size: 12px;">下车站： ${offStationName}</div>`;
    }

    return `
                <div class="subway-stops">
                    <div class="subway-stops-header" onclick="toggleBusStops('${uniqueId}')">
                        ▶ 乘坐 ${viaStopsCount} 站
                    </div>
                    <div id="${uniqueId}" class="subway-stops-list">
                        ${stopsHtml}
                    </div>
                </div>
                ${stationInfoHtml}
            `;
}

// 渲染地铁站点列表
function renderSubwayStops(segment, segmentIndex, stepIndex) {

    var uniqueId = 'subway-stops-' + segmentIndex + '-' + stepIndex;
    var stops = null;

    // 统一直接从原始bus数据获取
    if (segment.bus && segment.bus.buslines && segment.bus.buslines[0] && segment.bus.buslines[0].via_stops) {
        stops = segment.bus.buslines[0].via_stops;
    }
    // 其他备用数据源
    else if (segment.bus && segment.bus.via_stops) {
        stops = segment.bus.via_stops;
    } else if (segment.via_stops) {
        stops = segment.via_stops;
    } else if (segment.railway && segment.railway.via_stops) {
        stops = segment.railway.via_stops;
    } else if (segment.transit && segment.transit.lines && segment.transit.lines[0] && segment.transit.lines[0].via_stops) {
        stops = segment.transit.lines[0].via_stops;
    }
    var stopsHtml = '';

    // 安全检查：确保stops存在且是数组
    if (!stops || !Array.isArray(stops)) {
        stops = [];
    }

    // 获取上车站和下车站信息
    var departureStop = null;
    var arrivalStop = null;

    // 备用数据源
    if (!departureStop || !arrivalStop) {
        if (segment.bus && segment.bus.buslines && segment.bus.buslines[0]) {
            if (!departureStop) departureStop = segment.bus.buslines[0].departure_stop;
            if (!arrivalStop) arrivalStop = segment.bus.buslines[0].arrival_stop;
        } else if (segment.railway && segment.railway.lines && segment.railway.lines[0]) {
            if (!departureStop) departureStop = segment.railway.lines[0].departure_stop;
            if (!arrivalStop) arrivalStop = segment.railway.lines[0].arrival_stop;
        }
    }

    // 添加departure_stop作为第一站（上车站）
    if (departureStop && departureStop.name) {
        var onStationName = departureStop.name;
        stopsHtml += `<div class="subway-stop-item"  style="border-left-color: #dcdcaa; font-weight: bold;">${onStationName}</div>`;
    }
    
    
    // 生成站点列表
    stops.forEach(function (stop, index) {
        if (stop && stop.name) {
            var stopInfo = stop.name;
            stopsHtml += `<div class="subway-stop-item">${stopInfo}</div>`;
        }
    });

    // 添加arrival_stop作为最后一站
    if (arrivalStop && arrivalStop.name) {
        var offStationName = arrivalStop.name;
        stopsHtml += `<div class="subway-stop-item"  style="border-left-color: #dcdcaa; font-weight: bold;">${offStationName}</div>`;
    }
    // 计算实际乘坐的站点数（从出发站到到达站）
    var totalRidingStops = stops.length; // via_stops中的站点数
    if (departureStop && departureStop.name && arrivalStop && arrivalStop.name) {
        // 如果有明确的起止站，乘坐站数 = via_stops站点数 + 1
        totalRidingStops = stops.length + 1;
    } else if (departureStop && departureStop.name && !arrivalStop) {
        totalRidingStops = stops.length;
    } else if (!departureStop && arrivalStop && arrivalStop.name) {
        totalRidingStops = stops.length + 1;
    }
    var viaStopsCount = Math.max(0, totalRidingStops);

    // 构建下车站和出站口信息
    var stationInfoHtml = '';
    if (arrivalStop && arrivalStop.name) {
        var offStationName = arrivalStop.name;

        // 添加出站口信息
        var exitInfo = '';
        if (segment.bus && segment.bus.buslines && segment.bus.buslines[0] && segment.bus.buslines[0].arrival_stop && segment.bus.buslines[0].arrival_stop.exit && segment.bus.buslines[0].arrival_stop.exit.name ) {
            exitInfo = segment.bus.buslines[0].arrival_stop.exit.name;
        } else {
            // 尝试从指令中提取出站口信息
            var instruction = segment.instruction || '';
            var exitMatch = instruction.match(/([A-Z0-9]+号?出站口|[A-Z0-9]+出站口|出站口[A-Z0-9]+)/i);
            if (exitMatch) {
                exitInfo = exitMatch[1];
            }
        }
        if (exitInfo != "") {
            stationInfoHtml += `<div class="subway-stop-item final-destination" style="border-left-color: #dcdcaa;font-size: 12px;">下车站： ${offStationName}&nbsp;&nbsp;&nbsp;&nbsp;出站口: ${exitInfo}</div>`;
        } else {
            stationInfoHtml += `<div class="subway-stop-item final-destination" style="border-left-color: #dcdcaa;font-size: 12px;">下车站： ${offStationName}</div>`;
        }
    }

    return `
                <div class="subway-stops">
                    <div class="subway-stops-header" onclick="toggleSubwayStops('${uniqueId}')">
                        ▶ 乘坐 ${viaStopsCount} 站
                    </div>
                    <div id="${uniqueId}" class="subway-stops-list">
                        ${stopsHtml}
                    </div></div>
                    ${stationInfoHtml}
                
            `;
}

// 切换公交站点列表显示
function toggleBusStops(uniqueId) {
    var stopsList = document.getElementById(uniqueId);

    // 检查元素是否存在
    if (!stopsList) {
        console.warn('公交站点列表元素未找到: ' + uniqueId);
        return;
    }

    var header = stopsList.previousElementSibling;

    // 检查header是否存在
    if (!header) {
        console.warn('公交站点列表头部元素未找到');
        return;
    }

    var isExpanded = stopsList.classList.contains('expanded');
    var stopsCount = Math.max(0, stopsList.children.length - 1); // 减去起始站，显示途径站数

    if (isExpanded) {
        stopsList.classList.remove('expanded');
        header.innerHTML = '▶ 乘坐 ' + stopsCount + ' 站';
    } else {
        stopsList.classList.add('expanded');
        header.innerHTML = '▼ 乘坐 ' + stopsCount + ' 站';
    }
}

// 切换地铁站点列表显示
function toggleSubwayStops(uniqueId) {
    var stopsList = document.getElementById(uniqueId);

    // 检查元素是否存在
    if (!stopsList) {
        console.warn('地铁站点列表元素未找到: ' + uniqueId);
        return;
    }

    var header = stopsList.previousElementSibling;

    // 检查header是否存在
    if (!header) {
        console.warn('地铁站点列表头部元素未找到');
        return;
    }

    var isExpanded = stopsList.classList.contains('expanded');
    var stopsCount = Math.max(0, stopsList.children.length - 1); // 减去起始站，显示途径站数

    if (isExpanded) {
        stopsList.classList.remove('expanded');
        header.innerHTML = '▶ 乘坐 ' + stopsCount + ' 站';
    } else {
        stopsList.classList.add('expanded');
        header.innerHTML = '▼ 乘坐 ' + stopsCount + ' 站';
    }
}

// 渲染路线步骤
function renderSteps(segments, routeIndex) {
    var stepsHtml = '<div class="route-steps-content">';
    var previousStep = ''; 

    segments.forEach(function (segment, index) {
        var segmentElements = [];
        
        if (segment.walking) {
            segmentElements.push({
                type: 'WALK',
                data: segment.walking,
                original_segment: segment
            });
        }
        if (segment.bus && segment.bus.buslines[0].type !== '地铁线路') {
            segmentElements.push({
                type: 'BUS', 
                data: segment.bus,
                original_segment: segment
            });
        }
        if (segment.bus && segment.bus.buslines[0].type === '地铁线路') {
            segmentElements.push({
                type: 'RAILWAY',
                data: segment.bus,
                original_segment: segment
            });
        }

        if (segmentElements.length <= 1) {
            var elementToProcess = segmentElements.length === 1 ? segmentElements[0] : { type: segment.transit_mode || 'WALK', data: segment, original_segment: segment };
            var stepHtml = renderSingleStep(elementToProcess, index, segments, routeIndex);
            if (!areStepsSimilar(previousStep, stepHtml)) {
                stepsHtml += stepHtml;
                previousStep = stepHtml; // 保存当前步骤  
            } 
        } else {
            segmentElements.forEach(function (element, elementIndex) {
                var adjustedIndex = index + (elementIndex * 0.1);
                var stepHtml = renderSingleStep(element, adjustedIndex, segments, routeIndex);
                
                // 检查是否有连续两个相同的步骤
                if (!areStepsSimilar(previousStep, stepHtml)) {
                    stepsHtml += stepHtml;
                    previousStep = stepHtml; // 保存当前步骤  
                } 
            });
        }
    });

    stepsHtml += '</div>';
    return stepsHtml;
}

function areStepsSimilar(stepHtml1, stepHtml2) {
    // 创建一个函数用来清理HTML，移除不需要比较的部分
    function cleanStepHtml(stepHtml) {
        // 移除ID
        stepHtml = stepHtml.replace(/<div id=".*?">/, '<div id="placeholder">');
        // 移除onclick
        stepHtml = stepHtml.replace(/onclick="toggleBusStops\(.*?\)"/, 'onclick="toggleBusStops(\'placeholder\')"');
        // 移除时间部分
        stepHtml = stepHtml.replace(/时间：.*?<\/span>/, '时间：placeholder</span>');
        stepHtml = stepHtml.replace(/距离：.*?<\/span>/, '距离：placeholder</span>');
        return stepHtml;
    }

    // 清理两个stepHtml
    const cleanedStepHtml1 = cleanStepHtml(stepHtml1);
    const cleanedStepHtml2 = cleanStepHtml(stepHtml2);

    // 比较清理后的内容
    return cleanedStepHtml1 === cleanedStepHtml2;
}

// 渲染单个步骤（新函数，处理单个元素）
function renderSingleStep(element, index, segments, routeIndex) {
    var segment = element.original_segment;
    var type = element.type;
    var currentData = element.data;
    
    // 根据元素类型生成图标和文字
    var iconClass, iconText;
    if (type === 'WALK') {
        iconClass = 'walk';
        iconText = '步行';
    } else if (type === 'SUBWAY' || type === 'RAILWAY') {
        iconClass = 'metro';
        iconText = '地铁';
    } else {
        iconClass = 'bus';
        iconText = '公交';
    }

    // 从当前元素数据中获取时间和距离信息
    var durationInfo = '';
    var distanceInfo = '';
    
    if (currentData && currentData.cost && currentData.cost.duration) {
        durationInfo = formatDuration(currentData.cost.duration);
    } else if (segment && segment.duration) {
        durationInfo = formatDuration(segment.duration);
    }
    
    if (currentData && currentData.distance) {
        distanceInfo = formatDistance(currentData.distance);
    } else if (segment && segment.distance) {
        distanceInfo = formatDistance(segment.distance);
    }

    var walkLink = '';
    var elementInstruction = '';
    var subwayStopsHtml = '';
    var busStopsHtml = '';

    // 如果是步行路段，检查是否为站内换乘，否则生成OM导航链接
    if (type === 'WALK') {
        elementInstruction = '步行';
        // 检查前后路段是否都是地铁
        var isStationTransfer = checkStationTransfer(segments, Math.floor(index));

        if (isStationTransfer) {
            walkLink = '<span style="color: #c586c0; font-size: 12px;">站内换乘</span>';
        } else {
            
            // 为步行元素创建一个临时的segment对象
            var walkingSegment = {
                walking: currentData,
                instruction: elementInstruction
            };
            walkLink = generateWalkOMLink(walkingSegment);
        }
    }
    // 处理公交路段
    else if (type === 'BUS') {
        // 为公交元素创建一个专门的segment对象，不依赖原始segment
        var busSegment = {
            transit: currentData,
            bus: currentData,
            instruction: elementInstruction,
            transit_mode: 'BUS'
        };
        
        // 尝试从公交路段数据中提取信息
        var formattedInstruction = formatBusInstruction(busSegment);
        if (formattedInstruction) {
            elementInstruction = formattedInstruction.replace(/，乘坐\d+站/, '').replace(/乘坐\d+站，/, '').replace(/乘坐\d+站/, '');
        } else {
            // 备用方案：从数据中生成指令
            if (currentData && currentData.buslines && currentData.buslines.length > 0) {
                var firstLine = currentData.buslines[0];
                var lineNames = [];
                if (firstLine.name) {
                    var lineName = firstLine.name.replace(/\([^)]*\)/g, ''); // 去掉括号内容
                    lineNames.push(lineName);
                }
                if (lineNames.length > 0) {
                    elementInstruction = lineNames.join('/');
                    if (firstLine.departure_stop && firstLine.departure_stop.name) {
                        elementInstruction += '，上车站：' + firstLine.departure_stop.name;
                    }
                    if (firstLine.via_stops[1] && firstLine.via_stops[1].name) {
                        elementInstruction += '，下一站：' + firstLine.via_stops[1].name;
                    }
                }
            }
        }
        if (!elementInstruction) {
            elementInstruction = '乘坐公交';
        }

        // 生成公交站点列表
        busStopsHtml = renderBusStops(busSegment, routeIndex, index);
    }
    // 处理地铁路段
    else if (type === 'SUBWAY' || type === 'RAILWAY') {
        // 为地铁元素创建一个专门的segment对象，不依赖原始segment
        var subwaySegment = {
            transit: currentData,
            bus: currentData,
            instruction: elementInstruction,
            transit_mode: type
        };
        
        // 尝试从地铁路段数据中提取信息
        var formattedInstruction = formatSubwayInstruction(subwaySegment);
        if (formattedInstruction) {
            elementInstruction = formattedInstruction.replace(/，乘坐\d+站/, '');
        } else {
            // 备用方案：从数据中生成指令
            if (currentData && currentData.buslines && currentData.buslines.length > 0) {
                var lineNames = [];
                currentData.buslines.forEach(function(line) {
                    if (line.name) {
                        var lineName = line.name.replace(/\([^)]*\)/g, ''); // 去掉括号内容
                        lineNames.push(lineName);
                    }
                });
                if (lineNames.length > 0) {
                    elementInstruction = lineNames.join('/');
                    if (currentData.buslines[0].departureStop && currentData.buslines[0].departureStop.name) {
                        elementInstruction += '，上车站：' + currentData.buslines[0].departureStop.name;
                    }
                    if (currentData.buslines[0].viaStops[1] && currentData.buslines[0].viaStops[1].name) {
                        elementInstruction += '，下一站：' + currentData.buslines[0].viaStops[1].name;
                    }
                }
            }
        }
        if (!elementInstruction) {
            elementInstruction = '乘坐地铁';
        }

        // 生成地铁站点列表
        subwayStopsHtml = renderSubwayStops(subwaySegment, routeIndex, index);
    }

    var stepHtml = `
                <div class="step-item">
                    <div class="step-icon ${iconClass}">${iconText}</div>
                    <div class="step-content">
                        <div class="step-instruction">${elementInstruction}</div>
                        <div class="step-details">
                            <div>
                                ${durationInfo ? '<span style="color: #4ec9b0;">时间：' + durationInfo + '</span>' : ''} 
                                ${distanceInfo ? '<span style="color: #569cd6;">距离：' + distanceInfo + '</span>' : ''}
                            </div>
                            <div>
                                ${walkLink}
                            </div>
                        </div>
                        ${subwayStopsHtml}
                        ${busStopsHtml}
                    </div>
                </div>
            `;

    return stepHtml;
}

// 渲染路线
function renderRoute(route, index) {
    var transportTypes = getTransportSummary(route.segments);
    var actualCost = getActualCost(route);
    var walkingDistance = getWalkingDistance(route.segments);

    // 生成交通方式徽章
    var transportBadges = transportTypes.map(function (type) {
        var badgeClass = type === '步行' ? 'walk' : (type === '地铁' ? 'metro' : 'bus');
        return `<span class="transport-badge ${badgeClass}">${type}</span>`;
    }).join('');

    // 根据是否有费用信息来决定显示内容
    var costDisplay = actualCost !== null && actualCost !== undefined ?
        `<div class="route-cost">¥${actualCost}</div>` : '';

    var routeHtml = `
                <div class="route-item" data-route-index="${index}">
                    <div class="route-header" onclick="toggleRoute(${index})">
                        <div class="route-title">
                            <div class="expand-icon" id="expand-icon-${index}"></div>
                            #${index + 1}
                        </div>
                        <div class="route-summary">
                            <div class="route-time">${formatDuration(route.time)}</div>
                            <div class="route-distance">步行${formatDistance(walkingDistance)}</div>
                            ${costDisplay}
                        </div>
                    </div>
                    <div class="route-steps" id="route-steps-${index}">
                        ${renderSteps(route.segments, index)}
                    </div>
                </div>
            `;
    return routeHtml;
}

// 折叠/展开路线
function toggleRoute(index) {
    var allRouteSteps = document.querySelectorAll('.route-steps');
    var allExpandIcons = document.querySelectorAll('.expand-icon');
    var allRouteHeaders = document.querySelectorAll('.route-header');

    // 折叠所有其他路线
    for (var i = 0; i < allRouteSteps.length; i++) {
        if (i !== index) {
            allRouteSteps[i].classList.remove('expanded');
            allExpandIcons[i].classList.remove('expanded');
            allRouteHeaders[i].classList.remove('expanded');
        }
    }

    // 切换当前路线
    var currentSteps = document.getElementById('route-steps-' + index);
    var currentIcon = document.getElementById('expand-icon-' + index);
    var currentHeader = currentSteps.previousElementSibling;

    if (currentSteps.classList.contains('expanded')) {
        // 如果当前已展开，则折叠
        currentSteps.classList.remove('expanded');
        currentIcon.classList.remove('expanded');
        currentHeader.classList.remove('expanded');
    } else {
        // 展开当前路线
        currentSteps.classList.add('expanded');
        currentIcon.classList.add('expanded');
        currentHeader.classList.add('expanded');
    }
}

// 显示错误信息
function showError(message) {
    var errorDiv = document.getElementById('error');
    errorDiv.textContent = message;
    errorDiv.classList.remove('hidden');

    setTimeout(function () {
        errorDiv.classList.add('hidden');
    }, 5000);
}

// 搜索路线 - Web API版本
function searchRoute() {
    var city = document.getElementById('cityinput').value.trim();
    var startKeyword = document.getElementById('startinput').value.trim();
    var endKeyword = document.getElementById('endinput').value.trim();

    // 保存起终点到本地存储
    saveStartEnd();

    if (!city) {
        showError('请填写城市');
        return;
    }

    if (!startKeyword) {
        showError('请输入出发地');
        return;
    }

    if (!endKeyword) {
        showError('请输入目的地');
        return;
    }

    // 显示加载状态
    document.getElementById('loading').classList.remove('hidden');
    document.getElementById('result').classList.add('hidden');
    document.getElementById('error').classList.add('hidden');
    document.getElementById('search-btn').disabled = true;

    // 搜索起点和终点坐标
    var startSearchPromise = new Promise(function (resolve) {
        if (startLocation) {
            resolve(startLocation);
        } else {
            searchLocation(startKeyword, city, true, resolve);
        }
    });

    var endSearchPromise = new Promise(function (resolve) {
        if (endLocation) {
            resolve(endLocation);
        } else {
            searchLocation(endKeyword, city, false, resolve);
        }
    });

    Promise.all([startSearchPromise, endSearchPromise]).then(function (locations) {
        var startLoc = locations[0];
        var endLoc = locations[1];

        if (!startLoc || !endLoc) {
            throw new Error('无法找到起点或终点的位置信息');
        }

        // 获取出发时间
        var departureTime = getDepartureTimestamp();

        // 使用Web API进行公交路径规划
        searchTransitRouteWebAPI(startLoc, endLoc, city, departureTime);

    }).catch(function (error) {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('search-btn').disabled = false;
        showError(error.message);
    });
}

// 使用Web API进行公交路径规划
function searchTransitRouteWebAPI(startLoc, endLoc, city, departureTime) {
    // 构建API请求URL
    var baseUrl = 'https://restapi.amap.com/v5/direction/transit/integrated';
    var params = new URLSearchParams();

    // 获取城市编码，优先使用编码，如果没有匹配则使用原始城市名
    var cityCode = getCurrentCityCode();
    var cityToUse = cityCode || city;

    // 必填参数
    params.append('key', window.AMAP_CONFIG.webApiKey);
    params.append('origin', startLoc.lng + ',' + startLoc.lat);
    params.append('destination', endLoc.lng + ',' + endLoc.lat);
    params.append('city1', cityToUse);
    params.append('city2', cityToUse);
    params.append('show_fields', 'cost');

    // 可选参数 - 策略值必须使用数字字符串
    var strategyValue = getPolicyValue();
    // 确保策略值是有效的数字字符串（0-8）
    var validStrategies = ['0', '1', '2', '3', '4', '5', '7', '8'];
    var mappedStrategy = validStrategies.includes(strategyValue) ? strategyValue : '0';
    params.append('strategy', mappedStrategy);
    params.append('alternative_route', '8'); // 返回5条路线
    params.append('night_flag', '1'); // 考虑夜班车

    // 如果有出发时间，添加时间参数
    if (departureTime) {
        var date = new Date(departureTime * 1000);
        var dateStr = date.getFullYear() + '-' +
            String(date.getMonth() + 1).padStart(2, '0') + '-' +
            String(date.getDate()).padStart(2, '0');
        var timeStr = String(date.getHours()).padStart(2, '0') + '-' +
            String(date.getMinutes()).padStart(2, '0');
        params.append('date', dateStr);
        params.append('time', timeStr);
    }

    // 发送请求
    var requestUrl = baseUrl + '?' + params.toString();

    fetch(requestUrl)
        .then(function (response) {
            if (!response.ok) {
                throw new Error('HTTP ' + response.status + ': ' + response.statusText);
            }
            return response.json();
        })
        .then(function (data) {
            handleWebAPIResult(data);
        })
        .catch(function (error) {
            console.error('Web API请求错误:', error);
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('search-btn').disabled = false;
            showError('路线规划失败：' + error.message);
        });
}

// 处理Web API路线搜索结果
function handleWebAPIResult(data) {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('search-btn').disabled = false;


    if (data.status === '1' && data.route && data.route.transits && data.route.transits.length > 0) {

        // 成功获取路线，添加到历史记录
        var startValue = document.getElementById('startinput').value.trim();
        var endValue = document.getElementById('endinput').value.trim();

        if (startValue) {
            updateSearchHistory(startValue, startValue, 'start');
        }
        if (endValue) {
            updateSearchHistory(endValue, endValue, 'end');
        }

        // 转换Web API数据格式为原来的格式
        var convertedPlans = convertWebAPIToLegacyFormat(data.route.transits);

        var routesHtml = '';
        convertedPlans.forEach(function (plan, index) {
            routesHtml += renderRoute(plan, index);
        });

        document.getElementById('routes-container').innerHTML = routesHtml;
        document.getElementById('result').classList.remove('hidden');

    } else {
        var errorMsg = '路线规划失败：';
        if (data.status !== '1') {
            errorMsg += 'API状态码：' + data.status;
            if (data.info) {
                errorMsg += '，' + data.info;
            }
            if (data.error_code) {
                errorMsg += '（错误代码：' + data.error_code + '）';
            }
        } else if (!data.route) {
            errorMsg += '未找到路线数据';
        } else if (!data.route.transits) {
            errorMsg += '未找到公交路线';
        } else if (data.route.transits.length === 0) {
            errorMsg += '该路线暂无公交方案';
        } else {
            errorMsg += '未知错误';
        }
        showError(errorMsg);
    }
}

// 将Web API数据格式转换为原来的格式
function convertWebAPIToLegacyFormat(transits) {
    return transits.map(function (transit, transitIndex) {
        var segments = [];

        if (transit.segments) {
            segments = [];
            
            transit.segments.forEach(function (segment, index) {
                // 处理包含多种交通方式的路段
                var processedSegments = [];
                
                // 处理步行路段
                if (segment.walking) {
                    var walkingInstruction = '步行';
                    if (segment.walking.steps && segment.walking.steps.length > 0) {
                        var lastStep = segment.walking.steps[segment.walking.steps.length - 1];
                        walkingInstruction = lastStep.instruction || '步行';
                    }
                    
                    var walkingSegment = {
                        instruction: walkingInstruction,
                        duration: segment.walking.cost ? parseInt(segment.walking.cost.duration) || 0 : 0,
                        distance: parseInt(segment.walking.distance) || 0,
                        transit_mode: 'WALK',
                        time: segment.walking.cost ? parseInt(segment.walking.cost.duration) || 0 : 0,
                        walking: segment.walking
                    };

                    // 处理步行路段的详细信息
                    if (segment.walking.steps) {
                        walkingSegment.transit = {
                            origin: segment.walking.origin ? segment.walking.origin.split(',').map(Number).reverse() : null,
                            destination: segment.walking.destination ? segment.walking.destination.split(',').map(Number).reverse() : null,
                            steps: segment.walking.steps
                        };
                    }
                    
                    processedSegments.push(walkingSegment);
                }
                
                // 处理公交路段（只在segment主要包含公交数据时处理）
                if (segment.bus && segment.bus.buslines && segment.bus.buslines.length > 0) {
                    // 检查这个segment是否主要是公交segment（避免重复处理混合路段中的公交）
                    var isMainBusSegment = !segment.walking; // 如果没有步行数据，说明这是纯公交segment
                    
                    segment.bus.buslines.forEach(function(busline, buslineIndex) {
                        var lineName = busline.name || '';
                        var departureStop = busline.departure_stop;
                        var arrivalStop = busline.arrival_stop;
                        var viaStops = busline.via_stops || [];
                        
                        // 检查是否为地铁线路
                        var isSubway = busline.type && busline.type.includes('地铁') || 
                                       busline.name && busline.name.includes('地铁') ||
                                       busline.id && busline.id.includes('subway');
                        
                        var busSegment = {
                            instruction: lineName + ' 到 ' + (arrivalStop ? arrivalStop.name : '终点'),
                            duration: busline.cost ? parseInt(busline.cost.duration) || 0 : 0,
                            distance: parseInt(busline.distance) || 0,
                            transit_mode: isSubway ? 'SUBWAY' : 'BUS',
                            time: busline.cost ? parseInt(busline.cost.duration) || 0 : 0,
                            bus: segment.bus
                        };

                        // 设置transit信息，每条线路单独处理
                        busSegment.transit = {
                            lines: [busline], // 只包含当前线路
                            on_station: departureStop,
                            off_station: arrivalStop,
                            via_stops: viaStops
                        };
                        
                        processedSegments.push(busSegment);
                    });
                }
                
                // 处理铁路路段（地铁）
                if (segment.railway) {
                    var railwaySegment = {
                        instruction: '乘坐地铁',
                        duration: 0,
                        distance: 0,
                        transit_mode: 'SUBWAY',
                        time: 0,
                        railway: segment.railway
                    };
                    processedSegments.push(railwaySegment);
                }
                
                // 将处理好的segments添加到总的segments数组中
                processedSegments.forEach(function(processedSegment) {
                    segments.push(processedSegment);
                });
            });
        }
        return {
            time: transit.cost ? parseInt(transit.cost.duration) || 0 : 0,
            distance: parseInt(transit.distance) || 0,
            cost: transit.cost ? parseFloat(transit.cost.transit_fee) || 0 : 0,
            segments: segments
        };
    });
}



// 绑定搜索按钮事件
document.getElementById('search-btn').addEventListener('click', searchRoute);

// 移除重复的回车事件处理，因为输入提示功能已经处理了回车键

document.getElementById('cityinput').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
        saveCity(this.value);
        document.getElementById('startinput').focus();
    }
});

// 更新搜索服务的城市
function updateSearchCity() {
    var city = getCurrentCity();
    if (city !== currentCity) {
        currentCity = city;
        setupAutocomplete();
    }
}
    </script>
</body>
</html>
