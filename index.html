<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>公共交通路线规划</title>
    <link rel="icon" type="image/png" href="/pics/bus.png">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- 设置按钮 -->
    <button class="settings-btn" onclick="openSettings()" title="设置常用地址">=</button>
    
    <!-- 城市输入框 -->
    <div class="city-input-container">
        <div class="city-label">城市</div>
        <div class="city-input-wrapper">
            <input id='cityinput' type="text" placeholder="输入城市名称" value="北京市">
        </div>
    </div>
    
    <!-- 设置弹窗 -->
    <div id="settings-modal" class="settings-modal">
        <div class="settings-card">
            <div class="settings-header">
                <h2 class="settings-title">设置</h2>
                <button class="close-btn" onclick="closeSettings()">×</button>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">API密钥配置</label>
                <button class="api-config-toggle" onclick="toggleApiConfig()" title="展开/收起API配置">
                    <span id="api-toggle-icon">▶</span>
                    <span id="api-toggle-text">展开配置</span>
                </button>
                <div id="api-config-content" class="api-config-content" style="display: none;">
                    <div class="setting-item">
                        <label class="setting-label">Web服务API Key</label>
                        <div class="setting-input-group">
                            <input id="webapi-key-input" type="text" class="setting-input" placeholder="输入高德地图Web服务API Key">
                            <button class="clear-btn" onclick="clearSettingInput('webapi-key-input')" title="清除内容" style="right: 10px;">×</button>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <label class="setting-label">JS Web API Key</label>
                        <div class="setting-input-group">
                            <input id="jswebapi-key-input" type="text" class="setting-input" placeholder="输入高德地图JS Web API Key">
                            <button class="clear-btn" onclick="clearSettingInput('jswebapi-key-input')" title="清除内容" style="right: 10px;">×</button>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <label class="setting-label">安全密钥</label>
                        <div class="setting-input-group">
                            <input id="safety-key-input" type="text" class="setting-input" placeholder="输入高德地图安全密钥">
                            <button class="clear-btn" onclick="clearSettingInput('safety-key-input')" title="清除内容" style="right: 10px;">×</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">家庭地址</label>
                <div class="setting-input-group">
                    <input id="home-input" type="text" class="setting-input" placeholder="输入家庭地址">
                    <button class="clear-btn" onclick="clearSettingInput('home-input')" title="清除内容" style="right: 10px;">×</button>
                </div>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">公司地址</label>
                <div class="setting-input-group">
                    <input id="company-input" type="text" class="setting-input" placeholder="输入公司地址">
                    <button class="clear-btn" onclick="clearSettingInput('company-input')" title="清除内容" style="right: 10px;">×</button>
                </div>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">收藏地址</label>
                <div class="setting-input-group">
                    <input id="favorite-input" type="text" class="setting-input" placeholder="输入收藏地址">
                    <button class="clear-btn" onclick="clearSettingInput('favorite-input')" title="清除内容" style="right: 10px;">×</button>
                </div>
            </div>
            
            <button class="save-settings-btn" onclick="saveSettings()">保存设置</button>
        </div>
    </div>

    <div class="container">
        <h1 style="text-align: center; color: #cccccc; margin-bottom: 15px; font-weight: 300; font-size: 24px;padding-top: 30px;">公共交通路线规划</h1>
        
        <div class="input-group">
            <div class="input-item" style="flex: 4;">
                <div class="input-item-prepend">
                    <span class="input-item-text">出发时间</span>
                </div>
                <div class="autocomplete-container">
                    <input id='departuretime' type="text" placeholder="现在出发">
                    <button class="clear-btn" onclick="clearDepartureTime()" title="清除时间">×</button>
                    <button class="autocomplete-dropdown" onclick="toggleTimeDropdown()" title="快速选择时间">▼</button>
                    <div id="time-dropdown" class="dropdown-menu">
                        <div class="dropdown-item header">快速选择</div>
                        <div class="dropdown-item" onclick="selectQuickTime('now')">现在出发</div>
                        <div class="dropdown-item" onclick="selectQuickTime('morning')">早高峰 (8:00)</div>
                        <div class="dropdown-item" onclick="selectQuickTime('noon')">中午 (12:00)</div>
                        <div class="dropdown-item" onclick="selectQuickTime('evening')">晚高峰 (18:00)</div>
                        <div class="dropdown-item" onclick="selectQuickTime('night')">夜间 (22:00)</div>
                    </div>
                </div>
            </div>
            <div class="input-item" style="flex: 3;">
                <div class="input-item-prepend">
                    <span class="input-item-text">路线选择依据</span>
                </div>
                <div class="autocomplete-container">
                    <input id="policy-select" type="text" readonly value="默认" data-value="0">
                    <button class="autocomplete-dropdown" onclick="togglePolicyDropdown()" title="选择路线依据">▼</button>
                    <div id="policy-dropdown" class="dropdown-menu">
                        <div class="dropdown-item" onclick="selectPolicy('0', '默认')">默认</div>
                        <div class="dropdown-item" onclick="selectPolicy('1', '最经济')">最经济</div>
                        <div class="dropdown-item" onclick="selectPolicy('2', '少换乘')">少换乘</div>
                        <div class="dropdown-item" onclick="selectPolicy('3', '少步行')">少步行</div>
                        <div class="dropdown-item" onclick="selectPolicy('4', '最舒适')">最舒适</div>
                        <div class="dropdown-item" onclick="selectPolicy('5', '不乘地铁')">不乘地铁</div>
                        <div class="dropdown-item" onclick="selectPolicy('7', '地铁优先')">地铁优先</div>
                        <div class="dropdown-item" onclick="selectPolicy('8', '时间短')">时间短</div>
                    </div>
                </div>
            </div>
            <div class="swap-container">
                <button id="swap-btn" class="swap-btn" onclick="swapStartEnd()" title="交换起终点">⇵</button>
            </div>
        </div>
        <div class="input-group">
            <div class="input-item-wide">
                <div class="input-item-prepend">
                    <span class="input-item-text">出发地</span>
                </div>
                <div class="autocomplete-container">
                    <input id='startinput' type="text" placeholder="输入出发地名称">
                    <button class="clear-btn" onclick="clearInput('startinput')" title="清除内容">×</button>
                    <button class="autocomplete-dropdown" onclick="toggleDropdown('start')" title="历史记录和常用地址">▼</button>
                    <div id="start-dropdown" class="dropdown-menu">
                        <div class="dropdown-item header">常用地址</div>
                        <div style="display: flex;justify-content: space-around;align-items: center;border-bottom: 1px solid #3e3e42;">
                            <div class="dropdown-item" onclick="selectFromDropdown('start', 'home')" style="border-bottom: 0px">🏠 家</div>
                            <div class="dropdown-item" onclick="selectFromDropdown('start', 'company')" style="border-bottom: 0px">🏢 公司</div>
                            <div class="dropdown-item" onclick="selectFromDropdown('start', 'favorite')" style="border-bottom: 0px">⭐ 收藏</div>
                        </div>
                        <div class="dropdown-item header">历史记录</div>
                        <div id="start-history"></div>
                    </div>
                </div>
            </div>
            <div class="swap-container">
                <button id="locate-btn" class="swap-btn" onclick="locateStart()" title="定位到起点" style="font-size: 28px;">⌖</button>
            </div>
        </div>
        
        <div class="input-group">
            <div class="input-item-wide">
                <div class="input-item-prepend">
                    <span class="input-item-text">目的地</span>
                </div>
                <div class="autocomplete-container">
                    <input id='endinput' type="text" placeholder="输入目的地名称">
                    <button class="clear-btn" onclick="clearInput('endinput')" title="清除内容">×</button>
                    <button class="autocomplete-dropdown" onclick="toggleDropdown('end')" title="历史记录和常用地址">▼</button>
                    <div id="end-dropdown" class="dropdown-menu">
                        <div class="dropdown-item header">常用地址</div>
                        <div style="display: flex;justify-content: space-around;align-items: center;border-bottom: 1px solid #3e3e42;">
                            <div class="dropdown-item" onclick="selectFromDropdown('end', 'home')" style="border-bottom: 0px">🏠 家</div>
                            <div class="dropdown-item" onclick="selectFromDropdown('end', 'company')" style="border-bottom: 0px">🏢 公司</div>
                            <div class="dropdown-item" onclick="selectFromDropdown('end', 'favorite')" style="border-bottom: 0px">⭐ 收藏</div>
                        </div>
                        <div class="dropdown-item header">历史记录</div>
                        <div id="end-history"></div>
                    </div>
                </div>
            </div>
            <div class="target-container">
                <button id="target-btn" class="swap-btn" onclick="locateTarget()" title="定位到终点" style="font-size: 22px;transform: rotate(-90deg);transform-origin: center;">⤵</button>
            </div>
        </div>
        <div style="display: flex; gap: 10px;">
            <button id="search-btn" class="search-btn" style="flex: 1;">规划路线</button>
            <div class="target-container">
                <button id="share-btn" class="swap-btn" onclick="generateShareLink()" title="生成分享链接" style="font-size: 12px; margin: 0;">➜]</button>
            </div> 
        </div>
        

        
        <div id="loading" class="loading hidden">
            正在规划路线...
        </div>
        
        <div id="error" class="error hidden"></div>
        
        <div id="result" class="result-container hidden">
            <div class="result-title">路线方案</div>
            <div id="routes-container"></div>
        </div>
    </div>  
    <!-- 引入高德地图API -->
    <script type="text/javascript">
        // 初始化API配置为空，从localStorage加载
        function initializeAPIConfig() {
            var savedWebApiKey = localStorage.getItem('webApiKey');
            var savedJSWebApiKey = localStorage.getItem('JSwebApiKey');
            var savedSafetyKey = localStorage.getItem('safetyKey');
            
            window.AMAP_CONFIG = {
                webApiKey: savedWebApiKey || '',
                JSwebApiKey: savedJSWebApiKey || '',
                safetyKey: savedSafetyKey || ''
            };
            
            // 只有在JSwebApiKey和safetyKey都被设置后，才加载高德地图API
            if (window.AMAP_CONFIG.JSwebApiKey && window.AMAP_CONFIG.safetyKey) {
                // 设置高德地图安全密钥（必须在加载API之前设置）
                window._AMapSecurityConfig = {
                    securityJsCode: window.AMAP_CONFIG.safetyKey
                };
                
                // 动态加载高德地图API
                document.write('<script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=' + window.AMAP_CONFIG.JSwebApiKey + '&plugin=AMap.PlaceSearch"><\/script>');
            }
        }
        
        // 初始化API配置
        initializeAPIConfig();
    </script>
    
    <!-- 引入城市编码数据 -->
     <script src="js/citycode.js"></script>
    
    <!-- 坐标转换函数 -->
    <script src="js/coordinateAdjust.js"></script>
    <!-- 坐标转换函数 -->
    <script src="js/bus-route-planning.js"></script>
</body>
</html>