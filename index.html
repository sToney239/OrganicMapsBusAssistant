<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>å…¬å…±äº¤é€šè·¯çº¿è§„åˆ’</title>
    <style>
html, body {
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif, 'Courier New', monospace;
    background-color: #1e1e1e;
    color: #d4d4d4;
}

.container {
    max-width: 800px;
    margin: 5px auto;
    padding: 20px;
}

.input-group {
    display: flex;
    gap: 10px;
    margin-bottom: 0px;
    align-items: flex-end;
}

.swap-container {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 0 10px;
    width: 40px;
    height: 76px;
}

.target-container {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 0 10px;
    width: 40px;
    height: 76px;
}

.swap-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #4ec9b0;
    color: white;
    border: none;
    cursor: pointer;
    font-size: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s, transform 0.2s;
    flex-shrink: 0;
    line-height: 1;
    padding: 0;
}

.swap-btn:hover {
    background-color: #3ba996;
    transform: scale(1.05);
}

.swap-btn:active {
    transform: scale(0.95);
}


.input-item {
    flex: 1;
    margin-bottom: 15px;
}

.input-item-wide {
    flex: 1;
    margin-bottom: 15px;
}

.input-item-prepend {
    margin-bottom: 8px;
}

.input-item-text {
    font-weight: bold;
    color: #cccccc;
    font-size: 14px;
}

#cityinput, #startinput, #endinput, #departuretime {
    width: 100%;
    padding: 12px;
    padding-right: 70px;
    border: 1px solid #3e3e42;
    border-radius: 4px;
    font-size: 14px;
    box-sizing: border-box;
    background-color: #3c3c3c;
    color: #d4d4d4;
    font-family: Arial, sans-serif, 'Courier New', monospace;
    transition: border-color 0.2s, background-color 0.2s;
}
#cityinput {
    padding-left: 50px;
    padding-right: 12px;
}

#policy-select {
    width: 100%;
    padding: 12px 35px 12px 12px;
    border: 1px solid #3e3e42;
    border-radius: 4px;
    font-size: 14px;
    box-sizing: border-box;
    background-color: #3c3c3c;
    color: #d4d4d4;
    font-family: Arial, sans-serif, 'Courier New', monospace;
    transition: border-color 0.2s, background-color 0.2s;
    cursor: pointer;
}

#cityinput:focus, #startinput:focus, #endinput:focus, #departuretime:focus, #policy-select:focus {
    outline: none;
    border-color: #0078d4;
    background-color: #404040;
}

#cityinput::placeholder, #startinput::placeholder, #endinput::placeholder, #departuretime::placeholder, #policy-select::placeholder {
    color: #858585;
}

.search-btn {
    background-color: #0078d4;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-family: Arial, sans-serif, 'Courier New', monospace;
    transition: background-color 0.2s;
    margin-top: 20px;
    width: 100%;
}

.search-btn:hover {
    background-color: #106ebe;
}

.search-btn:disabled {
    background-color: #555;
    cursor: not-allowed;
}

.result-container {
    margin-top: 20px;
    padding: 10px;
    background-color: #2d2d30;
    border-radius: 4px;
}

.result-title {
    font-weight: bold;
    margin-bottom: 10px;
    color: #cccccc;
    font-size: 16px;
}

.route-item {
    margin-bottom: 15px;
    background-color: #252526;
    border-radius: 4px;
    border: 1px solid #3e3e42;
    overflow: hidden;
    transition: all 0.3s ease;
}

.route-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s ease;
}

.route-header:hover {
    background-color: #2d2d30;
}

.route-header.expanded {
    border-bottom: 1px solid #3e3e42;
}

.route-title {
    color: #569cd6;
    font-weight: bold;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.expand-icon {
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-top: 8px solid #569cd6;
    transition: transform 0.3s ease;
    transform-origin: center;
}

.expand-icon.expanded {
    transform: rotate(180deg);
}

.route-summary {
    display: flex;
    gap: 20px;
    align-items: center;
    flex-wrap: wrap;
}

.route-time, .route-cost, .route-distance {
    color: #ce9178;
    font-size: 14px;
}

.route-transport {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
}

.transport-badge {
    padding: 4px 8px;
    border-radius: 3px;
    font-size: 12px;
    font-weight: bold;
    color: white;
}

.transport-badge.walk {
    background-color: #4ec9b0;
}

.transport-badge.bus {
    background-color: #dcdcaa;
}

.transport-badge.metro {
    background-color: #c586c0;
}

.route-steps {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
}

.route-steps.expanded {
    max-height: 2000px;
}

.route-steps-content {
    padding: 10px 10px 0px 10px;
}

.step-item {
    display: flex;
    align-items: flex-start;
    margin-bottom: 12px;
    padding: 8px;
    background-color: #1e1e1e;
    border-radius: 4px;
}

.step-icon {
    width: 30px;
    height: 30px;
    background-color: #0078d4;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 10px;
    font-weight: bold;
    margin-right: 12px;
    flex-shrink: 0;
}

.step-icon.walk {
    background-color: #12B571;
}

.step-icon.metro {
    background-color: #0482BA;
}

.step-icon.bus {
    background-color: #F67B4D;
}

.step-content {
    flex: 1;
}

.step-instruction {
    color: #d4d4d4;
    font-size: 14px;
    margin-bottom: 4px;
}

.step-details {
    color: #858585;
    font-size: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 4px;
}

.subway-stops {
    margin-top: 8px;
    padding-left: 12px;
    font-size: 12px;
    color: #9cdcfe;
}

.subway-stops-header {
    cursor: pointer;
    color: #569cd6;
    font-size: 12px;
    margin-bottom: 4px;
    user-select: none;
    transition: color 0.2s;
}

.subway-stops-header:hover {
    color: #4a9eff;
    text-decoration: underline;
}

.bus-stops {
    margin-top: 8px;
    padding-left: 12px;
    font-size: 12px;
    color: #9cdcfe;
}

.bus-stops-header {
    cursor: pointer;
    color: #dcdcaa;
    font-size: 12px;
    margin-bottom: 4px;
    user-select: none;
    transition: color 0.2s;
}

.bus-stops-header:hover {
    color: #b8b869;
    text-decoration: underline;
}

.subway-stops-list {
    display: none;
    line-height: 1.4;
    margin-left: 8px;
}

.subway-stops-list.expanded {
    display: block;
}

.subway-stop-item {
    padding: 2px 0;
    border-left: 2px solid #569cd6;
    padding-left: 8px;
    margin-bottom: 2px;
}

.subway-stop-item:last-child {
    border-left-color: #c586c0;
}

.om-walk-link {
    color: #569cd6;
    text-decoration: none;
    font-size: 12px;
    padding: 2px 6px;
    border-radius: 3px;
    background-color: #1e1e1e;
    transition: background-color 0.2s;
    white-space: nowrap;
}

.om-walk-link:hover {
    background-color: #3c3c3c;
    text-decoration: underline;
}

.autocomplete-container {
    position: relative;
}

.clear-btn {
    position: absolute;
    right: 44px;
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    border: none;
    background: #666;
    color: #d4d4d4;
    border-radius: 50%;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s, color 0.2s;
    z-index: 10;
    line-height: 1;
    padding: 0;
}

.clear-btn:hover {
    background: #0078d4;
    color: white;
}

.clear-btn:active {
    transform: translateY(-50%) scale(0.9);
}

.settings-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #3C3C3C;
    color: white;
    border: none;
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s, transform 0.2s;
    z-index: 1000;
    line-height: 1;
    padding: 0;
}

.settings-btn:hover {
    background-color: #3C3C3C;
    transform: scale(1.05);
}

.settings-btn:active {
    transform: scale(0.95);
}

.city-input-container {
    position: absolute;
    top: 20px;
    left: 20px;
    z-index: 1000;
    width: 120px;
}

.city-input-wrapper {
    position: relative;
    width: 100%;
}

.city-label {
    position: absolute;
    left: 0;
    top: 0;
    background-color: #666666;
    color: #d4d4d4;
    padding: 0 8px;
    font-size: 12px;
    font-weight: bold;
    font-family: Arial, sans-serif, 'Courier New', monospace;
    height: 40px;
    width: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1;
    border-radius: 4px 0 0 4px;
}

.city-input-container input {
    width: 160px;
    padding: 12px 12px 12px 45px;
    border: 1px solid #3e3e42;
    border-radius: 4px;
    font-size: 14px;
    box-sizing: border-box;
    background-color: #3c3c3c;
    color: #d4d4d4;
    font-family: Arial, sans-serif, 'Courier New', monospace;
    transition: border-color 0.2s, background-color 0.2s;
    height: 40px;
}

.city-input-container input:focus {
    outline: none;
    border-color: #0078d4;
    background-color: #404040;
}

.city-input-container input::placeholder {
    color: #858585;
}

.settings-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}

.settings-modal.show {
    display: flex;
}

.settings-card {
    background-color: #252526;
    border: 1px solid #3e3e42;
    border-radius: 8px;
    padding: 30px;
    max-width: 500px;
    width: 80%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.settings-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
}

.settings-title {
    color: #cccccc;
    font-size: 20px;
    font-weight: bold;
}

.close-btn {
    background: none;
    border: none;
    color: #858585;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.2s;
}

.close-btn:hover {
    color: #d4d4d4;
}

.setting-item {
    margin-bottom: 20px;
}

.setting-label {
    display: block;
    color: #cccccc;
    font-size: 14px;
    font-weight: bold;
    margin-bottom: 8px;
}

.setting-input-group {
    position: relative;
}

.setting-input {
    width: 100%;
    padding: 12px;
    padding-right: 35px;
    border: 1px solid #3e3e42;
    border-radius: 4px;
    font-size: 14px;
    box-sizing: border-box;
    background-color: #3c3c3c;
    color: #d4d4d4;
    font-family: Arial, sans-serif, 'Courier New', monospace;
    transition: border-color 0.2s, background-color 0.2s;
}

.setting-input:focus {
    outline: none;
    border-color: #0078d4;
    background-color: #404040;
}

.setting-input::placeholder {
    color: #858585;
}

.save-settings-btn {
    background-color: #3C3C3C;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-family: Arial, sans-serif, 'Courier New', monospace;
    transition: background-color 0.2s;
    width: 100%;
    margin-top: 20px;
}

.save-settings-btn:hover {
    background-color: #3C3C3C;
}

.autocomplete-dropdown {
    position: absolute;
    right: 0;
    top: 0;
    width: 35px;
    height: 100%;
    border: none;
    background: #666;
    color: #d4d4d4;
    border-radius: 0 4px 4px 0;
    cursor: pointer;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s;
    z-index: 10;
    padding: 0;
}

.autocomplete-dropdown:hover {
    background: #0078d4;
    color: white;
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    right: 0;
    background: #252526;
    border: 1px solid #3e3e42;
    border-radius: 4px;
    min-width: 200px;
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    display: none;
}

.dropdown-menu.show {
    display: block;
}

.dropdown-item {
    padding: 10px 15px;
    color: #d4d4d4;
    cursor: pointer;
    border-bottom: 1px solid #3e3e42;
    font-size: 13px;
    transition: background-color 0.2s;
}

.dropdown-item:hover {
    background-color: #3c3c3c;
}

.dropdown-item:last-child {
    border-bottom: none;
}

.dropdown-item.header {
    color: #858585;
    font-size: 11px;
    font-weight: bold;
    text-transform: uppercase;
    padding: 8px 15px;
    cursor: default;
}

.dropdown-item.header:hover {
    background-color: transparent;
}

.amap-sug-result {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #252526;
    border: 1px solid #3e3e42;
    border-top: none;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    border-radius: 0 0 4px 4px;
}

.amap-sug-result .auto-item {
    padding: 8px 12px;
    color: #d4d4d4;
    cursor: pointer;
    border-bottom: 1px solid #3e3e42;
    font-family: Arial, sans-serif, 'Courier New', monospace;
    font-size: 13px;
}

.amap-sug-result .auto-item:hover {
    background-color: #3c3c3c;
}

.amap-sug-result .auto-item:last-child {
    border-bottom: none;
}

.hidden {
    display: none;
}

.loading {
    text-align: center;
    color: #cccccc;
    padding: 20px;
}

.error {
    color: #f48771;
    background-color: #2d1b1b;
    padding: 15px;
    border-radius: 4px;
    border: 1px solid #8c2d2d;
}


    </style>
</head>
<body>

    <!-- è®¾ç½®æŒ‰é’® -->
    <button class="settings-btn" onclick="openSettings()" title="è®¾ç½®å¸¸ç”¨åœ°å€">=</button>
    
    <!-- åŸå¸‚è¾“å…¥æ¡† -->
    <div class="city-input-container">
        <div class="city-label">åŸå¸‚</div>
        <div class="city-input-wrapper">
            <input id='cityinput' type="text" placeholder="è¾“å…¥åŸå¸‚åç§°" value="åŒ—äº¬å¸‚">
        </div>
    </div>
    
    <!-- è®¾ç½®å¼¹çª— -->
    <div id="settings-modal" class="settings-modal">
        <div class="settings-card">
            <div class="settings-header">
                <h2 class="settings-title">è®¾ç½®</h2>
                <button class="close-btn" onclick="closeSettings()">Ã—</button>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">é«˜å¾·åœ°å›¾WebæœåŠ¡API</label>
                <div class="setting-input-group">
                    <input id="webapi-key-input" type="text" class="setting-input" placeholder="è¾“å…¥é«˜å¾·åœ°å›¾WebæœåŠ¡API Key">
                    <button class="clear-btn" onclick="clearSettingInput('webapi-key-input')" title="æ¸…é™¤å†…å®¹" style="right: 10px;">Ã—</button>
                </div>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">é«˜å¾·åœ°å›¾Webç«¯JS API</label>
                <div class="setting-input-group">
                    <input id="jswebapi-key-input" type="text" class="setting-input" placeholder="è¾“å…¥é«˜å¾·åœ°å›¾Webç«¯JS API Key">
                    <button class="clear-btn" onclick="clearSettingInput('jswebapi-key-input')" title="æ¸…é™¤å†…å®¹" style="right: 10px;">Ã—</button>
                </div>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">é«˜å¾·åœ°å›¾Webç«¯JS API å®‰å…¨å¯†é’¥</label>
                <div class="setting-input-group">
                    <input id="safety-key-input" type="text" class="setting-input" placeholder="è¾“å…¥é«˜å¾·åœ°å›¾Webç«¯JS API å®‰å…¨å¯†é’¥">
                    <button class="clear-btn" onclick="clearSettingInput('safety-key-input')" title="æ¸…é™¤å†…å®¹" style="right: 10px;">Ã—</button>
                </div>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">å®¶åº­åœ°å€</label>
                <div class="setting-input-group">
                    <input id="home-input" type="text" class="setting-input" placeholder="è¾“å…¥å®¶åº­åœ°å€">
                    <button class="clear-btn" onclick="clearSettingInput('home-input')" title="æ¸…é™¤å†…å®¹" style="right: 10px;">Ã—</button>
                </div>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">å…¬å¸åœ°å€</label>
                <div class="setting-input-group">
                    <input id="company-input" type="text" class="setting-input" placeholder="è¾“å…¥å…¬å¸åœ°å€">
                    <button class="clear-btn" onclick="clearSettingInput('company-input')" title="æ¸…é™¤å†…å®¹" style="right: 10px;">Ã—</button>
                </div>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">æ”¶è—åœ°å€</label>
                <div class="setting-input-group">
                    <input id="favorite-input" type="text" class="setting-input" placeholder="è¾“å…¥æ”¶è—åœ°å€">
                    <button class="clear-btn" onclick="clearSettingInput('favorite-input')" title="æ¸…é™¤å†…å®¹" style="right: 10px;">Ã—</button>
                </div>
            </div>
            
            <button class="save-settings-btn" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
        </div>
    </div>

    <div class="container">
        <h1 style="text-align: center; color: #cccccc; margin-bottom: 15px; font-weight: 300; font-size: 24px;padding-top: 30px;">å…¬å…±äº¤é€šè·¯çº¿è§„åˆ’</h1>
        
        <div class="input-group">
            <div class="input-item" style="flex: 4;">
                <div class="input-item-prepend">
                    <span class="input-item-text">å‡ºå‘æ—¶é—´</span>
                </div>
                <div class="autocomplete-container">
                    <input id='departuretime' type="text" placeholder="ç°åœ¨å‡ºå‘">
                    <button class="clear-btn" onclick="clearDepartureTime()" title="æ¸…é™¤æ—¶é—´">Ã—</button>
                    <button class="autocomplete-dropdown" onclick="toggleTimeDropdown()" title="å¿«é€Ÿé€‰æ‹©æ—¶é—´">â–¼</button>
                    <div id="time-dropdown" class="dropdown-menu">
                        <div class="dropdown-item header">å¿«é€Ÿé€‰æ‹©</div>
                        <div class="dropdown-item" onclick="selectQuickTime('now')">ç°åœ¨å‡ºå‘</div>
                        <div class="dropdown-item" onclick="selectQuickTime('morning')">æ—©é«˜å³° (8:00)</div>
                        <div class="dropdown-item" onclick="selectQuickTime('noon')">ä¸­åˆ (12:00)</div>
                        <div class="dropdown-item" onclick="selectQuickTime('evening')">æ™šé«˜å³° (18:00)</div>
                        <div class="dropdown-item" onclick="selectQuickTime('night')">å¤œé—´ (22:00)</div>
                    </div>
                </div>
            </div>
            <div class="input-item" style="flex: 3;">
                <div class="input-item-prepend">
                    <span class="input-item-text">è·¯çº¿é€‰æ‹©ä¾æ®</span>
                </div>
                <div class="autocomplete-container">
                    <input id="policy-select" type="text" readonly value="é»˜è®¤" data-value="0">
                    <button class="autocomplete-dropdown" onclick="togglePolicyDropdown()" title="é€‰æ‹©è·¯çº¿ä¾æ®">â–¼</button>
                    <div id="policy-dropdown" class="dropdown-menu">
                        <div class="dropdown-item" onclick="selectPolicy('0', 'é»˜è®¤')">é»˜è®¤</div>
                        <div class="dropdown-item" onclick="selectPolicy('1', 'æœ€ç»æµ')">æœ€ç»æµ</div>
                        <div class="dropdown-item" onclick="selectPolicy('2', 'å°‘æ¢ä¹˜')">å°‘æ¢ä¹˜</div>
                        <div class="dropdown-item" onclick="selectPolicy('3', 'å°‘æ­¥è¡Œ')">å°‘æ­¥è¡Œ</div>
                        <div class="dropdown-item" onclick="selectPolicy('4', 'æœ€èˆ’é€‚')">æœ€èˆ’é€‚</div>
                        <div class="dropdown-item" onclick="selectPolicy('5', 'ä¸ä¹˜åœ°é“')">ä¸ä¹˜åœ°é“</div>
                        <div class="dropdown-item" onclick="selectPolicy('7', 'åœ°é“ä¼˜å…ˆ')">åœ°é“ä¼˜å…ˆ</div>
                        <div class="dropdown-item" onclick="selectPolicy('8', 'æ—¶é—´çŸ­')">æ—¶é—´çŸ­</div>
                    </div>
                </div>
            </div>
            <div class="swap-container">
                <button id="swap-btn" class="swap-btn" onclick="swapStartEnd()" title="äº¤æ¢èµ·ç»ˆç‚¹">â‡µ</button>
            </div>
        </div>
        <div class="input-group">
            <div class="input-item-wide">
                <div class="input-item-prepend">
                    <span class="input-item-text">å‡ºå‘åœ°</span>
                </div>
                <div class="autocomplete-container">
                    <input id='startinput' type="text" placeholder="è¾“å…¥å‡ºå‘åœ°åç§°">
                    <button class="clear-btn" onclick="clearInput('startinput')" title="æ¸…é™¤å†…å®¹">Ã—</button>
                    <button class="autocomplete-dropdown" onclick="toggleDropdown('start')" title="å†å²è®°å½•å’Œå¸¸ç”¨åœ°å€">â–¼</button>
                    <div id="start-dropdown" class="dropdown-menu">
						<div class="dropdown-item header">å¸¸ç”¨åœ°å€</div>
                        <div style="display: flex;justify-content: space-around;align-items: center;border-bottom: 1px solid #3e3e42;">
                            <div class="dropdown-item" onclick="selectFromDropdown('start', 'home')" style="border-bottom: 0px">ğŸ  å®¶</div>
                            <div class="dropdown-item" onclick="selectFromDropdown('start', 'company')" style="border-bottom: 0px">ğŸ¢ å…¬å¸</div>
                            <div class="dropdown-item" onclick="selectFromDropdown('start', 'favorite')" style="border-bottom: 0px">â­ æ”¶è—</div>
                        </div>
                        <div class="dropdown-item header">å†å²è®°å½•</div>
                        <div id="start-history"></div>
                    </div>
                </div>
            </div>
            <div class="swap-container">
                <button id="locate-btn" class="swap-btn" onclick="locateStart()" title="å®šä½åˆ°èµ·ç‚¹" style="font-size: 28px;">âŒ–</button>
            </div>
        </div>
        
        <div class="input-group">
            <div class="input-item-wide">
                <div class="input-item-prepend">
                    <span class="input-item-text">ç›®çš„åœ°</span>
                </div>
                <div class="autocomplete-container">
                    <input id='endinput' type="text" placeholder="è¾“å…¥ç›®çš„åœ°åç§°">
                    <button class="clear-btn" onclick="clearInput('endinput')" title="æ¸…é™¤å†…å®¹">Ã—</button>
                    <button class="autocomplete-dropdown" onclick="toggleDropdown('end')" title="å†å²è®°å½•å’Œå¸¸ç”¨åœ°å€">â–¼</button>
                    <div id="end-dropdown" class="dropdown-menu">
						<div class="dropdown-item header">å¸¸ç”¨åœ°å€</div>
                        <div style="display: flex;justify-content: space-around;align-items: center;border-bottom: 1px solid #3e3e42;">
                            <div class="dropdown-item" onclick="selectFromDropdown('end', 'home')" style="border-bottom: 0px">ğŸ  å®¶</div>
                            <div class="dropdown-item" onclick="selectFromDropdown('end', 'company')" style="border-bottom: 0px">ğŸ¢ å…¬å¸</div>
                            <div class="dropdown-item" onclick="selectFromDropdown('end', 'favorite')" style="border-bottom: 0px">â­ æ”¶è—</div>
                        </div>
                        <div class="dropdown-item header">å†å²è®°å½•</div>
                        <div id="end-history"></div>
                    </div>
                </div>
            </div>
            <div class="target-container">
                <button id="target-btn" class="swap-btn" onclick="locateTarget()" title="å®šä½åˆ°ç»ˆç‚¹" style="font-size: 22px;">â†—</button>
            </div>
        </div>
        <button id="search-btn" class="search-btn">è§„åˆ’è·¯çº¿</button>
        

        
        <div id="loading" class="loading hidden">
            æ­£åœ¨è§„åˆ’è·¯çº¿...
        </div>
        
        <div id="error" class="error hidden"></div>
        
        <div id="result" class="result-container hidden">
            <div class="result-title">è·¯çº¿æ–¹æ¡ˆ</div>
            <div id="routes-container"></div>
        </div>
    </div>  
    <!-- å¼•å…¥é«˜å¾·åœ°å›¾API -->
    <script type="text/javascript">
        // åˆå§‹åŒ–APIé…ç½®ä¸ºç©ºï¼Œä»localStorageåŠ è½½
        function initializeAPIConfig() {
            var savedWebApiKey = localStorage.getItem('webApiKey');
            var savedJSWebApiKey = localStorage.getItem('JSwebApiKey');
            var savedSafetyKey = localStorage.getItem('safetyKey');
            
            window.AMAP_CONFIG = {
                webApiKey: savedWebApiKey || '',
                JSwebApiKey: savedJSWebApiKey || '',
                safetyKey: savedSafetyKey || ''
            };
            
            // åªæœ‰åœ¨JSwebApiKeyå’ŒsafetyKeyéƒ½è¢«è®¾ç½®åï¼Œæ‰åŠ è½½é«˜å¾·åœ°å›¾API
            if (window.AMAP_CONFIG.JSwebApiKey && window.AMAP_CONFIG.safetyKey) {
                // è®¾ç½®é«˜å¾·åœ°å›¾å®‰å…¨å¯†é’¥ï¼ˆå¿…é¡»åœ¨åŠ è½½APIä¹‹å‰è®¾ç½®ï¼‰
                window._AMapSecurityConfig = {
                    securityJsCode: window.AMAP_CONFIG.safetyKey
                };
                
                // åŠ¨æ€åŠ è½½é«˜å¾·åœ°å›¾API
                document.write('<script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=' + window.AMAP_CONFIG.JSwebApiKey + '&plugin=AMap.PlaceSearch"><\/script>');
            }
        }
        
        // åˆå§‹åŒ–APIé…ç½®
        initializeAPIConfig();
    </script>
    
    <!-- å¼•å…¥åŸå¸‚ç¼–ç æ•°æ® -->
     
    
    <!-- åæ ‡è½¬æ¢å‡½æ•° -->
    
    <!-- åæ ‡è½¬æ¢å‡½æ•° -->
    

    <script type="text/javascript">
var citycode = ["[{\"cityname\":\"åŒ—äº¬å¸‚\",\"adcode\":110000,\"citycode\":\"010\"},{\"cityname\":\"å¹¿å·å¸‚\",\"adcode\":440100,\"citycode\":\"020\"},{\"cityname\":\"ä¸Šæµ·å¸‚\",\"adcode\":310000,\"citycode\":\"021\"},{\"cityname\":\"å¤©æ´¥å¸‚\",\"adcode\":120000,\"citycode\":\"022\"},{\"cityname\":\"é‡åº†å¸‚\",\"adcode\":500000,\"citycode\":\"023\"},{\"cityname\":\"æ²ˆé˜³å¸‚\",\"adcode\":210100,\"citycode\":\"024\"},{\"cityname\":\"å—äº¬å¸‚\",\"adcode\":320100,\"citycode\":\"025\"},{\"cityname\":\"æ­¦æ±‰å¸‚\",\"adcode\":420100,\"citycode\":\"027\"},{\"cityname\":\"æˆéƒ½å¸‚\",\"adcode\":510100,\"citycode\":\"028\"},{\"cityname\":\"è¥¿å®‰å¸‚\",\"adcode\":610100,\"citycode\":\"029\"},{\"cityname\":\"é‚¯éƒ¸å¸‚\",\"adcode\":130400,\"citycode\":\"0310\"},{\"cityname\":\"çŸ³å®¶åº„å¸‚\",\"adcode\":130100,\"citycode\":\"0311\"},{\"cityname\":\"ä¿å®šå¸‚\",\"adcode\":130600,\"citycode\":\"0312\"},{\"cityname\":\"å¼ å®¶å£å¸‚\",\"adcode\":130700,\"citycode\":\"0313\"},{\"cityname\":\"æ‰¿å¾·å¸‚\",\"adcode\":130800,\"citycode\":\"0314\"},{\"cityname\":\"å”å±±å¸‚\",\"adcode\":130200,\"citycode\":\"0315\"},{\"cityname\":\"å»ŠåŠå¸‚\",\"adcode\":131000,\"citycode\":\"0316\"},{\"cityname\":\"æ²§å·å¸‚\",\"adcode\":130900,\"citycode\":\"0317\"},{\"cityname\":\"è¡¡æ°´å¸‚\",\"adcode\":131100,\"citycode\":\"0318\"},{\"cityname\":\"é‚¢å°å¸‚\",\"adcode\":130500,\"citycode\":\"0319\"},{\"cityname\":\"ç§¦çš‡å²›å¸‚\",\"adcode\":130300,\"citycode\":\"0335\"},{\"cityname\":\"æœ”å·å¸‚\",\"adcode\":140600,\"citycode\":\"0349\"},{\"cityname\":\"å¿»å·å¸‚\",\"adcode\":140900,\"citycode\":\"0350\"},{\"cityname\":\"å¤ªåŸå¸‚\",\"adcode\":140100,\"citycode\":\"0351\"},{\"cityname\":\"å¤§åŒå¸‚\",\"adcode\":140200,\"citycode\":\"0352\"},{\"cityname\":\"é˜³æ³‰å¸‚\",\"adcode\":140300,\"citycode\":\"0353\"},{\"cityname\":\"æ™‹ä¸­å¸‚\",\"adcode\":140700,\"citycode\":\"0354\"},{\"cityname\":\"é•¿æ²»å¸‚\",\"adcode\":140400,\"citycode\":\"0355\"},{\"cityname\":\"æ™‹åŸå¸‚\",\"adcode\":140500,\"citycode\":\"0356\"},{\"cityname\":\"ä¸´æ±¾å¸‚\",\"adcode\":141000,\"citycode\":\"0357\"},{\"cityname\":\"å•æ¢å¸‚\",\"adcode\":141100,\"citycode\":\"0358\"},{\"cityname\":\"è¿åŸå¸‚\",\"adcode\":140800,\"citycode\":\"0359\"},{\"cityname\":\"å•†ä¸˜å¸‚\",\"adcode\":411400,\"citycode\":\"0370\"},{\"cityname\":\"éƒ‘å·å¸‚\",\"adcode\":410100,\"citycode\":\"0371\"},{\"cityname\":\"å®‰é˜³å¸‚\",\"adcode\":410500,\"citycode\":\"0372\"},{\"cityname\":\"æ–°ä¹¡å¸‚\",\"adcode\":410700,\"citycode\":\"0373\"},{\"cityname\":\"è®¸æ˜Œå¸‚\",\"adcode\":411000,\"citycode\":\"0374\"},{\"cityname\":\"å¹³é¡¶å±±å¸‚\",\"adcode\":410400,\"citycode\":\"0375\"},{\"cityname\":\"ä¿¡é˜³å¸‚\",\"adcode\":411500,\"citycode\":\"0376\"},{\"cityname\":\"å—é˜³å¸‚\",\"adcode\":411300,\"citycode\":\"0377\"},{\"cityname\":\"å¼€å°å¸‚\",\"adcode\":410200,\"citycode\":\"0378\"},{\"cityname\":\"æ´›é˜³å¸‚\",\"adcode\":410300,\"citycode\":\"0379\"},{\"cityname\":\"ç„¦ä½œå¸‚\",\"adcode\":410800,\"citycode\":\"0391\"},{\"cityname\":\"é¹¤å£å¸‚\",\"adcode\":410600,\"citycode\":\"0392\"},{\"cityname\":\"æ¿®é˜³å¸‚\",\"adcode\":410900,\"citycode\":\"0393\"},{\"cityname\":\"å‘¨å£å¸‚\",\"adcode\":411600,\"citycode\":\"0394\"},{\"cityname\":\"æ¼¯æ²³å¸‚\",\"adcode\":411100,\"citycode\":\"0395\"},{\"cityname\":\"é©»é©¬åº—å¸‚\",\"adcode\":411700,\"citycode\":\"0396\"},{\"cityname\":\"ä¸‰é—¨å³¡å¸‚\",\"adcode\":411200,\"citycode\":\"0398\"},{\"cityname\":\"é“å²­å¸‚\",\"adcode\":211200,\"citycode\":\"0410\"},{\"cityname\":\"å¤§è¿å¸‚\",\"adcode\":210200,\"citycode\":\"0411\"},{\"cityname\":\"éå±±å¸‚\",\"adcode\":210300,\"citycode\":\"0412\"},{\"cityname\":\"æŠšé¡ºå¸‚\",\"adcode\":210400,\"citycode\":\"0413\"},{\"cityname\":\"æœ¬æºªå¸‚\",\"adcode\":210500,\"citycode\":\"0414\"},{\"cityname\":\"ä¸¹ä¸œå¸‚\",\"adcode\":210600,\"citycode\":\"0415\"},{\"cityname\":\"é”¦å·å¸‚\",\"adcode\":210700,\"citycode\":\"0416\"},{\"cityname\":\"è¥å£å¸‚\",\"adcode\":210800,\"citycode\":\"0417\"},{\"cityname\":\"é˜œæ–°å¸‚\",\"adcode\":210900,\"citycode\":\"0418\"},{\"cityname\":\"è¾½é˜³å¸‚\",\"adcode\":211000,\"citycode\":\"0419\"},{\"cityname\":\"æœé˜³å¸‚\",\"adcode\":211300,\"citycode\":\"0421\"},{\"cityname\":\"ç›˜é”¦å¸‚\",\"adcode\":211100,\"citycode\":\"0427\"},{\"cityname\":\"è‘«èŠ¦å²›å¸‚\",\"adcode\":211400,\"citycode\":\"0429\"},{\"cityname\":\"é•¿æ˜¥å¸‚\",\"adcode\":220100,\"citycode\":\"0431\"},{\"cityname\":\"å‰æ—å¸‚\",\"adcode\":220200,\"citycode\":\"0432\"},{\"cityname\":\"å››å¹³å¸‚\",\"adcode\":220300,\"citycode\":\"0434\"},{\"cityname\":\"é€šåŒ–å¸‚\",\"adcode\":220500,\"citycode\":\"0435\"},{\"cityname\":\"ç™½åŸå¸‚\",\"adcode\":220800,\"citycode\":\"0436\"},{\"cityname\":\"è¾½æºå¸‚\",\"adcode\":220400,\"citycode\":\"0437\"},{\"cityname\":\"æ¾åŸå¸‚\",\"adcode\":220700,\"citycode\":\"0438\"},{\"cityname\":\"ç™½å±±å¸‚\",\"adcode\":220600,\"citycode\":\"0439\"},{\"cityname\":\"å“ˆå°”æ»¨å¸‚\",\"adcode\":230100,\"citycode\":\"0451\"},{\"cityname\":\"é½é½å“ˆå°”å¸‚\",\"adcode\":230200,\"citycode\":\"0452\"},{\"cityname\":\"ç‰¡ä¸¹æ±Ÿå¸‚\",\"adcode\":231000,\"citycode\":\"0453\"},{\"cityname\":\"ä½³æœ¨æ–¯å¸‚\",\"adcode\":230800,\"citycode\":\"0454\"},{\"cityname\":\"ç»¥åŒ–å¸‚\",\"adcode\":231200,\"citycode\":\"0455\"},{\"cityname\":\"é»‘æ²³å¸‚\",\"adcode\":231100,\"citycode\":\"0456\"},{\"cityname\":\"å¤§å…´å®‰å²­åœ°åŒº\",\"adcode\":232700,\"citycode\":\"0457\"},{\"cityname\":\"ä¼Šæ˜¥å¸‚\",\"adcode\":230700,\"citycode\":\"0458\"},{\"cityname\":\"å¤§åº†å¸‚\",\"adcode\":230600,\"citycode\":\"0459\"},{\"cityname\":\"ä¸ƒå°æ²³å¸‚\",\"adcode\":230900,\"citycode\":\"0464\"},{\"cityname\":\"é¸¡è¥¿å¸‚\",\"adcode\":230300,\"citycode\":\"0467\"},{\"cityname\":\"é¹¤å²—å¸‚\",\"adcode\":230400,\"citycode\":\"0468\"},{\"cityname\":\"åŒé¸­å±±å¸‚\",\"adcode\":230500,\"citycode\":\"0469\"},{\"cityname\":\"å‘¼ä¼¦è´å°”å¸‚\",\"adcode\":150700,\"citycode\":\"0470\"},{\"cityname\":\"å‘¼å’Œæµ©ç‰¹å¸‚\",\"adcode\":150100,\"citycode\":\"0471\"},{\"cityname\":\"åŒ…å¤´å¸‚\",\"adcode\":150200,\"citycode\":\"0472\"},{\"cityname\":\"ä¹Œæµ·å¸‚\",\"adcode\":150300,\"citycode\":\"0473\"},{\"cityname\":\"ä¹Œå…°å¯Ÿå¸ƒå¸‚\",\"adcode\":150900,\"citycode\":\"0474\"},{\"cityname\":\"é€šè¾½å¸‚\",\"adcode\":150500,\"citycode\":\"0475\"},{\"cityname\":\"èµ¤å³°å¸‚\",\"adcode\":150400,\"citycode\":\"0476\"},{\"cityname\":\"é„‚å°”å¤šæ–¯å¸‚\",\"adcode\":150600,\"citycode\":\"0477\"},{\"cityname\":\"å·´å½¦æ·–å°”å¸‚\",\"adcode\":150800,\"citycode\":\"0478\"},{\"cityname\":\"é”¡æ—éƒ­å‹’ç›Ÿ\",\"adcode\":152500,\"citycode\":\"0479\"},{\"cityname\":\"å…´å®‰ç›Ÿ\",\"adcode\":152200,\"citycode\":\"0482\"},{\"cityname\":\"é˜¿æ‹‰å–„ç›Ÿ\",\"adcode\":152900,\"citycode\":\"0483\"},{\"cityname\":\"æ— é”¡å¸‚\",\"adcode\":320200,\"citycode\":\"0510\"},{\"cityname\":\"é•‡æ±Ÿå¸‚\",\"adcode\":321100,\"citycode\":\"0511\"},{\"cityname\":\"è‹å·å¸‚\",\"adcode\":320500,\"citycode\":\"0512\"},{\"cityname\":\"å—é€šå¸‚\",\"adcode\":320600,\"citycode\":\"0513\"},{\"cityname\":\"æ‰¬å·å¸‚\",\"adcode\":321000,\"citycode\":\"0514\"},{\"cityname\":\"ç›åŸå¸‚\",\"adcode\":320900,\"citycode\":\"0515\"},{\"cityname\":\"å¾å·å¸‚\",\"adcode\":320300,\"citycode\":\"0516\"},{\"cityname\":\"æ·®å®‰å¸‚\",\"adcode\":320800,\"citycode\":\"0517\"},{\"cityname\":\"è¿äº‘æ¸¯å¸‚\",\"adcode\":320700,\"citycode\":\"0518\"},{\"cityname\":\"å¸¸å·å¸‚\",\"adcode\":320400,\"citycode\":\"0519\"},{\"cityname\":\"æ³°å·å¸‚\",\"adcode\":321200,\"citycode\":\"0523\"},{\"cityname\":\"å®¿è¿å¸‚\",\"adcode\":321300,\"citycode\":\"0527\"},{\"cityname\":\"èæ³½å¸‚\",\"adcode\":371700,\"citycode\":\"0530\"},{\"cityname\":\"æµå—å¸‚\",\"adcode\":370100,\"citycode\":\"0531\"},{\"cityname\":\"é’å²›å¸‚\",\"adcode\":370200,\"citycode\":\"0532\"},{\"cityname\":\"æ·„åšå¸‚\",\"adcode\":370300,\"citycode\":\"0533\"},{\"cityname\":\"å¾·å·å¸‚\",\"adcode\":371400,\"citycode\":\"0534\"},{\"cityname\":\"çƒŸå°å¸‚\",\"adcode\":370600,\"citycode\":\"0535\"},{\"cityname\":\"æ½åŠå¸‚\",\"adcode\":370700,\"citycode\":\"0536\"},{\"cityname\":\"æµå®å¸‚\",\"adcode\":370800,\"citycode\":\"0537\"},{\"cityname\":\"æ³°å®‰å¸‚\",\"adcode\":370900,\"citycode\":\"0538\"},{\"cityname\":\"ä¸´æ²‚å¸‚\",\"adcode\":371300,\"citycode\":\"0539\"},{\"cityname\":\"æ»¨å·å¸‚\",\"adcode\":371600,\"citycode\":\"0543\"},{\"cityname\":\"ä¸œè¥å¸‚\",\"adcode\":370500,\"citycode\":\"0546\"},{\"cityname\":\"æ»å·å¸‚\",\"adcode\":341100,\"citycode\":\"0550\"},{\"cityname\":\"åˆè‚¥å¸‚\",\"adcode\":340100,\"citycode\":\"0551\"},{\"cityname\":\"èšŒåŸ å¸‚\",\"adcode\":340300,\"citycode\":\"0552\"},{\"cityname\":\"èŠœæ¹–å¸‚\",\"adcode\":340200,\"citycode\":\"0553\"},{\"cityname\":\"æ·®å—å¸‚\",\"adcode\":340400,\"citycode\":\"0554\"},{\"cityname\":\"é©¬éå±±å¸‚\",\"adcode\":340500,\"citycode\":\"0555\"},{\"cityname\":\"å®‰åº†å¸‚\",\"adcode\":340800,\"citycode\":\"0556\"},{\"cityname\":\"å®¿å·å¸‚\",\"adcode\":341300,\"citycode\":\"0557\"},{\"cityname\":\"äº³å·å¸‚\",\"adcode\":341600,\"citycode\":\"0558\"},{\"cityname\":\"é»„å±±å¸‚\",\"adcode\":341000,\"citycode\":\"0559\"},{\"cityname\":\"æ·®åŒ—å¸‚\",\"adcode\":340600,\"citycode\":\"0561\"},{\"cityname\":\"é“œé™µå¸‚\",\"adcode\":340700,\"citycode\":\"0562\"},{\"cityname\":\"å®£åŸå¸‚\",\"adcode\":341800,\"citycode\":\"0563\"},{\"cityname\":\"å…­å®‰å¸‚\",\"adcode\":341500,\"citycode\":\"0564\"},{\"cityname\":\"æ± å·å¸‚\",\"adcode\":341700,\"citycode\":\"0566\"},{\"cityname\":\"è¡¢å·å¸‚\",\"adcode\":330800,\"citycode\":\"0570\"},{\"cityname\":\"æ­å·å¸‚\",\"adcode\":330100,\"citycode\":\"0571\"},{\"cityname\":\"æ¹–å·å¸‚\",\"adcode\":330500,\"citycode\":\"0572\"},{\"cityname\":\"å˜‰å…´å¸‚\",\"adcode\":330400,\"citycode\":\"0573\"},{\"cityname\":\"å®æ³¢å¸‚\",\"adcode\":330200,\"citycode\":\"0574\"},{\"cityname\":\"ç»å…´å¸‚\",\"adcode\":330600,\"citycode\":\"0575\"},{\"cityname\":\"å°å·å¸‚\",\"adcode\":331000,\"citycode\":\"0576\"},{\"cityname\":\"æ¸©å·å¸‚\",\"adcode\":330300,\"citycode\":\"0577\"},{\"cityname\":\"ä¸½æ°´å¸‚\",\"adcode\":331100,\"citycode\":\"0578\"},{\"cityname\":\"é‡‘åå¸‚\",\"adcode\":330700,\"citycode\":\"0579\"},{\"cityname\":\"èˆŸå±±å¸‚\",\"adcode\":330900,\"citycode\":\"0580\"},{\"cityname\":\"ç¦å·å¸‚\",\"adcode\":350100,\"citycode\":\"0591\"},{\"cityname\":\"å¦é—¨å¸‚\",\"adcode\":350200,\"citycode\":\"0592\"},{\"cityname\":\"å®å¾·å¸‚\",\"adcode\":350900,\"citycode\":\"0593\"},{\"cityname\":\"è†ç”°å¸‚\",\"adcode\":350300,\"citycode\":\"0594\"},{\"cityname\":\"æ³‰å·å¸‚\",\"adcode\":350500,\"citycode\":\"0595\"},{\"cityname\":\"æ¼³å·å¸‚\",\"adcode\":350600,\"citycode\":\"0596\"},{\"cityname\":\"é¾™å²©å¸‚\",\"adcode\":350800,\"citycode\":\"0597\"},{\"cityname\":\"ä¸‰æ˜å¸‚\",\"adcode\":350400,\"citycode\":\"0598\"},{\"cityname\":\"å—å¹³å¸‚\",\"adcode\":350700,\"citycode\":\"0599\"},{\"cityname\":\"å¨æµ·å¸‚\",\"adcode\":371000,\"citycode\":\"0631\"},{\"cityname\":\"æ£åº„å¸‚\",\"adcode\":370400,\"citycode\":\"0632\"},{\"cityname\":\"æ—¥ç…§å¸‚\",\"adcode\":371100,\"citycode\":\"0633\"},{\"cityname\":\"èŠåŸå¸‚\",\"adcode\":371500,\"citycode\":\"0635\"},{\"cityname\":\"æ±•å°¾å¸‚\",\"adcode\":441500,\"citycode\":\"0660\"},{\"cityname\":\"é˜³æ±Ÿå¸‚\",\"adcode\":441700,\"citycode\":\"0662\"},{\"cityname\":\"æ­é˜³å¸‚\",\"adcode\":445200,\"citycode\":\"0663\"},{\"cityname\":\"èŒ‚åå¸‚\",\"adcode\":440900,\"citycode\":\"0668\"},{\"cityname\":\"è¥¿åŒç‰ˆçº³å‚£æ—è‡ªæ²»å·\",\"adcode\":532800,\"citycode\":\"0691\"},{\"cityname\":\"å¾·å®å‚£æ—æ™¯é¢‡æ—è‡ªæ²»å·\",\"adcode\":533100,\"citycode\":\"0692\"},{\"cityname\":\"é¹°æ½­å¸‚\",\"adcode\":360600,\"citycode\":\"0701\"},{\"cityname\":\"è¥„é˜³å¸‚\",\"adcode\":420600,\"citycode\":\"0710\"},{\"cityname\":\"é„‚å·å¸‚\",\"adcode\":420700,\"citycode\":\"0711\"},{\"cityname\":\"å­æ„Ÿå¸‚\",\"adcode\":420900,\"citycode\":\"0712\"},{\"cityname\":\"é»„å†ˆå¸‚\",\"adcode\":421100,\"citycode\":\"0713\"},{\"cityname\":\"é»„çŸ³å¸‚\",\"adcode\":420200,\"citycode\":\"0714\"},{\"cityname\":\"å’¸å®å¸‚\",\"adcode\":421200,\"citycode\":\"0715\"},{\"cityname\":\"è†å·å¸‚\",\"adcode\":421000,\"citycode\":\"0716\"},{\"cityname\":\"å®œæ˜Œå¸‚\",\"adcode\":420500,\"citycode\":\"0717\"},{\"cityname\":\"æ©æ–½åœŸå®¶æ—è‹—æ—è‡ªæ²»å·\",\"adcode\":422800,\"citycode\":\"0718\"},{\"cityname\":\"åå °å¸‚\",\"adcode\":420300,\"citycode\":\"0719\"},{\"cityname\":\"éšå·å¸‚\",\"adcode\":421300,\"citycode\":\"0722\"},{\"cityname\":\"è†é—¨å¸‚\",\"adcode\":420800,\"citycode\":\"0724\"},{\"cityname\":\"ä»™æ¡ƒå¸‚\",\"adcode\":429004,\"citycode\":\"0728\"},{\"cityname\":\"å²³é˜³å¸‚\",\"adcode\":430600,\"citycode\":\"0730\"},{\"cityname\":\"é•¿æ²™å¸‚\",\"adcode\":430100,\"citycode\":\"0731\"},{\"cityname\":\"æ¹˜æ½­å¸‚\",\"adcode\":430300,\"citycode\":\"0732\"},{\"cityname\":\"æ ªæ´²å¸‚\",\"adcode\":430200,\"citycode\":\"0733\"},{\"cityname\":\"è¡¡é˜³å¸‚\",\"adcode\":430400,\"citycode\":\"0734\"},{\"cityname\":\"éƒ´å·å¸‚\",\"adcode\":431000,\"citycode\":\"0735\"},{\"cityname\":\"å¸¸å¾·å¸‚\",\"adcode\":430700,\"citycode\":\"0736\"},{\"cityname\":\"ç›Šé˜³å¸‚\",\"adcode\":430900,\"citycode\":\"0737\"},{\"cityname\":\"å¨„åº•å¸‚\",\"adcode\":431300,\"citycode\":\"0738\"},{\"cityname\":\"é‚µé˜³å¸‚\",\"adcode\":430500,\"citycode\":\"0739\"},{\"cityname\":\"æ¹˜è¥¿åœŸå®¶æ—è‹—æ—è‡ªæ²»å·\",\"adcode\":433100,\"citycode\":\"0743\"},{\"cityname\":\"å¼ å®¶ç•Œå¸‚\",\"adcode\":430800,\"citycode\":\"0744\"},{\"cityname\":\"æ€€åŒ–å¸‚\",\"adcode\":431200,\"citycode\":\"0745\"},{\"cityname\":\"æ°¸å·å¸‚\",\"adcode\":431100,\"citycode\":\"0746\"},{\"cityname\":\"æ±Ÿé—¨å¸‚\",\"adcode\":440700,\"citycode\":\"0750\"},{\"cityname\":\"éŸ¶å…³å¸‚\",\"adcode\":440200,\"citycode\":\"0751\"},{\"cityname\":\"æƒ å·å¸‚\",\"adcode\":441300,\"citycode\":\"0752\"},{\"cityname\":\"æ¢…å·å¸‚\",\"adcode\":441400,\"citycode\":\"0753\"},{\"cityname\":\"æ±•å¤´å¸‚\",\"adcode\":440500,\"citycode\":\"0754\"},{\"cityname\":\"æ·±åœ³å¸‚\",\"adcode\":440300,\"citycode\":\"0755\"},{\"cityname\":\"ç æµ·å¸‚\",\"adcode\":440400,\"citycode\":\"0756\"},{\"cityname\":\"ä½›å±±å¸‚\",\"adcode\":440600,\"citycode\":\"0757\"},{\"cityname\":\"è‚‡åº†å¸‚\",\"adcode\":441200,\"citycode\":\"0758\"},{\"cityname\":\"æ¹›æ±Ÿå¸‚\",\"adcode\":440800,\"citycode\":\"0759\"},{\"cityname\":\"ä¸­å±±å¸‚\",\"adcode\":442000,\"citycode\":\"0760\"},{\"cityname\":\"æ²³æºå¸‚\",\"adcode\":441600,\"citycode\":\"0762\"},{\"cityname\":\"æ¸…è¿œå¸‚\",\"adcode\":441800,\"citycode\":\"0763\"},{\"cityname\":\"äº‘æµ®å¸‚\",\"adcode\":445300,\"citycode\":\"0766\"},{\"cityname\":\"æ½®å·å¸‚\",\"adcode\":445100,\"citycode\":\"0768\"},{\"cityname\":\"ä¸œèå¸‚\",\"adcode\":441900,\"citycode\":\"0769\"},{\"cityname\":\"é˜²åŸæ¸¯å¸‚\",\"adcode\":450600,\"citycode\":\"0770\"},{\"cityname\":\"å—å®å¸‚\",\"adcode\":450100,\"citycode\":\"0771\"},{\"cityname\":\"æŸ³å·å¸‚\",\"adcode\":450200,\"citycode\":\"0772\"},{\"cityname\":\"æ¡‚æ—å¸‚\",\"adcode\":450300,\"citycode\":\"0773\"},{\"cityname\":\"æ¢§å·å¸‚\",\"adcode\":450400,\"citycode\":\"0774\"},{\"cityname\":\"ç‰æ—å¸‚\",\"adcode\":450900,\"citycode\":\"0775\"},{\"cityname\":\"ç™¾è‰²å¸‚\",\"adcode\":451000,\"citycode\":\"0776\"},{\"cityname\":\"é’¦å·å¸‚\",\"adcode\":450700,\"citycode\":\"0777\"},{\"cityname\":\"æ²³æ± å¸‚\",\"adcode\":451200,\"citycode\":\"0778\"},{\"cityname\":\"åŒ—æµ·å¸‚\",\"adcode\":450500,\"citycode\":\"0779\"},{\"cityname\":\"æ–°ä½™å¸‚\",\"adcode\":360500,\"citycode\":\"0790\"},{\"cityname\":\"å—æ˜Œå¸‚\",\"adcode\":360100,\"citycode\":\"0791\"},{\"cityname\":\"ä¹æ±Ÿå¸‚\",\"adcode\":360400,\"citycode\":\"0792\"},{\"cityname\":\"ä¸Šé¥¶å¸‚\",\"adcode\":361100,\"citycode\":\"0793\"},{\"cityname\":\"æŠšå·å¸‚\",\"adcode\":361000,\"citycode\":\"0794\"},{\"cityname\":\"å®œæ˜¥å¸‚\",\"adcode\":360900,\"citycode\":\"0795\"},{\"cityname\":\"å‰å®‰å¸‚\",\"adcode\":360800,\"citycode\":\"0796\"},{\"cityname\":\"èµ£å·å¸‚\",\"adcode\":360700,\"citycode\":\"0797\"},{\"cityname\":\"æ™¯å¾·é•‡å¸‚\",\"adcode\":360200,\"citycode\":\"0798\"},{\"cityname\":\"èä¹¡å¸‚\",\"adcode\":360300,\"citycode\":\"0799\"},{\"cityname\":\"ä¿äº­é»æ—è‹—æ—è‡ªæ²»å¿\",\"adcode\":469029,\"citycode\":\"0801\"},{\"cityname\":\"ç™½æ²™é»æ—è‡ªæ²»å¿\",\"adcode\":469025,\"citycode\":\"0802\"},{\"cityname\":\"æ˜Œæ±Ÿé»æ—è‡ªæ²»å¿\",\"adcode\":469026,\"citycode\":\"0803\"},{\"cityname\":\"æ¾„è¿ˆå¿\",\"adcode\":469023,\"citycode\":\"0804\"},{\"cityname\":\"å„‹å·å¸‚\",\"adcode\":460400,\"citycode\":\"0805\"},{\"cityname\":\"å®šå®‰å¿\",\"adcode\":469021,\"citycode\":\"0806\"},{\"cityname\":\"ä¸œæ–¹å¸‚\",\"adcode\":469007,\"citycode\":\"0807\"},{\"cityname\":\"é™µæ°´é»æ—è‡ªæ²»å¿\",\"adcode\":469028,\"citycode\":\"0809\"},{\"cityname\":\"æ”€æèŠ±å¸‚\",\"adcode\":510400,\"citycode\":\"0812\"},{\"cityname\":\"è‡ªè´¡å¸‚\",\"adcode\":510300,\"citycode\":\"0813\"},{\"cityname\":\"ç»µé˜³å¸‚\",\"adcode\":510700,\"citycode\":\"0816\"},{\"cityname\":\"å—å……å¸‚\",\"adcode\":511300,\"citycode\":\"0817\"},{\"cityname\":\"è¾¾å·å¸‚\",\"adcode\":511700,\"citycode\":\"0818\"},{\"cityname\":\"é‚å®å¸‚\",\"adcode\":510900,\"citycode\":\"0825\"},{\"cityname\":\"å¹¿å®‰å¸‚\",\"adcode\":511600,\"citycode\":\"0826\"},{\"cityname\":\"å·´ä¸­å¸‚\",\"adcode\":511900,\"citycode\":\"0827\"},{\"cityname\":\"æ³¸å·å¸‚\",\"adcode\":510500,\"citycode\":\"0830\"},{\"cityname\":\"å®œå®¾å¸‚\",\"adcode\":511500,\"citycode\":\"0831\"},{\"cityname\":\"èµ„é˜³å¸‚\",\"adcode\":512000,\"citycode\":\"0832\"},{\"cityname\":\"ä¹å±±å¸‚\",\"adcode\":511100,\"citycode\":\"0833\"},{\"cityname\":\"å‡‰å±±å½æ—è‡ªæ²»å·\",\"adcode\":513400,\"citycode\":\"0834\"},{\"cityname\":\"é›…å®‰å¸‚\",\"adcode\":511800,\"citycode\":\"0835\"},{\"cityname\":\"ç”˜å­œè—æ—è‡ªæ²»å·\",\"adcode\":513300,\"citycode\":\"0836\"},{\"cityname\":\"é˜¿åè—æ—ç¾Œæ—è‡ªæ²»å·\",\"adcode\":513200,\"citycode\":\"0837\"},{\"cityname\":\"å¾·é˜³å¸‚\",\"adcode\":510600,\"citycode\":\"0838\"},{\"cityname\":\"å¹¿å…ƒå¸‚\",\"adcode\":510800,\"citycode\":\"0839\"},{\"cityname\":\"è´µé˜³å¸‚\",\"adcode\":520100,\"citycode\":\"0851\"},{\"cityname\":\"éµä¹‰å¸‚\",\"adcode\":520300,\"citycode\":\"0852\"},{\"cityname\":\"å®‰é¡ºå¸‚\",\"adcode\":520400,\"citycode\":\"0853\"},{\"cityname\":\"é»”å—å¸ƒä¾æ—è‹—æ—è‡ªæ²»å·\",\"adcode\":522700,\"citycode\":\"0854\"},{\"cityname\":\"é»”ä¸œå—è‹—æ—ä¾—æ—è‡ªæ²»å·\",\"adcode\":522600,\"citycode\":\"0855\"},{\"cityname\":\"é“œä»å¸‚\",\"adcode\":520600,\"citycode\":\"0856\"},{\"cityname\":\"æ¯•èŠ‚å¸‚\",\"adcode\":520500,\"citycode\":\"0857\"},{\"cityname\":\"å…­ç›˜æ°´å¸‚\",\"adcode\":520200,\"citycode\":\"0858\"},{\"cityname\":\"é»”è¥¿å—å¸ƒä¾æ—è‹—æ—è‡ªæ²»å·\",\"adcode\":522300,\"citycode\":\"0859\"},{\"cityname\":\"æ˜­é€šå¸‚\",\"adcode\":530600,\"citycode\":\"0870\"},{\"cityname\":\"æ˜†æ˜å¸‚\",\"adcode\":530100,\"citycode\":\"0871\"},{\"cityname\":\"å¤§ç†ç™½æ—è‡ªæ²»å·\",\"adcode\":532900,\"citycode\":\"0872\"},{\"cityname\":\"çº¢æ²³å“ˆå°¼æ—å½æ—è‡ªæ²»å·\",\"adcode\":532500,\"citycode\":\"0873\"},{\"cityname\":\"æ›²é–å¸‚\",\"adcode\":530300,\"citycode\":\"0874\"},{\"cityname\":\"ä¿å±±å¸‚\",\"adcode\":530500,\"citycode\":\"0875\"},{\"cityname\":\"æ–‡å±±å£®æ—è‹—æ—è‡ªæ²»å·\",\"adcode\":532600,\"citycode\":\"0876\"},{\"cityname\":\"ç‰æºªå¸‚\",\"adcode\":530400,\"citycode\":\"0877\"},{\"cityname\":\"æ¥šé›„å½æ—è‡ªæ²»å·\",\"adcode\":532300,\"citycode\":\"0878\"},{\"cityname\":\"æ™®æ´±å¸‚\",\"adcode\":530800,\"citycode\":\"0879\"},{\"cityname\":\"ä¸´æ²§å¸‚\",\"adcode\":530900,\"citycode\":\"0883\"},{\"cityname\":\"æ€’æ±Ÿå‚ˆåƒ³æ—è‡ªæ²»å·\",\"adcode\":533300,\"citycode\":\"0886\"},{\"cityname\":\"è¿ªåº†è—æ—è‡ªæ²»å·\",\"adcode\":533400,\"citycode\":\"0887\"},{\"cityname\":\"ä¸½æ±Ÿå¸‚\",\"adcode\":530700,\"citycode\":\"0888\"},{\"cityname\":\"æ‹‰è¨å¸‚\",\"adcode\":540100,\"citycode\":\"0891\"},{\"cityname\":\"æ—¥å–€åˆ™å¸‚\",\"adcode\":540200,\"citycode\":\"0892\"},{\"cityname\":\"å±±å—å¸‚\",\"adcode\":540500,\"citycode\":\"0893\"},{\"cityname\":\"æ—èŠå¸‚\",\"adcode\":540400,\"citycode\":\"0894\"},{\"cityname\":\"æ˜Œéƒ½å¸‚\",\"adcode\":540300,\"citycode\":\"0895\"},{\"cityname\":\"é‚£æ›²å¸‚\",\"adcode\":540600,\"citycode\":\"0896\"},{\"cityname\":\"é˜¿é‡Œåœ°åŒº\",\"adcode\":542500,\"citycode\":\"0897\"},{\"cityname\":\"æµ·å£å¸‚\",\"adcode\":460100,\"citycode\":\"0898\"},{\"cityname\":\"ä¸‰äºšå¸‚\",\"adcode\":460200,\"citycode\":\"0899\"},{\"cityname\":\"å¡”åŸåœ°åŒº\",\"adcode\":654200,\"citycode\":\"0901\"},{\"cityname\":\"å“ˆå¯†å¸‚\",\"adcode\":650500,\"citycode\":\"0902\"},{\"cityname\":\"å’Œç”°åœ°åŒº\",\"adcode\":653200,\"citycode\":\"0903\"},{\"cityname\":\"é˜¿å‹’æ³°åœ°åŒº\",\"adcode\":654300,\"citycode\":\"0906\"},{\"cityname\":\"å…‹å­œå‹’è‹æŸ¯å°”å…‹å­œè‡ªæ²»å·\",\"adcode\":653000,\"citycode\":\"0908\"},{\"cityname\":\"åšå°”å¡”æ‹‰è’™å¤è‡ªæ²»å·\",\"adcode\":652700,\"citycode\":\"0909\"},{\"cityname\":\"å’¸é˜³å¸‚\",\"adcode\":610400,\"citycode\":\"0910\"},{\"cityname\":\"å»¶å®‰å¸‚\",\"adcode\":610600,\"citycode\":\"0911\"},{\"cityname\":\"æ¦†æ—å¸‚\",\"adcode\":610800,\"citycode\":\"0912\"},{\"cityname\":\"æ¸­å—å¸‚\",\"adcode\":610500,\"citycode\":\"0913\"},{\"cityname\":\"å•†æ´›å¸‚\",\"adcode\":611000,\"citycode\":\"0914\"},{\"cityname\":\"å®‰åº·å¸‚\",\"adcode\":610900,\"citycode\":\"0915\"},{\"cityname\":\"æ±‰ä¸­å¸‚\",\"adcode\":610700,\"citycode\":\"0916\"},{\"cityname\":\"å®é¸¡å¸‚\",\"adcode\":610300,\"citycode\":\"0917\"},{\"cityname\":\"é“œå·å¸‚\",\"adcode\":610200,\"citycode\":\"0919\"},{\"cityname\":\"ä¸´å¤å›æ—è‡ªæ²»å·\",\"adcode\":622900,\"citycode\":\"0930\"},{\"cityname\":\"å…°å·å¸‚\",\"adcode\":620100,\"citycode\":\"0931\"},{\"cityname\":\"å®šè¥¿å¸‚\",\"adcode\":621100,\"citycode\":\"0932\"},{\"cityname\":\"å¹³å‡‰å¸‚\",\"adcode\":620800,\"citycode\":\"0933\"},{\"cityname\":\"åº†é˜³å¸‚\",\"adcode\":621000,\"citycode\":\"0934\"},{\"cityname\":\"é‡‘æ˜Œå¸‚\",\"adcode\":620300,\"citycode\":\"0935\"},{\"cityname\":\"å¼ æ–å¸‚\",\"adcode\":620700,\"citycode\":\"0936\"},{\"cityname\":\"é…’æ³‰å¸‚\",\"adcode\":620900,\"citycode\":\"0937\"},{\"cityname\":\"å¤©æ°´å¸‚\",\"adcode\":620500,\"citycode\":\"0938\"},{\"cityname\":\"ç”˜å—è—æ—è‡ªæ²»å·\",\"adcode\":623000,\"citycode\":\"0941\"},{\"cityname\":\"ç™½é“¶å¸‚\",\"adcode\":620400,\"citycode\":\"0943\"},{\"cityname\":\"é“¶å·å¸‚\",\"adcode\":640100,\"citycode\":\"0951\"},{\"cityname\":\"çŸ³å˜´å±±å¸‚\",\"adcode\":640200,\"citycode\":\"0952\"},{\"cityname\":\"å´å¿ å¸‚\",\"adcode\":640300,\"citycode\":\"0953\"},{\"cityname\":\"å›ºåŸå¸‚\",\"adcode\":640400,\"citycode\":\"0954\"},{\"cityname\":\"æµ·åŒ—è—æ—è‡ªæ²»å·\",\"adcode\":632200,\"citycode\":\"0970\"},{\"cityname\":\"è¥¿å®å¸‚\",\"adcode\":630100,\"citycode\":\"0971\"},{\"cityname\":\"æµ·ä¸œå¸‚\",\"adcode\":630200,\"citycode\":\"0972\"},{\"cityname\":\"é»„å—è—æ—è‡ªæ²»å·\",\"adcode\":632300,\"citycode\":\"0973\"},{\"cityname\":\"æµ·å—è—æ—è‡ªæ²»å·\",\"adcode\":632500,\"citycode\":\"0974\"},{\"cityname\":\"æœæ´›è—æ—è‡ªæ²»å·\",\"adcode\":632600,\"citycode\":\"0975\"},{\"cityname\":\"ç‰æ ‘è—æ—è‡ªæ²»å·\",\"adcode\":632700,\"citycode\":\"0976\"},{\"cityname\":\"æµ·è¥¿è’™å¤æ—è—æ—è‡ªæ²»å·\",\"adcode\":632800,\"citycode\":\"0977\"},{\"cityname\":\"å…‹æ‹‰ç›ä¾å¸‚\",\"adcode\":650200,\"citycode\":\"0990\"},{\"cityname\":\"ä¹Œé²æœ¨é½å¸‚\",\"adcode\":650100,\"citycode\":\"0991\"},{\"cityname\":\"èƒ¡æ¨æ²³å¸‚\",\"adcode\":659010,\"citycode\":\"0992\"},{\"cityname\":\"çŸ³æ²³å­å¸‚\",\"adcode\":659001,\"citycode\":\"0993\"},{\"cityname\":\"æ˜Œå‰å›æ—è‡ªæ²»å·\",\"adcode\":652300,\"citycode\":\"0994\"},{\"cityname\":\"åé²ç•ªå¸‚\",\"adcode\":650400,\"citycode\":\"0995\"},{\"cityname\":\"å·´éŸ³éƒ­æ¥è’™å¤è‡ªæ²»å·\",\"adcode\":652800,\"citycode\":\"0996\"},{\"cityname\":\"é˜¿å…‹è‹åœ°åŒº\",\"adcode\":652900,\"citycode\":\"0997\"},{\"cityname\":\"å–€ä»€åœ°åŒº\",\"adcode\":653100,\"citycode\":\"0998\"},{\"cityname\":\"ä¼ŠçŠå“ˆè¨å…‹è‡ªæ²»å·\",\"adcode\":654000,\"citycode\":\"0999\"},{\"cityname\":\"æµæºå¸‚\",\"adcode\":419001,\"citycode\":\"1391\"},{\"cityname\":\"å»¶è¾¹æœé²œæ—è‡ªæ²»å·\",\"adcode\":222400,\"citycode\":\"1433\"},{\"cityname\":\"é˜œé˜³å¸‚\",\"adcode\":341200,\"citycode\":\"1558\"},{\"cityname\":\"ç¥å†œæ¶æ—åŒº\",\"adcode\":429021,\"citycode\":\"1719\"},{\"cityname\":\"å¤©é—¨å¸‚\",\"adcode\":429006,\"citycode\":\"1728\"},{\"cityname\":\"è´µæ¸¯å¸‚\",\"adcode\":450800,\"citycode\":\"1755\"},{\"cityname\":\"å´‡å·¦å¸‚\",\"adcode\":451400,\"citycode\":\"1771\"},{\"cityname\":\"æ¥å®¾å¸‚\",\"adcode\":451300,\"citycode\":\"1772\"},{\"cityname\":\"è´ºå·å¸‚\",\"adcode\":451100,\"citycode\":\"1774\"},{\"cityname\":\"å†…æ±Ÿå¸‚\",\"adcode\":511000,\"citycode\":\"1832\"},{\"cityname\":\"çœ‰å±±å¸‚\",\"adcode\":511400,\"citycode\":\"1833\"},{\"cityname\":\"é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº\",\"adcode\":810000,\"citycode\":\"1852\"},{\"cityname\":\"æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº\",\"adcode\":820000,\"citycode\":\"1853\"},{\"cityname\":\"å°æ¹¾çœ\",\"adcode\":710000,\"citycode\":\"1886\"},{\"cityname\":\"å±¯æ˜Œå¿\",\"adcode\":469022,\"citycode\":\"1892\"},{\"cityname\":\"æ–‡æ˜Œå¸‚\",\"adcode\":469005,\"citycode\":\"1893\"},{\"cityname\":\"ç¼æµ·å¸‚\",\"adcode\":469002,\"citycode\":\"1894\"},{\"cityname\":\"ä¸´é«˜å¿\",\"adcode\":469024,\"citycode\":\"1896\"},{\"cityname\":\"äº”æŒ‡å±±å¸‚\",\"adcode\":469001,\"citycode\":\"1897\"},{\"cityname\":\"ä¸‡å®å¸‚\",\"adcode\":469006,\"citycode\":\"1898\"},{\"cityname\":\"ç¼ä¸­é»æ—è‹—æ—è‡ªæ²»å¿\",\"adcode\":469030,\"citycode\":\"1899\"},{\"cityname\":\"å¤–å›½\",\"adcode\":900000,\"citycode\":\"1900\"},{\"cityname\":\"æ˜†ç‰å¸‚\",\"adcode\":659009,\"citycode\":\"1903\"},{\"cityname\":\"åŒ—å±¯å¸‚\",\"adcode\":659005,\"citycode\":\"1906\"},{\"cityname\":\"åŒæ²³å¸‚\",\"adcode\":659007,\"citycode\":\"1909\"},{\"cityname\":\"æ­¦å¨å¸‚\",\"adcode\":620600,\"citycode\":\"1935\"},{\"cityname\":\"å˜‰å³ªå…³å¸‚\",\"adcode\":620200,\"citycode\":\"1937\"},{\"cityname\":\"ä¸­å«å¸‚\",\"adcode\":640500,\"citycode\":\"1953\"},{\"cityname\":\"äº”å®¶æ¸ å¸‚\",\"adcode\":659004,\"citycode\":\"1994\"},{\"cityname\":\"é“é—¨å…³å¸‚\",\"adcode\":659006,\"citycode\":\"1996\"},{\"cityname\":\"é˜¿æ‹‰å°”å¸‚\",\"adcode\":659002,\"citycode\":\"1997\"},{\"cityname\":\"å›¾æœ¨èˆ’å…‹å¸‚\",\"adcode\":659003,\"citycode\":\"1998\"},{\"cityname\":\"å¯å…‹è¾¾æ‹‰å¸‚\",\"adcode\":659008,\"citycode\":\"1999\"},{\"cityname\":\"æ½œæ±Ÿå¸‚\",\"adcode\":429005,\"citycode\":\"2728\"},{\"cityname\":\"ä¹ä¸œé»æ—è‡ªæ²»å¿\",\"adcode\":469027,\"citycode\":\"2802\"},{\"cityname\":\"ä¸‰æ²™å¸‚\",\"adcode\":460300,\"citycode\":\"2898\"},{\"cityname\":\"é™‡å—å¸‚\",\"adcode\":621200,\"citycode\":\"2935\"}]"];
    </script>
    <script type="text/javascript">
// eviltransform.js - åæ ‡è½¬æ¢åº“
// æ¥æºï¼šhttps://github.com/googollee/eviltransform/blob/master/javascript/transform.js

function outOfChina(lat, lng) {
    if (lng < 72.004 || lng > 137.8347)
        return true;
    if (lat < 0.8293 || lat > 55.8271)
        return true;
    return false;
}
var earthR = 6378137.0;
function transform(x, y) {
    var xy = x * y;
    var absX = Math.sqrt(Math.abs(x));
    var xPi = x * Math.PI;
    var yPi = y * Math.PI;
    var d = 20.0 * Math.sin(6.0 * xPi) + 20.0 * Math.sin(2.0 * xPi);

    var lat = d;
    var lng = d;

    lat += 20.0 * Math.sin(yPi) + 40.0 * Math.sin(yPi / 3.0);
    lng += 20.0 * Math.sin(xPi) + 40.0 * Math.sin(xPi / 3.0);

    lat += 160.0 * Math.sin(yPi / 12.0) + 320 * Math.sin(yPi / 30.0);
    lng += 150.0 * Math.sin(xPi / 12.0) + 300.0 * Math.sin(xPi / 30.0);

    lat *= 2.0 / 3.0;
    lng *= 2.0 / 3.0;

    lat += -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * xy + 0.2 * absX;
    lng += 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * xy + 0.1 * absX;

    return { lat: lat, lng: lng }
}
function delta(lat, lng) {
    var ee = 0.00669342162296594323;
    var d = transform(lng - 105.0, lat - 35.0);
    var radLat = lat / 180.0 * Math.PI;
    var magic = Math.sin(radLat);
    magic = 1 - ee * magic * magic;
    var sqrtMagic = Math.sqrt(magic);
    d.lat = (d.lat * 180.0) / ((earthR * (1 - ee)) / (magic * sqrtMagic) * Math.PI);
    d.lng = (d.lng * 180.0) / (earthR / sqrtMagic * Math.cos(radLat) * Math.PI);
    return d;
}

function gcj2wgs_exact(gcjLat, gcjLng) {
    var newLat = gcjLat, newLng = gcjLng;
    var oldLat = newLat, oldLng = newLng;
    var threshold = 1e-6;

    for (var i = 0; i < 50; i++) {
        oldLat = newLat;
        oldLng = newLng;
        var d = delta(newLat, newLng);
        newLat = gcjLat - d.lat;
        newLng = gcjLng - d.lng;
        if (Math.max(Math.abs(oldLat - newLat), Math.abs(oldLng - newLng)) < threshold) {
            break;
        }
    }
    return { lat: newLat, lng: newLng };
}
function wgs2gcj(wgsLat, wgsLng) {
	if (outOfChina(wgsLat, wgsLng)) {
		return {lat: wgsLat, lng: wgsLng};
	}
	var d = delta(wgsLat, wgsLng);
	return {lat: wgsLat + d.lat, lng: wgsLng + d.lng};
}

    </script>
    <script type="text/javascript">
// å…¨å±€å˜é‡
var startLocation = null;
var endLocation = null;
var currentCity = '';
var startAuto = null;
var endAuto = null;
var startPlaceSearch = null;
var endPlaceSearch = null;
var cityData = []; // å­˜å‚¨åŸå¸‚ç¼–ç æ•°æ®
var currentCityCode = ''; // å½“å‰é€‰æ‹©çš„åŸå¸‚çš„ç¼–ç 

// åŠ è½½æ—¶æ¢å¤ä¸Šä¸€æ¬¡çš„åŸå¸‚é€‰æ‹©
window.addEventListener('DOMContentLoaded', function () {
    // åˆå§‹åŒ–åŸå¸‚æ•°æ®
    initializeCityData();

    var savedCity = localStorage.getItem('selectedCity');
    if (savedCity) {
        document.getElementById('cityinput').value = savedCity;
        currentCity = savedCity;
        // è®¾ç½®å½“å‰åŸå¸‚ç¼–ç 
        updateCurrentCityCode(savedCity);
    } else {
        // å¦‚æœæ²¡æœ‰ä¿å­˜çš„åŸå¸‚ï¼Œä½¿ç”¨é»˜è®¤çš„åŒ—äº¬å¸‚
        var defaultCity = 'åŒ—äº¬å¸‚';
        document.getElementById('cityinput').value = defaultCity;
        currentCity = defaultCity;
        // è®¾ç½®åŒ—äº¬å¸‚çš„ç¼–ç 
        currentCityCode = '010';
        // ä¿å­˜é»˜è®¤åŸå¸‚
        localStorage.setItem('selectedCity', defaultCity);
    }

    // ä¸æ¢å¤ä¸Šä¸€æ¬¡çš„èµ·ç‚¹å’Œç»ˆç‚¹ï¼Œä¿æŒç©ºç™½

    // è®¾ç½®é»˜è®¤å‡ºå‘æ—¶é—´ä¸ºå½“å‰æ—¶é—´
    setDefaultDepartureTime();

    // è®¾ç½®è‡ªåŠ¨å®Œæˆ
    setupAutocomplete();

    // è®¾ç½®åŸå¸‚è¾“å…¥è‡ªåŠ¨å®Œæˆ
    setupCityAutocomplete();
});

// è®¾ç½®é»˜è®¤å‡ºå‘æ—¶é—´
function setDefaultDepartureTime() {
    // ä¸è®¾ç½®é»˜è®¤æ—¶é—´ï¼Œè®©ç”¨æˆ·è‡ªå·±é€‰æ‹©
    // å¦‚æœç”¨æˆ·æ²¡æœ‰è¾“å…¥æ—¶é—´ï¼Œå°†ä½¿ç”¨å½“å‰æ—¶é—´è¿›è¡Œè·¯çº¿è§„åˆ’
    document.getElementById('departuretime').value = '';
}

// æ™ºèƒ½è½¬æ¢æ—¶é—´æ ¼å¼
function parseTimeInput(input) {
    input = input.trim();
    if (!input) return null;

    // å¤„ç†çº¯æ•°å­—ï¼ˆå¦‚ï¼š8ã€15ã€23ï¼‰
    if (/^\d+$/.test(input)) {
        var hour = parseInt(input);
        if (hour >= 0 && hour <= 23) {
            return hour + ':00';
        }
    }

    // å¤„ç†å°æ—¶:åˆ†é’Ÿæ ¼å¼ï¼ˆå¦‚ï¼š8:30ã€14:30ã€8:3ï¼‰
    if (/^\d{1,2}:\d{1,2}$/.test(input)) {
        var parts = input.split(':');
        var hour = parseInt(parts[0]);
        var minute = parseInt(parts[1]);

        if (hour >= 0 && hour <= 23 && minute >= 0 && minute <= 59) {
            return hour + ':' + (minute < 10 ? '0' + minute : minute);
        }
    }

    // å¤„ç†å¸¦å†’å·çš„ä¸‰ä½æ•°ï¼ˆå¦‚ï¼š8:3 è½¬æ¢ä¸º 8:30ï¼‰
    if (/^\d{1,2}:\d$/.test(input)) {
        var parts = input.split(':');
        var hour = parseInt(parts[0]);
        var minute = parseInt(parts[1]) * 10; // å°†ä¸ªä½æ•°è½¬æ¢ä¸ºæ•´ååˆ†é’Ÿ

        if (hour >= 0 && hour <= 23 && minute <= 50) {
            return hour + ':' + (minute < 10 ? '0' + minute : minute);
        }
    }

    return null; // æ— æ•ˆæ ¼å¼
}

// è·å–å‡ºå‘æ—¶é—´æˆ³ï¼ˆç”¨äºAPIè°ƒç”¨ï¼‰
function getDepartureTimestamp() {
    var timeInput = document.getElementById('departuretime').value;
    var parsedTime = parseTimeInput(timeInput);

    if (!parsedTime) {
        return null; // ä½¿ç”¨APIé»˜è®¤ï¼ˆå½“å‰æ—¶é—´ï¼‰
    }

    var now = new Date();
    var parts = parsedTime.split(':');
    var departureDate = new Date();
    departureDate.setHours(parseInt(parts[0]), parseInt(parts[1]), 0, 0);

    // å¦‚æœè®¾å®šçš„æ—¶é—´å·²ç»è¿‡å»ï¼Œè®¾ç½®ä¸ºæ˜å¤©
    if (departureDate.getTime() < now.getTime()) {
        departureDate.setDate(departureDate.getDate() + 1);
    }

    return Math.floor(departureDate.getTime() / 1000); // è½¬æ¢ä¸ºç§’æ—¶é—´æˆ³
}

// æ ¼å¼åŒ–ç”¨æˆ·è¾“å…¥çš„æ—¶é—´ä¸ºæ˜¾ç¤ºæ ¼å¼
function formatTimeForDisplay(timestamp) {
    if (!timestamp) return 'ç°åœ¨å‡ºå‘';

    var date = new Date(timestamp * 1000);
    var now = new Date();
    var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    var targetDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

    var hours = date.getHours();
    var minutes = date.getMinutes();
    var timeString = hours + ':' + (minutes < 10 ? '0' + minutes : minutes);

    if (targetDate.getTime() === today.getTime()) {
        return 'ä»Šå¤© ' + timeString;
    } else if (targetDate.getTime() === today.getTime() + 24 * 60 * 60 * 1000) {
        return 'æ˜å¤© ' + timeString;
    } else {
        return date.getMonth() + 1 + 'æœˆ' + date.getDate() + 'æ—¥ ' + timeString;
    }
}
//æ ¼å¼åŒ–jsonè¿”å›çš„æ—¶é—´ä¿¡æ¯
function formatTime(input) {
    // Ensure the input is a string
    const timeString = input.toString();

    // Pad with leading zeros if necessary and slice the string
    const hours = timeString.slice(0, -2).padStart(2, '0');
    const minutes = timeString.slice(-2).padEnd(2, '0');

    // Return the formatted time
    return `${hours}:${minutes}`;
}
// è®¾ç½®è‡ªåŠ¨å®Œæˆ
function setupAutocomplete() {
    // æ£€æŸ¥é«˜å¾·åœ°å›¾APIæ˜¯å¦å·²åŠ è½½
    try {
        checkAmapAPILoaded();
    } catch (error) {
        console.warn('è‡ªåŠ¨å®ŒæˆåŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨:', error.message);
        return;
    }
    
    var city = getCurrentCity();

    // å¦‚æœPlaceSearchæœåŠ¡ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–°çš„ï¼›å¦åˆ™åªæ›´æ–°åŸå¸‚è®¾ç½®
    if (!startPlaceSearch) {
        startPlaceSearch = new AMap.PlaceSearch({
            city: city,
            pageSize: 5
        });
    } else {
        startPlaceSearch.setCity(city);
    }

    if (!endPlaceSearch) {
        endPlaceSearch = new AMap.PlaceSearch({
            city: city,
            pageSize: 5
        });
    } else {
        endPlaceSearch.setCity(city);
    }

    // è®¾ç½®è¾“å…¥æç¤ºï¼ˆå¦‚æœè¿˜æ²¡æœ‰è®¾ç½®è¿‡ï¼‰
    if (!document.getElementById('startinput').hasAttribute('data-suggestion-setup')) {
        setupInputSuggestion('startinput', startPlaceSearch, function (location) {
            startLocation = location;
        });
        document.getElementById('startinput').setAttribute('data-suggestion-setup', 'true');
    }

    if (!document.getElementById('endinput').hasAttribute('data-suggestion-setup')) {
        setupInputSuggestion('endinput', endPlaceSearch, function (location) {
            endLocation = location;
        });
        document.getElementById('endinput').setAttribute('data-suggestion-setup', 'true');
    }
}

// è®¾ç½®è¾“å…¥æç¤ºåŠŸèƒ½
function setupInputSuggestion(inputId, placeSearch, onLocationSet) {
    var inputElement = document.getElementById(inputId);
    var suggestionDiv = null;
    var currentSuggestions = [];
    var selectedIndex = -1;

    // åˆ›å»ºå»ºè®®ä¸‹æ‹‰æ¡†
    function createSuggestionDiv() {
        if (suggestionDiv) {
            suggestionDiv.remove();
        }

        suggestionDiv = document.createElement('div');
        suggestionDiv.className = 'amap-sug-result';
        suggestionDiv.style.display = 'none';
        inputElement.parentNode.appendChild(suggestionDiv);
    }

    // æ˜¾ç¤ºå»ºè®®
    function showSuggestions(suggestions) {
        createSuggestionDiv();
        currentSuggestions = suggestions;
        selectedIndex = -1;

        suggestionDiv.innerHTML = '';
        suggestions.forEach(function (item, index) {
            var div = document.createElement('div');
            div.className = 'auto-item';
            div.textContent = item.name + ' - ' + item.address;
            div.addEventListener('click', function () {
                inputElement.value = item.name + ' - ' + item.address;
                if (item.location) {
                    onLocationSet(item.location);

                }
                hideSuggestions();
            });
            suggestionDiv.appendChild(div);
        });

        suggestionDiv.style.display = suggestions.length > 0 ? 'block' : 'none';
    }

    // éšè—å»ºè®®
    function hideSuggestions() {
        if (suggestionDiv) {
            suggestionDiv.style.display = 'none';
        }
    }

    // æœç´¢å»ºè®®
    function searchSuggestions(keyword) {
        if (keyword.length < 2) {
            hideSuggestions();
            return;
        }

        placeSearch.search(keyword, function (status, result) {
            if (status === 'complete' && result.poiList && result.poiList.pois.length > 0) {
                showSuggestions(result.poiList.pois);
            } else {
                hideSuggestions();
            }
        });
    }

    // é”®ç›˜äº‹ä»¶å¤„ç†
    inputElement.addEventListener('input', function (e) {
        var keyword = e.target.value.trim();
        searchSuggestions(keyword);
    });

    inputElement.addEventListener('keydown', function (e) {
        if (!currentSuggestions.length) return;

        var items = suggestionDiv.querySelectorAll('.auto-item');

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, currentSuggestions.length - 1);
            updateSelection(items);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, -1);
            updateSelection(items);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (selectedIndex >= 0) {
                items[selectedIndex].click();
            } else {
                hideSuggestions();
            }
        } else if (e.key === 'Escape') {
            hideSuggestions();
        }
    });

    // æ›´æ–°é€‰ä¸­çŠ¶æ€
    function updateSelection(items) {
        items.forEach(function (item, index) {
            if (index === selectedIndex) {
                item.style.backgroundColor = '#3c3c3c';
            } else {
                item.style.backgroundColor = 'transparent';
            }
        });
    }

    // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—å»ºè®®
    document.addEventListener('click', function (e) {
        if (!inputElement.contains(e.target) && (!suggestionDiv || !suggestionDiv.contains(e.target))) {
            hideSuggestions();
        }
    });
}

// ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­æ‰€æœ‰ä¸‹æ‹‰èœå•
document.addEventListener('click', function (e) {
    if (!e.target.closest('.autocomplete-container')) {
        ['time-dropdown', 'policy-dropdown', 'start-dropdown', 'end-dropdown'].forEach(function (id) {
            document.getElementById(id).classList.remove('show');
        });
    }
});


// ä¿å­˜åŸå¸‚é€‰æ‹©
function saveCity(city) {
    if (city && city.trim()) {
        localStorage.setItem('selectedCity', city.trim());
        currentCity = city.trim();
        // æ›´æ–°å½“å‰åŸå¸‚ç¼–ç 
        updateCurrentCityCode(city.trim());
        // é‡æ–°è®¾ç½®è‡ªåŠ¨å®Œæˆçš„åŸå¸‚
        setupAutocomplete();

        // å¦‚æœè®¾ç½®å¼¹çª—æ˜¯æ‰“å¼€çš„ï¼Œä¹Ÿè¦æ›´æ–°è®¾ç½®é¡µé¢çš„è‡ªåŠ¨å®Œæˆ
        var modal = document.getElementById('settings-modal');
        if (modal && modal.classList.contains('show')) {
            setupSettingsAutocomplete();
        }
    }
}

// ä¸å†ä¿å­˜èµ·ç‚¹å’Œç»ˆç‚¹åˆ°localStorage
function saveStartEnd() {
    // ç©ºå‡½æ•°ï¼Œä¸å†ä¿å­˜èµ·ç‚¹å’Œç»ˆç‚¹
}

// æ¸…é™¤è¾“å…¥æ¡†å†…å®¹
function clearInput(inputId) {
    var input = document.getElementById(inputId);
    input.value = '';

    // æ¸…é™¤å¯¹åº”çš„ä½ç½®å˜é‡
    if (inputId === 'startinput') {
        startLocation = null;
    } else if (inputId === 'endinput') {
        endLocation = null;
    }

    // éšè—è‡ªåŠ¨å®Œæˆå»ºè®®
    hideAllSuggestions();

    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    saveStartEnd();

    // è®©è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹
    input.focus();
}

// æ¸…é™¤å‡ºå‘æ—¶é—´
function clearDepartureTime() {
    var timeInput = document.getElementById('departuretime');
    timeInput.value = '';
    timeInput.focus();
}

// åˆ‡æ¢æ—¶é—´ä¸‹æ‹‰èœå•
function toggleTimeDropdown() {
    var dropdown = document.getElementById('time-dropdown');
    dropdown.classList.toggle('show');

    // å…³é—­å…¶ä»–ä¸‹æ‹‰èœå•
    ['start-dropdown', 'end-dropdown', 'policy-dropdown'].forEach(function (id) {
        document.getElementById(id).classList.remove('show');
    });
}

// å¿«é€Ÿé€‰æ‹©æ—¶é—´
function selectQuickTime(type) {
    var timeInput = document.getElementById('departuretime');
    var now = new Date();
    var timeString = '';

    switch (type) {
        case 'now':
            timeString = now.getHours() + ':' + (now.getMinutes() < 10 ? '0' + now.getMinutes() : now.getMinutes());
            break;
        case 'morning':
            timeString = '8:00';
            break;
        case 'noon':
            timeString = '12:00';
            break;
        case 'evening':
            timeString = '18:00';
            break;
        case 'night':
            timeString = '22:00';
            break;
    }

    timeInput.value = timeString;
    document.getElementById('time-dropdown').classList.remove('show');
    timeInput.focus();
}

// åˆ‡æ¢è·¯çº¿é€‰æ‹©ä¾æ®ä¸‹æ‹‰èœå•
function togglePolicyDropdown() {
    var dropdown = document.getElementById('policy-dropdown');
    dropdown.classList.toggle('show');

    // å…³é—­å…¶ä»–ä¸‹æ‹‰èœå•
    ['time-dropdown', 'start-dropdown', 'end-dropdown'].forEach(function (id) {
        document.getElementById(id).classList.remove('show');
    });
}

// é€‰æ‹©è·¯çº¿é€‰æ‹©ä¾æ®
function selectPolicy(value, text) {
    var policyInput = document.getElementById('policy-select');
    policyInput.value = text;
    policyInput.setAttribute('data-value', value);
    document.getElementById('policy-dropdown').classList.remove('show');
}

// è·å–å½“å‰é€‰æ‹©çš„è·¯çº¿é€‰æ‹©ä¾æ®å€¼
function getPolicyValue() {
    var policyInput = document.getElementById('policy-select');
    var value = policyInput.getAttribute('data-value');
    return value || '0'; // é»˜è®¤ä½¿ç”¨æ¨èç­–ç•¥
}

// éšè—æ‰€æœ‰å»ºè®®ä¸‹æ‹‰æ¡†
function hideAllSuggestions() {
    var suggestions = document.querySelectorAll('.amap-sug-result');
    suggestions.forEach(function (suggestion) {
        suggestion.style.display = 'none';
    });
}

// æ‰“å¼€è®¾ç½®å¼¹çª—
function openSettings() {
    var modal = document.getElementById('settings-modal');
    modal.classList.add('show');

    // åŠ è½½å·²ä¿å­˜çš„è®¾ç½®
    loadSettings();

    // è®¾ç½®è‡ªåŠ¨å®ŒæˆåŠŸèƒ½
    setupSettingsAutocomplete();
}

// å…³é—­è®¾ç½®å¼¹çª—
function closeSettings() {
    var modal = document.getElementById('settings-modal');
    modal.classList.remove('show');
}

// æ¸…é™¤è®¾ç½®è¾“å…¥æ¡†
function clearSettingInput(inputId) {
    var input = document.getElementById(inputId);
    input.value = '';
    input.focus();
}

// åŠ è½½è®¾ç½®
function loadSettings() {
    var homeAddress = localStorage.getItem('homeAddress');
    var companyAddress = localStorage.getItem('companyAddress');
    var favoriteAddress = localStorage.getItem('favoriteAddress');
    var webApiKey = localStorage.getItem('webApiKey');
    var JSwebApiKey = localStorage.getItem('JSwebApiKey');
    var safetyKey = localStorage.getItem('safetyKey');

    // åŠ è½½APIå¯†é’¥
    if (webApiKey) {
        document.getElementById('webapi-key-input').value = webApiKey;
    }
    if (JSwebApiKey) {
        document.getElementById('jswebapi-key-input').value = JSwebApiKey;
    }
    if (safetyKey) {
        document.getElementById('safety-key-input').value = safetyKey;
    }

    // åŠ è½½åœ°å€
    if (homeAddress) {
        document.getElementById('home-input').value = homeAddress;
    }
    if (companyAddress) {
        document.getElementById('company-input').value = companyAddress;
    }
    if (favoriteAddress) {
        document.getElementById('favorite-input').value = favoriteAddress;
    }
}

// ä¿å­˜è®¾ç½®
function saveSettings() {
    var homeAddress = document.getElementById('home-input').value.trim();
    var companyAddress = document.getElementById('company-input').value.trim();
    var favoriteAddress = document.getElementById('favorite-input').value.trim();
    var webApiKey = document.getElementById('webapi-key-input').value.trim();
    var JSwebApiKey = document.getElementById('jswebapi-key-input').value.trim();
    var safetyKey = document.getElementById('safety-key-input').value.trim();

    // ä¿å­˜APIå¯†é’¥
    if (webApiKey) {
        localStorage.setItem('webApiKey', webApiKey);
    } else {
        localStorage.removeItem('webApiKey');
    }

    if (JSwebApiKey) {
        localStorage.setItem('JSwebApiKey', JSwebApiKey);
    } else {
        localStorage.removeItem('JSwebApiKey');
    }

    if (safetyKey) {
        localStorage.setItem('safetyKey', safetyKey);
    } else {
        localStorage.removeItem('safetyKey');
    }

    // ä¿å­˜åœ°å€
    if (homeAddress) {
        localStorage.setItem('homeAddress', homeAddress);
    } else {
        localStorage.removeItem('homeAddress');
    }

    if (companyAddress) {
        localStorage.setItem('companyAddress', companyAddress);
    } else {
        localStorage.removeItem('companyAddress');
    }

    if (favoriteAddress) {
        localStorage.setItem('favoriteAddress', favoriteAddress);
    } else {
        localStorage.removeItem('favoriteAddress');
    }

    // æ›´æ–°APIé…ç½®
    var oldConfig = window.AMAP_CONFIG || {};
    window.AMAP_CONFIG = {
        webApiKey: webApiKey || '',
        JSwebApiKey: JSwebApiKey || '',
        safetyKey: safetyKey || ''
    };

    // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°åŠ è½½é¡µé¢ï¼ˆå¦‚æœJS API Keyæˆ–å®‰å…¨å¯†é’¥å‘ç”Ÿäº†å˜åŒ–ï¼‰
    if (oldConfig.JSwebApiKey !== window.AMAP_CONFIG.JSwebApiKey || 
        oldConfig.safetyKey !== window.AMAP_CONFIG.safetyKey) {
        
        // å¦‚æœæ–°çš„é…ç½®éƒ½è®¾ç½®äº†ï¼Œæç¤ºç”¨æˆ·é‡æ–°åŠ è½½é¡µé¢
        if (window.AMAP_CONFIG.JSwebApiKey && window.AMAP_CONFIG.safetyKey) {
            showMessage('APIé…ç½®å·²æ›´æ–°ï¼Œé¡µé¢å°†é‡æ–°åŠ è½½ä»¥åº”ç”¨æ–°é…ç½®');
            setTimeout(function() {
                window.location.reload();
            }, 2000);
        }
    }

    // å…³é—­å¼¹çª—
    closeSettings();
}

// åˆ‡æ¢ä¸‹æ‹‰èœå•æ˜¾ç¤ºçŠ¶æ€
function toggleDropdown(type) {
    var dropdownId = type + '-dropdown';
    var dropdown = document.getElementById(dropdownId);

    // å…³é—­æ‰€æœ‰å…¶ä»–ä¸‹æ‹‰èœå•
    ['start-dropdown', 'end-dropdown', 'time-dropdown', 'policy-dropdown'].forEach(function (id) {
        if (id !== dropdownId) {
            document.getElementById(id).classList.remove('show');
        }
    });

    // åˆ‡æ¢å½“å‰ä¸‹æ‹‰èœå•
    dropdown.classList.toggle('show');

    // å¦‚æœæ˜¯æ˜¾ç¤ºçŠ¶æ€ï¼ŒåŠ è½½å†å²è®°å½•
    if (dropdown.classList.contains('show')) {
        loadSearchHistory(type);
    }
}

// ä»ä¸‹æ‹‰èœå•é€‰æ‹©åœ°å€
function selectFromDropdown(type, itemType) {
    var address = '';
    var addressName = '';

    switch (itemType) {
        case 'home':
            address = localStorage.getItem('homeAddress');
            addressName = 'å®¶';
            break;
        case 'company':
            address = localStorage.getItem('companyAddress');
            addressName = 'å…¬å¸';
            break;
        case 'favorite':
            address = localStorage.getItem('favoriteAddress');
            addressName = 'æ”¶è—';
            break;
    }

    if (address) {
        document.getElementById(type + 'input').value = address;
        // è§¦å‘åœ°ç‚¹æœç´¢ä»¥è·å–åæ ‡
        searchLocationForSetPoint(address, type);
        saveStartEnd();

        // ä¸æ·»åŠ å¸¸ç”¨åœ°å€åˆ°å†å²è®°å½•
        // addToSearchHistory(address, addressName);

        // å…³é—­ä¸‹æ‹‰èœå•
        document.getElementById(type + '-dropdown').classList.remove('show');
    } else {
        showMessage('è¯·å…ˆåœ¨è®¾ç½®ä¸­æ·»åŠ ' + addressName + 'åœ°å€');
    }
}

// åŠ è½½æœç´¢å†å²è®°å½•
function loadSearchHistory(type) {
    var historyKey = type + 'History';
    var history = JSON.parse(localStorage.getItem(historyKey) || '[]');
    var historyContainer = document.getElementById(type + '-history');

    historyContainer.innerHTML = '';

    if (history.length === 0) {
        var emptyItem = document.createElement('div');
        emptyItem.className = 'dropdown-item';
        emptyItem.textContent = 'æš‚æ— å†å²è®°å½•';
        emptyItem.style.cursor = 'default';
        emptyItem.style.color = '#858585';
        historyContainer.appendChild(emptyItem);
    } else {
        history.forEach(function (item, index) {
            var historyItem = document.createElement('div');
            historyItem.className = 'dropdown-item';
            historyItem.textContent = item.name;
            historyItem.onclick = function () {
                selectHistoryItem(type, item);
            };
            historyContainer.appendChild(historyItem);
        });
    }
}

// ä»å†å²è®°å½•é€‰æ‹©
function selectHistoryItem(type, item) {
    document.getElementById(type + 'input').value = item.address;
    // è§¦å‘åœ°ç‚¹æœç´¢ä»¥è·å–åæ ‡
    searchLocationForSetPoint(item.address, type);
    saveStartEnd();

    // æ›´æ–°å†å²è®°å½•ï¼ˆæŠŠé€‰ä¸­çš„ç§»åˆ°æœ€å‰é¢ï¼‰
    updateSearchHistory(item.address, item.name, type);

    // å…³é—­ä¸‹æ‹‰èœå•
    document.getElementById(type + '-dropdown').classList.remove('show');
}

// æ·»åŠ åˆ°æœç´¢å†å²è®°å½•
function addToSearchHistory(address, name) {
    ['start', 'end'].forEach(function (type) {
        updateSearchHistory(address, name, type);
    });
}

// æ£€æŸ¥æ˜¯å¦ä¸ºå¸¸ç”¨åœ°å€
function isCommonAddress(address) {
    var homeAddress = localStorage.getItem('homeAddress');
    var companyAddress = localStorage.getItem('companyAddress');
    var favoriteAddress = localStorage.getItem('favoriteAddress');

    return address === homeAddress || address === companyAddress || address === favoriteAddress;
}

// æ›´æ–°æœç´¢å†å²è®°å½•
function updateSearchHistory(address, name, type) {
    // ä¸å°†å¸¸ç”¨åœ°å€æ·»åŠ åˆ°å†å²è®°å½•
    if (isCommonAddress(address)) {
        return;
    }

    var historyKey = type + 'History';
    var history = JSON.parse(localStorage.getItem(historyKey) || '[]');

    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒåœ°å€
    var existingIndex = history.findIndex(function (item) {
        return item.address === address;
    });

    if (existingIndex !== -1) {
        // ç§»é™¤å·²å­˜åœ¨çš„é¡¹
        history.splice(existingIndex, 1);
    }

    // æ·»åŠ åˆ°æœ€å‰é¢
    history.unshift({
        address: address,
        name: name,
        timestamp: Date.now()
    });

    // åªä¿ç•™æœ€è¿‘5æ¡è®°å½•
    history = history.slice(0, 5);

    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    localStorage.setItem(historyKey, JSON.stringify(history));
}

// ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
document.addEventListener('click', function (e) {
    if (!e.target.matches('.autocomplete-dropdown') && !e.target.closest('.dropdown-menu')) {
        ['start-dropdown', 'end-dropdown', 'time-dropdown'].forEach(function (id) {
            document.getElementById(id).classList.remove('show');
        });
    }
});

// ä¸ºè®¾ç½®ç‚¹æœç´¢ä½ç½®
function searchLocationForSetPoint(address, type, callback) {
    var city = getCurrentCity();
    var placeSearch = type === 'start' ? startPlaceSearch : endPlaceSearch;

    if (placeSearch) {
        placeSearch.setCity(city);
        placeSearch.search(address, function (status, result) {
            if (status === 'complete' && result.poiList && result.poiList.pois.length > 0) {
                var poi = result.poiList.pois[0];
                if (poi.location) {
                    if (type === 'start') {
                        startLocation = poi.location;
                    } else {
                        endLocation = poi.location;
                    }
                    // å¦‚æœæœ‰å›è°ƒå‡½æ•°ï¼Œæ‰§è¡Œå›è°ƒ
                    if (callback) {
                        callback();
                    }
                } else {
                    showMessage('æœªæ‰¾åˆ°è¯¥åœ°å€çš„ä½ç½®ä¿¡æ¯');
                }
            } else {
                showMessage('æœç´¢åœ°å€å¤±è´¥ï¼Œè¯·æ£€æŸ¥åœ°å€æ˜¯å¦æ­£ç¡®');
            }
        });
    }
}

// æ˜¾ç¤ºæ¶ˆæ¯
function showMessage(message) {
    // åˆ›å»ºä¸´æ—¶æ¶ˆæ¯æç¤º
    var messageDiv = document.createElement('div');
    messageDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: #2d1b1b;
                color: #f48771;
                padding: 15px 20px;
                border-radius: 4px;
                border: 1px solid #8c2d2d;
                z-index: 3000;
                font-size: 14px;
                font-family: Arial, sans-serif, 'Courier New', monospace;
            `;
    messageDiv.textContent = message;
    document.body.appendChild(messageDiv);

    // 3ç§’åç§»é™¤
    setTimeout(function () {
        if (messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
        }
    }, 3000);
}

// è®¾ç½®å¼¹çª—çš„è‡ªåŠ¨å®ŒæˆåŠŸèƒ½
function setupSettingsAutocomplete() {
    // æ£€æŸ¥é«˜å¾·åœ°å›¾APIæ˜¯å¦å·²åŠ è½½
    try {
        checkAmapAPILoaded();
    } catch (error) {
        console.warn('è®¾ç½®è‡ªåŠ¨å®ŒæˆåŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨:', error.message);
        return;
    }
    
    var city = getCurrentCity();

    // åˆ›å»ºåœ°ç‚¹æœç´¢æœåŠ¡
    if (!window.settingsPlaceSearch) {
        window.settingsPlaceSearch = new AMap.PlaceSearch({
            city: city,
            pageSize: 5
        });
    }

    // ä¸ºæ¯ä¸ªè®¾ç½®è¾“å…¥æ¡†è®¾ç½®è‡ªåŠ¨å®Œæˆ
    setupInputSuggestion('home-input', window.settingsPlaceSearch, function (location) {
        // è®¾ç½®é¡µé¢ä¸éœ€è¦ä¿å­˜åæ ‡ï¼Œåªéœ€è¦ä¿å­˜åœ°å€æ–‡æœ¬
    });

    setupInputSuggestion('company-input', window.settingsPlaceSearch, function (location) {
        // è®¾ç½®é¡µé¢ä¸éœ€è¦ä¿å­˜åæ ‡ï¼Œåªéœ€è¦ä¿å­˜åœ°å€æ–‡æœ¬
    });

    setupInputSuggestion('favorite-input', window.settingsPlaceSearch, function (location) {
        // è®¾ç½®é¡µé¢ä¸éœ€è¦ä¿å­˜åæ ‡ï¼Œåªéœ€è¦ä¿å­˜åœ°å€æ–‡æœ¬
    });
}

// ç‚¹å‡»å¼¹çª—èƒŒæ™¯å…³é—­
document.getElementById('settings-modal').addEventListener('click', function (e) {
    if (e.target === this) {
        closeSettings();
    }
});

// äº¤æ¢èµ·ç‚¹å’Œç»ˆç‚¹
function swapStartEnd() {
    var startInput = document.getElementById('startinput');
    var endInput = document.getElementById('endinput');
    var startValue = startInput.value;
    var endValue = endInput.value;

    // äº¤æ¢å€¼
    startInput.value = endValue;
    endInput.value = startValue;

    // äº¤æ¢ä½ç½®å˜é‡
    var tempLocation = startLocation;
    startLocation = endLocation;
    endLocation = tempLocation;

    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    saveStartEnd();

    // é‡æ–°è·å–ä½ç½®ä¿¡æ¯
    if (startValue) {
        searchLocationForSetPoint(startValue, 'end');
    }
    if (endValue) {
        searchLocationForSetPoint(endValue, 'start');
    }
}

// å®šä½åˆ°èµ·ç‚¹
function locateStart() {
    // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒåœ°ç†å®šä½
    if (!navigator.geolocation) {
        showMessage('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½åŠŸèƒ½');
        return;
    }

    showMessage('æ­£åœ¨è·å–å½“å‰ä½ç½®...');

    // è·å–å½“å‰ä½ç½®
    navigator.geolocation.getCurrentPosition(
        function(position) {
            try {
                // è·å–GPSåæ ‡ï¼ˆWGS-84åæ ‡ç³»ï¼‰
                var wgsLat = position.coords.latitude;
                var wgsLng = position.coords.longitude;

                // è½¬æ¢ä¸ºGCJ-02åæ ‡ç³»ï¼ˆé«˜å¾·åœ°å›¾ä½¿ç”¨ï¼‰
                var gcjCoords = wgs2gcj(wgsLat, wgsLng);

                // è®¾ç½®èµ·ç‚¹è¾“å…¥æ¡†çš„å€¼
                document.getElementById('startinput').value = 'å½“å‰ä½ç½®';

                // ä¿å­˜èµ·ç‚¹åæ ‡ä¿¡æ¯ï¼Œç”¨äºåç»­è·¯çº¿è§„åˆ’
                startLocation = {
                    lat: gcjCoords.lat,
                    lng: gcjCoords.lng
                };

                // ä¿å­˜èµ·ç‚¹ä¿¡æ¯
                saveStartEnd();

                showMessage('å®šä½æˆåŠŸï¼Œå·²è®¾ç½®ä¸ºèµ·ç‚¹');
            } catch (error) {
                console.error('å®šä½å¤„ç†é”™è¯¯:', error);
                showMessage('å®šä½ä¿¡æ¯å¤„ç†å¤±è´¥');
            }
        },
        function(error) {
            var errorMessage = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = 'ç”¨æˆ·æ‹’ç»äº†åœ°ç†å®šä½è¯·æ±‚';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = 'ä½ç½®ä¿¡æ¯ä¸å¯ç”¨';
                    break;
                case error.TIMEOUT:
                    errorMessage = 'å®šä½è¯·æ±‚è¶…æ—¶';
                    break;
                case error.UNKNOWN_ERROR:
                    errorMessage = 'å®šä½å‘ç”ŸæœªçŸ¥é”™è¯¯';
                    break;
            }
            showMessage(errorMessage);
        },
        {
            enableHighAccuracy: true,    // å¯ç”¨é«˜ç²¾åº¦å®šä½
            timeout: 10000,              // 10ç§’è¶…æ—¶
            maximumAge: 300000           // 5åˆ†é’Ÿå†…çš„ç¼“å­˜ä½ç½®ä¹Ÿæ¥å—
        }
    );
}

// å®šä½åˆ°ç»ˆç‚¹
function locateTarget() {
    var endInput = document.getElementById('endinput');

    // æ£€æŸ¥ç»ˆç‚¹è¾“å…¥æ¡†æ˜¯å¦æœ‰å†…å®¹
    if (!endInput.value.trim()) {
        showMessage('è¯·å…ˆè¾“å…¥ç»ˆç‚¹åœ°å€');
        return;
    }

    // æ£€æŸ¥æ˜¯å¦æœ‰ç»ˆç‚¹ä½ç½®ä¿¡æ¯
    if (!endLocation) {
        showMessage('æ­£åœ¨è·å–ç»ˆç‚¹ä½ç½®ä¿¡æ¯ï¼Œè¯·ç¨å€™...');
        // é‡æ–°æœç´¢ç»ˆç‚¹ä½ç½®ï¼Œæœç´¢å®Œæˆåè‡ªåŠ¨è·³è½¬
        searchLocationForSetPoint(endInput.value.trim(), 'end', function () {
            if (endLocation) {
                // è½¬æ¢GCJåæ ‡åˆ°WGSåæ ‡
                var wgsCoords = gcj2wgs_exact(endLocation.lat, endLocation.lng);

                // ç”Ÿæˆomè·³è½¬é“¾æ¥
                var omLink = 'om://map?ll=' + wgsCoords.lat.toFixed(7) + ',' + wgsCoords.lng.toFixed(7);

                // è·³è½¬åˆ°omåœ°å›¾
                window.location.href = omLink;
            }
        });
        return;
    }

    // è½¬æ¢GCJåæ ‡åˆ°WGSåæ ‡
    var wgsCoords = gcj2wgs_exact(endLocation.lat, endLocation.lng);

    // ç”Ÿæˆomè·³è½¬é“¾æ¥
    var omLink = 'om://map?ll=' + wgsCoords.lat.toFixed(7) + ',' + wgsCoords.lng.toFixed(7);

    // è·³è½¬åˆ°omåœ°å›¾
    window.location.href = omLink;
}

// æ£€æŸ¥é«˜å¾·åœ°å›¾APIæ˜¯å¦å·²åŠ è½½
function checkAmapAPILoaded() {
    if (typeof AMap === 'undefined') {
        throw new Error('é«˜å¾·åœ°å›¾APIæœªåŠ è½½ï¼Œè¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®JS Web API Keyå’Œå®‰å…¨å¯†é’¥');
    }
    return true;
}

// è·å–å½“å‰åŸå¸‚
function getCurrentCity() {
    return document.getElementById('cityinput').value.trim() || 'åŒ—äº¬å¸‚';
}

// åˆå§‹åŒ–åŸå¸‚æ•°æ®
function initializeCityData() {
    try {
        // citycode.jsonæ˜¯ä¸€ä¸ªåŒ…å«JSONå­—ç¬¦ä¸²çš„æ•°ç»„ï¼Œéœ€è¦å…ˆè§£æå­—ç¬¦ä¸²ï¼Œå†è§£ææ•°ç»„
        var cityCodeString = citycode[0]; // è·å–å­—ç¬¦ä¸²
        cityData = JSON.parse(cityCodeString); // è§£æå­—ç¬¦ä¸²ä¸ºæ•°ç»„
    } catch (error) {
        console.error('åŸå¸‚æ•°æ®åŠ è½½å¤±è´¥:', error);
        cityData = [];
    }
}

// åŸå¸‚æ¨¡ç³ŠåŒ¹é…
function fuzzyMatchCity(input) {
    if (!input || input.trim() === '') {
        return null;
    }

    var inputStr = input.trim().toLowerCase();
    var bestMatch = null;
    var bestScore = 0;

    for (var i = 0; i < cityData.length; i++) {
        var city = cityData[i];
        var cityName = city.cityname;

        // å®Œå…¨åŒ¹é…ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
        if (cityName === inputStr) {
            return city;
        }

        // åŒ…å«åŒ¹é…
        if (cityName.indexOf(inputStr) !== -1) {
            var score = cityName.length - inputStr.length;
            if (score > bestScore) {
                bestScore = score;
                bestMatch = city;
            }
        }
    }

    return bestMatch;
}

// æ›´æ–°å½“å‰åŸå¸‚ç¼–ç 
function updateCurrentCityCode(cityName) {
    var matchedCity = fuzzyMatchCity(cityName);
    if (matchedCity) {
        currentCityCode = matchedCity.citycode;
    } else {
        currentCityCode = '';
    }
}

// è·å–å½“å‰åŸå¸‚ç¼–ç 
function getCurrentCityCode() {
    return currentCityCode;
}

// è®¾ç½®åŸå¸‚è¾“å…¥è‡ªåŠ¨å®Œæˆ
function setupCityAutocomplete() {
    var cityInput = document.getElementById('cityinput');
    var cityWrapper = cityInput.parentNode;
    var suggestionDiv = null;
    var currentSuggestions = [];
    var selectedIndex = -1;

    // åˆ›å»ºåŸå¸‚å»ºè®®ä¸‹æ‹‰æ¡†
    function createCitySuggestionDiv() {
        if (suggestionDiv) {
            suggestionDiv.remove();
        }

        suggestionDiv = document.createElement('div');
        suggestionDiv.className = 'amap-sug-result';
        suggestionDiv.style.display = 'none';
        suggestionDiv.style.position = 'absolute';
        suggestionDiv.style.top = '100%';
        suggestionDiv.style.left = '0';
        suggestionDiv.style.right = '0';
        suggestionDiv.style.zIndex = '1000';
        cityWrapper.appendChild(suggestionDiv);
    }

    // æ˜¾ç¤ºåŸå¸‚å»ºè®®
    function showCitySuggestions(suggestions) {
        createCitySuggestionDiv();
        currentSuggestions = suggestions;
        selectedIndex = -1;

        suggestionDiv.innerHTML = '';
        suggestions.forEach(function (item, index) {
            var div = document.createElement('div');
            div.className = 'auto-item';
            div.textContent = item.cityname;
            div.addEventListener('click', function () {
                cityInput.value = item.cityname;
                currentCity = item.cityname;
                currentCityCode = item.citycode;
                saveCity(item.cityname);
                hideCitySuggestions();
            });
            suggestionDiv.appendChild(div);
        });

        suggestionDiv.style.display = suggestions.length > 0 ? 'block' : 'none';
    }

    // éšè—åŸå¸‚å»ºè®®
    function hideCitySuggestions() {
        if (suggestionDiv) {
            suggestionDiv.style.display = 'none';
        }
    }

    // æœç´¢åŸå¸‚å»ºè®®
    function searchCitySuggestions(keyword) {
        if (keyword.length < 1) {
            hideCitySuggestions();
            return;
        }

        var suggestions = [];
        var inputStr = keyword.toLowerCase();

        // æ¨¡ç³ŠåŒ¹é…åŸå¸‚
        for (var i = 0; i < cityData.length; i++) {
            var city = cityData[i];
            var cityName = city.cityname;

            // å®Œå…¨åŒ¹é…æˆ–åŒ…å«åŒ¹é…
            if (cityName.indexOf(keyword) !== -1) {
                suggestions.push(city);
            }

            // é™åˆ¶å»ºè®®æ•°é‡
            if (suggestions.length >= 5) {
                break;
            }
        }

        showCitySuggestions(suggestions);
    }

    // é”®ç›˜äº‹ä»¶å¤„ç†
    cityInput.addEventListener('input', function (e) {
        var keyword = e.target.value.trim();
        searchCitySuggestions(keyword);
    });

    cityInput.addEventListener('keydown', function (e) {
        if (!currentSuggestions.length) return;

        var items = suggestionDiv.querySelectorAll('.auto-item');

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, currentSuggestions.length - 1);
            updateCitySelection(items);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, -1);
            updateCitySelection(items);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (selectedIndex >= 0) {
                items[selectedIndex].click();
            } else {
                hideCitySuggestions();
            }
        } else if (e.key === 'Escape') {
            hideCitySuggestions();
        }
    });

    // æ›´æ–°é€‰ä¸­çŠ¶æ€
    function updateCitySelection(items) {
        items.forEach(function (item, index) {
            if (index === selectedIndex) {
                item.style.backgroundColor = '#3c3c3c';
            } else {
                item.style.backgroundColor = 'transparent';
            }
        });
    }

    // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—å»ºè®®
    document.addEventListener('click', function (e) {
        if (!cityInput.contains(e.target) && (!suggestionDiv || !suggestionDiv.contains(e.target))) {
            hideCitySuggestions();
        }
    });
}

// åŸå¸‚è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹æ—¶ä¿å­˜
document.getElementById('cityinput').addEventListener('blur', function () {
    saveCity(this.value);
});

// åŸå¸‚è¾“å…¥æ¡†å†…å®¹å˜åŒ–æ—¶æ›´æ–°è‡ªåŠ¨å®ŒæˆåŸå¸‚
document.getElementById('cityinput').addEventListener('input', function () {
    var city = this.value.trim() || 'å…¨å›½';
    currentCity = city;
    // æ›´æ–°åŸå¸‚ç¼–ç 
    updateCurrentCityCode(city);

    // ç«‹å³æ›´æ–°ç°æœ‰åœ°ç‚¹æœç´¢æœåŠ¡çš„åŸå¸‚è®¾ç½®
    if (startPlaceSearch) {
        startPlaceSearch.setCity(city);
    }
    if (endPlaceSearch) {
        endPlaceSearch.setCity(city);
    }
    if (window.settingsPlaceSearch) {
        window.settingsPlaceSearch.setCity(city);
    }
});

// èµ·ç‚¹å’Œç»ˆç‚¹è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹æ—¶ä¿å­˜
document.getElementById('startinput').addEventListener('blur', function () {
    saveStartEnd();
});

document.getElementById('endinput').addEventListener('blur', function () {
    saveStartEnd();
});

// åœ°ç‚¹æœç´¢æœåŠ¡
function searchLocation(keyword, city, isStart, callback) {
    var placeSearch = isStart ? startPlaceSearch : endPlaceSearch;
    placeSearch.setCity(city);
    placeSearch.search(keyword, function (status, result) {
        if (status === 'complete' && result.poiList && result.poiList.pois.length > 0) {
            var poi = result.poiList.pois[0];
            if (poi.location) {
                callback(poi.location);
            } else {
                callback(null);
            }
        } else {
            callback(null);
        }
    });
}

// è·å–ç­–ç•¥å€¼ - Web APIç‰ˆæœ¬
function getPolicyValue() {
    var policyInput = document.getElementById('policy-select');
    var policyValue = policyInput.getAttribute('data-value');
    return policyValue || '0'; // é»˜è®¤æ¨èæ¨¡å¼
}

// æ ¼å¼åŒ–æ—¶é—´
function formatDuration(seconds) {
    var hours = Math.floor(seconds / 3600);
    var minutes = Math.floor((seconds % 3600) / 60);

    if (hours > 0) {
        return hours + 'å°æ—¶' + minutes + 'åˆ†';
    } else {
        return minutes + 'åˆ†é’Ÿ';
    }
}

// æ ¼å¼åŒ–è·ç¦»
function formatDistance(meters) {
    if (meters >= 1000) {
        return (meters / 1000).toFixed(1) + 'å…¬é‡Œ';
    } else {
        return Math.round(meters) + 'ç±³';
    }
}

// è·å–æ­¥éª¤å›¾æ ‡
function getStepIcon(instruction) {
    if (instruction.indexOf('æ­¥è¡Œ') >= 0 || instruction.indexOf('èµ°è·¯') >= 0) {
        return 'walk';
    } else if (instruction.indexOf('åœ°é“') >= 0 || instruction.indexOf('MTR') >= 0) {
        return 'metro';
    } else {
        return 'bus';
    }
}

// è·å–äº¤é€šæ–¹å¼æ‘˜è¦
function getTransportSummary(segments) {
    var transportTypes = [];
    var hasWalking = false;

    segments.forEach(function (segment) {
        if (segment.transit_mode === 'WALK') {
            hasWalking = true;
        } else if (segment.transit_mode === 'SUBWAY') {
            if (!transportTypes.includes('åœ°é“')) {
                transportTypes.push('åœ°é“');
            }
        } else if (segment.transit_mode === 'BUS') {
            if (!transportTypes.includes('å…¬äº¤')) {
                transportTypes.push('å…¬äº¤');
            }
        }
    });

    if (hasWalking && transportTypes.length > 0) {
        transportTypes.push('æ­¥è¡Œ');
    } else if (hasWalking) {
        transportTypes = ['æ­¥è¡Œ'];
    }

    return transportTypes;
}

// è®¡ç®—æ­¥è¡Œæ€»è·ç¦»
function getWalkingDistance(segments) {
    var walkingDistance = 0;
    segments.forEach(function (segment) {
        if (segment.transit_mode === 'WALK' && segment.distance) {
            walkingDistance += segment.distance;
        }
    });
    return walkingDistance;
}

// è·å–é«˜å¾·APIè¿”å›çš„å®é™…è´¹ç”¨
function getActualCost(route) {
    // é«˜å¾·APIè¿”å›çš„æ•°æ®ä¸­ï¼Œè´¹ç”¨ä¿¡æ¯é€šå¸¸åœ¨routeå¯¹è±¡çš„æŸä¸ªå±æ€§ä¸­
    // æ ¹æ®é«˜å¾·åœ°å›¾æ–‡æ¡£ï¼Œè´¹ç”¨ä¿¡æ¯é€šå¸¸åœ¨route.costå±æ€§ä¸­
    if (route.cost !== undefined && route.cost !== null) {
        return route.cost;
    }

    // å¦‚æœroute.costä¸å­˜åœ¨ï¼Œå°è¯•ä»segmentsä¸­æŸ¥æ‰¾è´¹ç”¨ä¿¡æ¯
    var totalCost = 0;
    if (route.segments && route.segments.length > 0) {
        route.segments.forEach(function (segment) {
            if (segment.cost !== undefined && segment.cost !== null) {
                totalCost += segment.cost;
            }
        });
        return totalCost > 0 ? totalCost : null;
    }

    // å¦‚æœéƒ½æ²¡æœ‰æ‰¾åˆ°è´¹ç”¨ä¿¡æ¯ï¼Œè¿”å›null
    return null;
}

// æ£€æŸ¥æ˜¯å¦ä¸ºç«™å†…æ¢ä¹˜ï¼ˆæ­¥è¡Œå‰åéƒ½æ˜¯åœ°é“ï¼Œä¸”å‰ä¸€ä¸ªåœ°é“æ²¡æœ‰å‡ºç«™å£ï¼‰
function checkStationTransfer(allSegments, currentIndex) {
    // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªæˆ–æœ€åä¸€ä¸ªæ­¥è¡Œè·¯æ®µï¼Œä¸å¯èƒ½æ˜¯ç«™å†…æ¢ä¹˜
    if (currentIndex === 0 || currentIndex === allSegments.length - 1) {
        return false;
    }

    var prevSegment = allSegments[currentIndex - 1];
    var nextSegment = allSegments[currentIndex + 1];

    // ä¸¥æ ¼æ£€æŸ¥å‰ä¸€ä¸ªè·¯æ®µæ˜¯å¦ä¸ºåœ°é“ï¼ˆåªæ ¹æ®transit_modeåˆ¤æ–­ï¼‰
    var prevIsSubway = prevSegment && prevSegment.transit_mode === 'SUBWAY';

    // ä¸¥æ ¼æ£€æŸ¥åä¸€ä¸ªè·¯æ®µæ˜¯å¦ä¸ºåœ°é“ï¼ˆåªæ ¹æ®transit_modeåˆ¤æ–­ï¼‰
    var nextIsSubway = nextSegment && nextSegment.transit_mode === 'SUBWAY';

    // æ£€æŸ¥å‰ä¸€ä¸ªåœ°é“è·¯æ®µæ˜¯å¦æœ‰å‡ºç«™å£ä¿¡æ¯ï¼ˆåªæ ¹æ®transit.exitå±æ€§åˆ¤æ–­ï¼‰
    var prevHasExit = false;
    if (prevIsSubway && prevSegment && prevSegment.transit && prevSegment.transit.exit && prevSegment.transit.exit.name) {
        prevHasExit = true;
    }

    // åªæœ‰å½“å‰åéƒ½æ˜¯åœ°é“ä¸”å‰ä¸€ä¸ªåœ°é“æ²¡æœ‰å‡ºç«™å£æ—¶ï¼Œæ‰æ˜¯ç«™å†…æ¢ä¹˜
    return prevIsSubway && nextIsSubway && !prevHasExit;
}

// æ ¼å¼åŒ–å…¬äº¤è·¯æ®µçš„æ˜¾ç¤ºå†…å®¹
function formatBusInstruction(segment) {
    try {
        var busInfo = {
            line: '',          // å…¬äº¤çº¿è·¯
            direction: '',     // æ–¹å‘
            stations: '',      // ä¹˜åç«™æ•°
            exit: '',          // å‡ºç«™å£
            tips: '',
            startTime: '',
            endTime: ''
        };

        // è·å–ç«™ç‚¹æ•°æ®çš„æ¥æº
        var linesSource = null;
        
        // ä¼˜å…ˆä»transit.linesè·å–
        if (segment.transit && segment.transit.lines && segment.transit.lines.length > 0) {
            linesSource = segment.transit.lines;
        }
        // å…¶æ¬¡ä»bus.buslinesè·å–
        else if (segment.bus && segment.bus.buslines && segment.bus.buslines.length > 0) {
            linesSource = segment.bus.buslines;
        }
        // å†å…¶æ¬¡ä»buslinesè·å–
        else if (segment.buslines && segment.buslines.length > 0) {
            linesSource = segment.buslines;
        }

        // ä»linesSourceè·å–æ‰€æœ‰çº¿è·¯åç§°
        if (linesSource) {
            var lineNames = [];
            for (var i = 0; i < linesSource.length; i++) {
                var line = linesSource[i];
                if (line.name) {
                    var lineName = line.name;
                    // å»æ‰æ¯ä¸ªçº¿è·¯åç§°ä¸­æ‹¬å·å†…çš„å†…å®¹
                    lineName = lineName.replace(/\([^)]*\)/g, '');
                    lineNames.push(lineName);
                }
            }
            if (lineNames.length > 0) {
                busInfo.line = lineNames.join('/');
            }
        }

        var departureStop = null;
        var arrivalStop = null;

        // ä»linesSourceçš„ç¬¬ä¸€æ¡çº¿è·¯è·å–ç«™ç‚¹ä¿¡æ¯
        if (linesSource && linesSource.length > 0) {
            var firstLine = linesSource[0];
            if (!departureStop && firstLine.departure_stop) {
                departureStop = firstLine.departure_stop;
            }
            if (!arrivalStop && firstLine.arrival_stop) {
                arrivalStop = firstLine.arrival_stop;
            }
            
        }

        // ä¼ ç»Ÿæ•°æ®æºè·å–ç«™ç‚¹ä¿¡æ¯
        if (!departureStop || !arrivalStop) {
            if (segment.bus && segment.bus.buslines && segment.bus.buslines[0]) {
                if (!departureStop) departureStop = segment.bus.buslines[0].departure_stop;
                if (!arrivalStop) arrivalStop = segment.bus.buslines[0].arrival_stop;
            } else if (segment.railway && segment.railway.lines && segment.railway.lines[0]) {
                if (!departureStop) departureStop = segment.railway.lines[0].departure_stop;
                if (!arrivalStop) arrivalStop = segment.railway.lines[0].arrival_stop;
            }
        }
        if (firstLine.via_num != '0') {
            busInfo.direction = firstLine.via_stops[0].name;
        } else if (arrivalStop && arrivalStop.name) {
            busInfo.direction = arrivalStop.name;
        }

        if (linesSource[0].bus_time_tips && linesSource[0].bus_time_tips !== '') {
            busInfo.tips = linesSource[0].bus_time_tips
        }
        if (linesSource[0].start_time && linesSource[0].start_time !== '') {
            busInfo.startTime = formatTime(linesSource[0].start_time)
        }
        if (linesSource[0].end_time && linesSource[0].end_time !== '') {
            busInfo.endTime = formatTime(linesSource[0].end_time)
        }

        var result = '';
        var stationInfoHtml = '';

        // æ„å»ºç«™ç‚¹ä¿¡æ¯è¡Œ
        if (departureStop && departureStop.name) {
            var stationInfo = 'ä¸Šè½¦ç«™ï¼š' + departureStop.name;
            if (busInfo.direction) {
                stationInfo += '&nbsp;&nbsp;&nbsp;&nbsp;ä¸‹ä¸€ç«™: ' + busInfo.direction;
            }
            stationInfoHtml = '<div class="subway-stop-item final-destination" style="border-left-color: #dcdcaa;font-size: 12px;margin-top: 5px">' + stationInfo + '</div>';
        }

        // ç»„åˆæœ€ç»ˆç»“æœ
        if (busInfo.line) {
            result = "<div>"+busInfo.line + '</div>';;
        }
        if (busInfo.startTime && busInfo.endTime) {
            result += '<div style="font-size: 12px;color: #8C8C8C">è¿è¥æ—¶é—´ï¼š' + busInfo.startTime+' - '+ busInfo.endTime+'</div>';
        }
        if (busInfo.tips) {
            result += '<div style="font-size: 12px;color: #8C8C8C">' + busInfo.tips + '</div>';
        }
        if (stationInfoHtml) {
            result = result ? (result +  stationInfoHtml) : stationInfoHtml;
        }

        return result || segment.instruction || ''; // å¦‚æœæ ¼å¼åŒ–å¤±è´¥ï¼Œè¿”å›åŸå§‹æŒ‡ä»¤

    } catch (error) {
        console.error('formatBusInstruction error:', error);
        return segment.instruction || ''; // å‡ºé”™æ—¶è¿”å›åŸå§‹æŒ‡ä»¤
    }
}

// æ ¼å¼åŒ–åœ°é“è·¯æ®µçš„æ˜¾ç¤ºå†…å®¹
function formatSubwayInstruction(segment) {
    try {
        var subwayInfo = {
            line: '',          // åœ°é“çº¿è·¯
            direction: '',     // æ–¹å‘
            stations: '',      // ä¹˜åç«™æ•°
            exit: '',          // å‡ºç«™å£
            tips: '',
            startTime: '',
            endTime: ''
        };

        // è·å–ç«™ç‚¹æ•°æ®çš„æ¥æº
        var linesSource = null;
        
        if (segment.transit && segment.transit.buslines && segment.transit.buslines.length > 0) {
            linesSource = segment.transit.buslines;
        }
        // å…¶æ¬¡ä»bus.buslinesè·å–
        else if (segment.bus && segment.bus.buslines && segment.bus.buslines.length > 0) {
            linesSource = segment.bus.buslines;
        }
        // å†å…¶æ¬¡ä»buslinesè·å–
        else if (segment.buslines && segment.buslines.length > 0) {
            linesSource = segment.buslines;
        }

        // ä»linesSourceè·å–æ‰€æœ‰çº¿è·¯åç§°
        if (linesSource) {
            var lineNames = [];
            for (var i = 0; i < linesSource.length; i++) {
                var line = linesSource[i];
                if (line.name) {
                    var lineName = line.name;
                    // å»æ‰æ¯ä¸ªçº¿è·¯åç§°ä¸­æ‹¬å·å†…çš„å†…å®¹
                    lineName = lineName.replace(/\([^)]*\)/g, '');
                    lineNames.push(lineName);
                }
            }
            if (lineNames.length > 0) {
                subwayInfo.line = lineNames.join('/');
            }
        }

        var departureStop = null;
        var arrivalStop = null;

        // ä»linesSourceçš„ç¬¬ä¸€æ¡çº¿è·¯è·å–ç«™ç‚¹ä¿¡æ¯
        if (linesSource && linesSource.length > 0) {
            var firstLine = linesSource[0];
            if (!departureStop && firstLine.departure_stop) {
                departureStop = firstLine.departure_stop;
            }
            if (!arrivalStop && firstLine.arrival_stop) {
                arrivalStop = firstLine.arrival_stop;
            }
        }

        // ä¼ ç»Ÿæ•°æ®æºè·å–ç«™ç‚¹ä¿¡æ¯
        if (!departureStop || !arrivalStop) {
            if (segment.bus && segment.bus.buslines && segment.bus.buslines[0]) {
                if (!departureStop) departureStop = segment.bus.buslines[0].departure_stop;
                if (!arrivalStop) arrivalStop = segment.bus.buslines[0].arrival_stop;
            } else if (segment.bus && segment.bus.buslines && segment.bus.buslines[0]) {
                if (!departureStop) departureStop = segment.bus.buslines[0].departure_stop;
                if (!arrivalStop) arrivalStop = segment.bus.buslines[0].arrival_stop;
            }
        }
        if (firstLine.via_num != '0') {
            subwayInfo.direction = firstLine.via_stops[0].name;
        } else if (arrivalStop && arrivalStop.name) {
            subwayInfo.direction = arrivalStop.name;
        }

        
        if (linesSource[0].bus_time_tips && linesSource[0].bus_time_tips !== '') {
            subwayInfo.tips = linesSource[0].bus_time_tips
        }
        if (linesSource[0].start_time && linesSource[0].start_time !== '') {
            subwayInfo.startTime = formatTime(linesSource[0].start_time)
        } else if (linesSource[0].station_start_time && linesSource[0].station_start_time !== '') {
            subwayInfo.startTime = formatTime(linesSource[0].station_start_time)
        }
        if (linesSource[0].end_time && linesSource[0].end_time !== '') {
            subwayInfo.endTime = formatTime(linesSource[0].end_time)
        } else if (linesSource[0].station_end_time && linesSource[0].station_end_time !== '') {
            subwayInfo.endTime = formatTime(linesSource[0].station_end_time)
        }
        
        var result = '';
        var stationInfoHtml = '';

        // æ„å»ºç«™ç‚¹ä¿¡æ¯è¡Œ
        if (departureStop && departureStop.name) {
            var stationInfo = 'ä¸Šè½¦ç«™ï¼š' + departureStop.name;
            if (subwayInfo.direction) {
                stationInfo += '&nbsp;&nbsp;&nbsp;&nbsp;ä¸‹ä¸€ç«™: ' + subwayInfo.direction;
            }
            stationInfoHtml = '<div class="subway-stop-item final-destination" style="border-left-color: #dcdcaa;font-size: 12px;margin-top: 5px">' + stationInfo + '</div>';
        }

        // ç»„åˆæœ€ç»ˆç»“æœ
        if (subwayInfo.line) {
            result = "<div>"+subwayInfo.line + '</div>';;
        }
        if (subwayInfo.startTime && subwayInfo.endTime) {
            result += '<div style="font-size: 12px;color: #8C8C8C">è¿è¥æ—¶é—´ï¼š' + subwayInfo.startTime+' - '+ subwayInfo.endTime+'</div>';
        }
        if (subwayInfo.tips) {
            result += '<div style="font-size: 12px;color: #8C8C8C">' + subwayInfo.tips + '</div>';
        }
        if (stationInfoHtml) {
            result = result ? (result +  stationInfoHtml) : stationInfoHtml;
        }

        return result || segment.instruction || ''; // å¦‚æœæ ¼å¼åŒ–å¤±è´¥ï¼Œè¿”å›åŸå§‹æŒ‡ä»¤

    } catch (error) {
        console.error('formatSubwayInstruction error:', error);
        return segment.instruction || ''; // å‡ºé”™æ—¶è¿”å›åŸå§‹æŒ‡ä»¤
    }
}

// ç”Ÿæˆæ­¥è¡ŒOMé“¾æ¥
function generateWalkOMLink(segment) {
    // æ£€æŸ¥æ˜¯å¦æ˜¯æ­¥è¡Œè·¯æ®µ
    if (!segment.instruction || segment.instruction !== 'æ­¥è¡Œ') {
        return '';
    }

    // ä»ä¸åŒå¯èƒ½çš„å±æ€§è·å–åæ ‡
    var startLocation = null;
    var endLocation = null;

    // ä»originè·å–èµ·ç‚¹åæ ‡
    if (segment.walking && segment.walking.origin) {
        var [lng, lat] = segment.walking.origin.split(',');
        var startLocation = {
            lng: parseFloat(lng), 
            lat: parseFloat(lat)  
        };

    }
    // ä»destinationè·å–ç»ˆç‚¹åæ ‡
    if (segment.walking && segment.walking.destination) {
        var [lng1, lat1] = segment.walking.destination.split(',');
        var endLocation = {
            lng: parseFloat(lng1), 
            lat: parseFloat(lat1)  
        };
    }

    if (!startLocation || !endLocation) {

        return '';
    }



    var startGcjLat = startLocation.lat;
    var startGcjLng = startLocation.lng;
    var endGcjLat = endLocation.lat;
    var endGcjLng = endLocation.lng;



    // æ£€æŸ¥åæ ‡æ˜¯å¦ä¸ºæœ‰æ•ˆæ•°å­—
    if (isNaN(startGcjLat) || isNaN(startGcjLng) || isNaN(endGcjLat) || isNaN(endGcjLng)) {

        return '';
    }

    try {
        // è½¬æ¢ä¸ºWGS-84åæ ‡
        var startWgs = gcj2wgs_exact(startGcjLat, startGcjLng);
        var endWgs = gcj2wgs_exact(endGcjLat, endGcjLng);



        // æ£€æŸ¥è½¬æ¢åçš„åæ ‡æ˜¯å¦æœ‰æ•ˆ
        if (isNaN(startWgs.lat) || isNaN(startWgs.lng) || isNaN(endWgs.lat) || isNaN(endWgs.lng)) {

            return '';
        }

        // æ„å»ºèµ·ç‚¹å’Œç»ˆç‚¹åœ°å€
        var saddr = 'æ­¥è¡Œèµ·ç‚¹';
        var daddr = 'æ­¥è¡Œç»ˆç‚¹';

        // ä»instructionä¸­æå–åœ°ç‚¹ä¿¡æ¯
        var instruction = segment.instruction || '';
        if (instruction) {
            // å°è¯•ä»æŒ‡ä»¤ä¸­æå–åœ°ç‚¹åç§°
            var matches = instruction.match(/åˆ°è¾¾(.+)/);
            if (matches && matches[1]) {
                daddr = matches[1].trim();
            }
        }

        // ç¼–ç åœ°å€
        saddr = encodeURIComponent(saddr);
        daddr = encodeURIComponent(daddr);

        // ç”ŸæˆOMé“¾æ¥
        var omLink = 'om://route?sll=' + startWgs.lat.toFixed(7) + ',' + startWgs.lng.toFixed(7) +
            '&saddr=' + saddr + '&dll=' + endWgs.lat.toFixed(7) + ',' + endWgs.lng.toFixed(7) +
            '&daddr=' + daddr + '&type=pedestrian';


        return '<a href="' + omLink + '" class="om-walk-link" title="åœ¨OMä¸­æ‰“å¼€æ­¥è¡Œå¯¼èˆª">å¯¼èˆª</a>';

    } catch (error) {
        console.error('generateWalkOMLink error:');
        return '';
    }
}

// æ¸²æŸ“å…¬äº¤ç«™ç‚¹åˆ—è¡¨
function renderBusStops(segment, segmentIndex, stepIndex) {

    var uniqueId = 'bus-stops-' + segmentIndex + '-' + stepIndex;
    var stops = null;

    // ç»Ÿä¸€ç›´æ¥ä»åŸå§‹busæ•°æ®è·å–
    if (segment.bus && segment.bus.buslines && segment.bus.buslines[0] && segment.bus.buslines[0].via_stops) {
        stops = segment.bus.buslines[0].via_stops;
    }
    // å…¶ä»–å¤‡ç”¨æ•°æ®æº
    else if (segment.bus && segment.bus.via_stops) {
        stops = segment.bus.via_stops;
    } else if (segment.via_stops) {
        stops = segment.via_stops;
    } else if (segment.railway && segment.railway.via_stops) {
        stops = segment.railway.via_stops;
    } else if (segment.transit && segment.transit.buslines && segment.transit.lines[0] && segment.transit.lines[0].via_stops) {
        stops = segment.transit.buslines[0].via_stops;
    }
    var stopsHtml = '';

    // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿stopså­˜åœ¨ä¸”æ˜¯æ•°ç»„
    if (!stops || !Array.isArray(stops)) {
        stops = [];
    }

    // è·å–ä¸Šè½¦ç«™å’Œä¸‹è½¦ç«™ä¿¡æ¯ - ç»Ÿä¸€ä½¿ç”¨transitæ•°æ®
    var departureStop = null;
    var arrivalStop = null;

    // å¤‡ç”¨æ•°æ®æº
    if (!departureStop || !arrivalStop) {
        if (segment.bus && segment.bus.buslines && segment.bus.buslines[0]) {
            if (!departureStop) departureStop = segment.bus.buslines[0].departure_stop;
            if (!arrivalStop) arrivalStop = segment.bus.buslines[0].arrival_stop;
        } else if (segment.railway && segment.railway.lines && segment.railway.lines[0]) {
            if (!departureStop) departureStop = segment.railway.lines[0].departure_stop;
            if (!arrivalStop) arrivalStop = segment.railway.lines[0].arrival_stop;
        }
    }

    // æ·»åŠ departure_stopä½œä¸ºç¬¬ä¸€ç«™ï¼ˆä¸Šè½¦ç«™ï¼‰
    if (departureStop && departureStop.name) {
        var onStationName = departureStop.name;
        stopsHtml += `<div class="subway-stop-item" style="border-left-color: #dcdcaa; font-weight: bold;">${onStationName}</div>`;
    }

    // ç”Ÿæˆç«™ç‚¹åˆ—è¡¨
    stops.forEach(function (stop, index) {
        if (stop && stop.name) {
            var stopInfo = stop.name;            
            stopsHtml += `<div class="subway-stop-item">${stopInfo}</div>`;
        }
    });

    // æ·»åŠ arrival_stopä½œä¸ºæœ€åä¸€ç«™
    if (arrivalStop && arrivalStop.name) {
        var offStationName = arrivalStop.name;
        stopsHtml += `<div class="subway-stop-item"  style="border-left-color: #dcdcaa; font-weight: bold;">${offStationName}</div>`;
    }

    // è®¡ç®—å®é™…ä¹˜åçš„ç«™ç‚¹æ•°ï¼ˆä»å‡ºå‘ç«™åˆ°åˆ°è¾¾ç«™ï¼‰
    var totalRidingStops = stops.length; // via_stopsä¸­çš„ç«™ç‚¹æ•°
    if (departureStop && departureStop.name && arrivalStop && arrivalStop.name) {
        // å¦‚æœæœ‰æ˜ç¡®çš„èµ·æ­¢ç«™ï¼Œä¹˜åç«™æ•° = via_stopsç«™ç‚¹æ•° + 1
        totalRidingStops = stops.length + 1;
    } else if (departureStop && departureStop.name && !arrivalStop) {
        // åªæœ‰å‡ºå‘ç«™
        totalRidingStops = stops.length;
    } else if (!departureStop && arrivalStop && arrivalStop.name) {
        // åªæœ‰åˆ°è¾¾ç«™
        totalRidingStops = stops.length + 1;
    }
    var viaStopsCount = Math.max(0, totalRidingStops);

    // æ„å»ºä¸‹è½¦ç«™ä¿¡æ¯ï¼ˆç±»ä¼¼åœ°é“çš„å¤„ç†æ–¹å¼ï¼‰
    var stationInfoHtml = '';
    if (arrivalStop && arrivalStop.name) {
        var offStationName = arrivalStop.name;
        stationInfoHtml += `<div class="subway-stop-item final-destination" style="border-left-color: #dcdcaa;font-size: 12px;">ä¸‹è½¦ç«™ï¼š ${offStationName}</div>`;
    }

    return `
                <div class="subway-stops">
                    <div class="subway-stops-header" onclick="toggleBusStops('${uniqueId}')">
                        â–¶ ä¹˜å ${viaStopsCount} ç«™
                    </div>
                    <div id="${uniqueId}" class="subway-stops-list">
                        ${stopsHtml}
                    </div>
                </div>
                ${stationInfoHtml}
            `;
}

// æ¸²æŸ“åœ°é“ç«™ç‚¹åˆ—è¡¨
function renderSubwayStops(segment, segmentIndex, stepIndex) {

    var uniqueId = 'subway-stops-' + segmentIndex + '-' + stepIndex;
    var stops = null;

    // ç»Ÿä¸€ç›´æ¥ä»åŸå§‹busæ•°æ®è·å–
    if (segment.bus && segment.bus.buslines && segment.bus.buslines[0] && segment.bus.buslines[0].via_stops) {
        stops = segment.bus.buslines[0].via_stops;
    }
    // å…¶ä»–å¤‡ç”¨æ•°æ®æº
    else if (segment.bus && segment.bus.via_stops) {
        stops = segment.bus.via_stops;
    } else if (segment.via_stops) {
        stops = segment.via_stops;
    } else if (segment.railway && segment.railway.via_stops) {
        stops = segment.railway.via_stops;
    } else if (segment.transit && segment.transit.lines && segment.transit.lines[0] && segment.transit.lines[0].via_stops) {
        stops = segment.transit.lines[0].via_stops;
    }
    var stopsHtml = '';

    // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿stopså­˜åœ¨ä¸”æ˜¯æ•°ç»„
    if (!stops || !Array.isArray(stops)) {
        stops = [];
    }

    // è·å–ä¸Šè½¦ç«™å’Œä¸‹è½¦ç«™ä¿¡æ¯
    var departureStop = null;
    var arrivalStop = null;

    // å¤‡ç”¨æ•°æ®æº
    if (!departureStop || !arrivalStop) {
        if (segment.bus && segment.bus.buslines && segment.bus.buslines[0]) {
            if (!departureStop) departureStop = segment.bus.buslines[0].departure_stop;
            if (!arrivalStop) arrivalStop = segment.bus.buslines[0].arrival_stop;
        } else if (segment.railway && segment.railway.lines && segment.railway.lines[0]) {
            if (!departureStop) departureStop = segment.railway.lines[0].departure_stop;
            if (!arrivalStop) arrivalStop = segment.railway.lines[0].arrival_stop;
        }
    }

    // æ·»åŠ departure_stopä½œä¸ºç¬¬ä¸€ç«™ï¼ˆä¸Šè½¦ç«™ï¼‰
    if (departureStop && departureStop.name) {
        var onStationName = departureStop.name;
        stopsHtml += `<div class="subway-stop-item"  style="border-left-color: #dcdcaa; font-weight: bold;">${onStationName}</div>`;
    }
    
    
    // ç”Ÿæˆç«™ç‚¹åˆ—è¡¨
    stops.forEach(function (stop, index) {
        if (stop && stop.name) {
            var stopInfo = stop.name;
            stopsHtml += `<div class="subway-stop-item">${stopInfo}</div>`;
        }
    });

    // æ·»åŠ arrival_stopä½œä¸ºæœ€åä¸€ç«™
    if (arrivalStop && arrivalStop.name) {
        var offStationName = arrivalStop.name;
        stopsHtml += `<div class="subway-stop-item"  style="border-left-color: #dcdcaa; font-weight: bold;">${offStationName}</div>`;
    }
    // è®¡ç®—å®é™…ä¹˜åçš„ç«™ç‚¹æ•°ï¼ˆä»å‡ºå‘ç«™åˆ°åˆ°è¾¾ç«™ï¼‰
    var totalRidingStops = stops.length; // via_stopsä¸­çš„ç«™ç‚¹æ•°
    if (departureStop && departureStop.name && arrivalStop && arrivalStop.name) {
        // å¦‚æœæœ‰æ˜ç¡®çš„èµ·æ­¢ç«™ï¼Œä¹˜åç«™æ•° = via_stopsç«™ç‚¹æ•° + 1
        totalRidingStops = stops.length + 1;
    } else if (departureStop && departureStop.name && !arrivalStop) {
        totalRidingStops = stops.length;
    } else if (!departureStop && arrivalStop && arrivalStop.name) {
        totalRidingStops = stops.length + 1;
    }
    var viaStopsCount = Math.max(0, totalRidingStops);

    // æ„å»ºä¸‹è½¦ç«™å’Œå‡ºç«™å£ä¿¡æ¯
    var stationInfoHtml = '';
    if (arrivalStop && arrivalStop.name) {
        var offStationName = arrivalStop.name;

        // æ·»åŠ å‡ºç«™å£ä¿¡æ¯
        var exitInfo = '';
        if (segment.bus && segment.bus.buslines && segment.bus.buslines[0] && segment.bus.buslines[0].arrival_stop && segment.bus.buslines[0].arrival_stop.exit && segment.bus.buslines[0].arrival_stop.exit.name ) {
            exitInfo = segment.bus.buslines[0].arrival_stop.exit.name;
        } else {
            // å°è¯•ä»æŒ‡ä»¤ä¸­æå–å‡ºç«™å£ä¿¡æ¯
            var instruction = segment.instruction || '';
            var exitMatch = instruction.match(/([A-Z0-9]+å·?å‡ºç«™å£|[A-Z0-9]+å‡ºç«™å£|å‡ºç«™å£[A-Z0-9]+)/i);
            if (exitMatch) {
                exitInfo = exitMatch[1];
            }
        }
        if (exitInfo != "") {
            stationInfoHtml += `<div class="subway-stop-item final-destination" style="border-left-color: #dcdcaa;font-size: 12px;">ä¸‹è½¦ç«™ï¼š ${offStationName}&nbsp;&nbsp;&nbsp;&nbsp;å‡ºç«™å£: ${exitInfo}</div>`;
        } else {
            stationInfoHtml += `<div class="subway-stop-item final-destination" style="border-left-color: #dcdcaa;font-size: 12px;">ä¸‹è½¦ç«™ï¼š ${offStationName}</div>`;
        }
    }

    return `
                <div class="subway-stops">
                    <div class="subway-stops-header" onclick="toggleSubwayStops('${uniqueId}')">
                        â–¶ ä¹˜å ${viaStopsCount} ç«™
                    </div>
                    <div id="${uniqueId}" class="subway-stops-list">
                        ${stopsHtml}
                    </div></div>
                    ${stationInfoHtml}
                
            `;
}

// åˆ‡æ¢å…¬äº¤ç«™ç‚¹åˆ—è¡¨æ˜¾ç¤º
function toggleBusStops(uniqueId) {
    var stopsList = document.getElementById(uniqueId);

    // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
    if (!stopsList) {
        console.warn('å…¬äº¤ç«™ç‚¹åˆ—è¡¨å…ƒç´ æœªæ‰¾åˆ°: ' + uniqueId);
        return;
    }

    var header = stopsList.previousElementSibling;

    // æ£€æŸ¥headeræ˜¯å¦å­˜åœ¨
    if (!header) {
        console.warn('å…¬äº¤ç«™ç‚¹åˆ—è¡¨å¤´éƒ¨å…ƒç´ æœªæ‰¾åˆ°');
        return;
    }

    var isExpanded = stopsList.classList.contains('expanded');
    var stopsCount = Math.max(0, stopsList.children.length - 1); // å‡å»èµ·å§‹ç«™ï¼Œæ˜¾ç¤ºé€”å¾„ç«™æ•°

    if (isExpanded) {
        stopsList.classList.remove('expanded');
        header.innerHTML = 'â–¶ ä¹˜å ' + stopsCount + ' ç«™';
    } else {
        stopsList.classList.add('expanded');
        header.innerHTML = 'â–¼ ä¹˜å ' + stopsCount + ' ç«™';
    }
}

// åˆ‡æ¢åœ°é“ç«™ç‚¹åˆ—è¡¨æ˜¾ç¤º
function toggleSubwayStops(uniqueId) {
    var stopsList = document.getElementById(uniqueId);

    // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
    if (!stopsList) {
        console.warn('åœ°é“ç«™ç‚¹åˆ—è¡¨å…ƒç´ æœªæ‰¾åˆ°: ' + uniqueId);
        return;
    }

    var header = stopsList.previousElementSibling;

    // æ£€æŸ¥headeræ˜¯å¦å­˜åœ¨
    if (!header) {
        console.warn('åœ°é“ç«™ç‚¹åˆ—è¡¨å¤´éƒ¨å…ƒç´ æœªæ‰¾åˆ°');
        return;
    }

    var isExpanded = stopsList.classList.contains('expanded');
    var stopsCount = Math.max(0, stopsList.children.length - 1); // å‡å»èµ·å§‹ç«™ï¼Œæ˜¾ç¤ºé€”å¾„ç«™æ•°

    if (isExpanded) {
        stopsList.classList.remove('expanded');
        header.innerHTML = 'â–¶ ä¹˜å ' + stopsCount + ' ç«™';
    } else {
        stopsList.classList.add('expanded');
        header.innerHTML = 'â–¼ ä¹˜å ' + stopsCount + ' ç«™';
    }
}

// æ¸²æŸ“è·¯çº¿æ­¥éª¤
function renderSteps(segments, routeIndex) {
    var stepsHtml = '<div class="route-steps-content">';
    var previousStep = ''; 

    segments.forEach(function (segment, index) {
        var segmentElements = [];
        
        if (segment.walking) {
            segmentElements.push({
                type: 'WALK',
                data: segment.walking,
                original_segment: segment
            });
        }
        if (segment.bus && segment.bus.buslines[0].type !== 'åœ°é“çº¿è·¯') {
            segmentElements.push({
                type: 'BUS', 
                data: segment.bus,
                original_segment: segment
            });
        }
        if (segment.bus && segment.bus.buslines[0].type === 'åœ°é“çº¿è·¯') {
            segmentElements.push({
                type: 'RAILWAY',
                data: segment.bus,
                original_segment: segment
            });
        }

        if (segmentElements.length <= 1) {
            var elementToProcess = segmentElements.length === 1 ? segmentElements[0] : { type: segment.transit_mode || 'WALK', data: segment, original_segment: segment };
            var stepHtml = renderSingleStep(elementToProcess, index, segments, routeIndex);
            if (!areStepsSimilar(previousStep, stepHtml)) {
                stepsHtml += stepHtml;
                previousStep = stepHtml; // ä¿å­˜å½“å‰æ­¥éª¤  
            } 
        } else {
            segmentElements.forEach(function (element, elementIndex) {
                var adjustedIndex = index + (elementIndex * 0.1);
                var stepHtml = renderSingleStep(element, adjustedIndex, segments, routeIndex);
                
                // æ£€æŸ¥æ˜¯å¦æœ‰è¿ç»­ä¸¤ä¸ªç›¸åŒçš„æ­¥éª¤
                if (!areStepsSimilar(previousStep, stepHtml)) {
                    stepsHtml += stepHtml;
                    previousStep = stepHtml; // ä¿å­˜å½“å‰æ­¥éª¤  
                } 
            });
        }
    });

    stepsHtml += '</div>';
    return stepsHtml;
}

function areStepsSimilar(stepHtml1, stepHtml2) {
    // åˆ›å»ºä¸€ä¸ªå‡½æ•°ç”¨æ¥æ¸…ç†HTMLï¼Œç§»é™¤ä¸éœ€è¦æ¯”è¾ƒçš„éƒ¨åˆ†
    function cleanStepHtml(stepHtml) {
        // ç§»é™¤ID
        stepHtml = stepHtml.replace(/<div id=".*?">/, '<div id="placeholder">');
        // ç§»é™¤onclick
        stepHtml = stepHtml.replace(/onclick="toggleBusStops\(.*?\)"/, 'onclick="toggleBusStops(\'placeholder\')"');
        // ç§»é™¤æ—¶é—´éƒ¨åˆ†
        stepHtml = stepHtml.replace(/æ—¶é—´ï¼š.*?<\/span>/, 'æ—¶é—´ï¼šplaceholder</span>');
        stepHtml = stepHtml.replace(/è·ç¦»ï¼š.*?<\/span>/, 'è·ç¦»ï¼šplaceholder</span>');
        return stepHtml;
    }

    // æ¸…ç†ä¸¤ä¸ªstepHtml
    const cleanedStepHtml1 = cleanStepHtml(stepHtml1);
    const cleanedStepHtml2 = cleanStepHtml(stepHtml2);

    // æ¯”è¾ƒæ¸…ç†åçš„å†…å®¹
    return cleanedStepHtml1 === cleanedStepHtml2;
}

// æ¸²æŸ“å•ä¸ªæ­¥éª¤ï¼ˆæ–°å‡½æ•°ï¼Œå¤„ç†å•ä¸ªå…ƒç´ ï¼‰
function renderSingleStep(element, index, segments, routeIndex) {
    var segment = element.original_segment;
    var type = element.type;
    var currentData = element.data;
    
    // æ ¹æ®å…ƒç´ ç±»å‹ç”Ÿæˆå›¾æ ‡å’Œæ–‡å­—
    var iconClass, iconText;
    if (type === 'WALK') {
        iconClass = 'walk';
        iconText = 'æ­¥è¡Œ';
    } else if (type === 'SUBWAY' || type === 'RAILWAY') {
        iconClass = 'metro';
        iconText = 'åœ°é“';
    } else {
        iconClass = 'bus';
        iconText = 'å…¬äº¤';
    }

    // ä»å½“å‰å…ƒç´ æ•°æ®ä¸­è·å–æ—¶é—´å’Œè·ç¦»ä¿¡æ¯
    var durationInfo = '';
    var distanceInfo = '';
    
    if (currentData && currentData.cost && currentData.cost.duration) {
        durationInfo = formatDuration(currentData.cost.duration);
    } else if (segment && segment.duration) {
        durationInfo = formatDuration(segment.duration);
    }
    
    if (currentData && currentData.distance) {
        distanceInfo = formatDistance(currentData.distance);
    } else if (segment && segment.distance) {
        distanceInfo = formatDistance(segment.distance);
    }

    var walkLink = '';
    var elementInstruction = '';
    var subwayStopsHtml = '';
    var busStopsHtml = '';

    // å¦‚æœæ˜¯æ­¥è¡Œè·¯æ®µï¼Œæ£€æŸ¥æ˜¯å¦ä¸ºç«™å†…æ¢ä¹˜ï¼Œå¦åˆ™ç”ŸæˆOMå¯¼èˆªé“¾æ¥
    if (type === 'WALK') {
        elementInstruction = 'æ­¥è¡Œ';
        // æ£€æŸ¥å‰åè·¯æ®µæ˜¯å¦éƒ½æ˜¯åœ°é“
        var isStationTransfer = checkStationTransfer(segments, Math.floor(index));

        if (isStationTransfer) {
            walkLink = '<span style="color: #c586c0; font-size: 12px;">ç«™å†…æ¢ä¹˜</span>';
        } else {
            
            // ä¸ºæ­¥è¡Œå…ƒç´ åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„segmentå¯¹è±¡
            var walkingSegment = {
                walking: currentData,
                instruction: elementInstruction
            };
            walkLink = generateWalkOMLink(walkingSegment);
        }
    }
    // å¤„ç†å…¬äº¤è·¯æ®µ
    else if (type === 'BUS') {
        // ä¸ºå…¬äº¤å…ƒç´ åˆ›å»ºä¸€ä¸ªä¸“é—¨çš„segmentå¯¹è±¡ï¼Œä¸ä¾èµ–åŸå§‹segment
        var busSegment = {
            transit: currentData,
            bus: currentData,
            instruction: elementInstruction,
            transit_mode: 'BUS'
        };
        
        // å°è¯•ä»å…¬äº¤è·¯æ®µæ•°æ®ä¸­æå–ä¿¡æ¯
        var formattedInstruction = formatBusInstruction(busSegment);
        if (formattedInstruction) {
            elementInstruction = formattedInstruction.replace(/ï¼Œä¹˜å\d+ç«™/, '').replace(/ä¹˜å\d+ç«™ï¼Œ/, '').replace(/ä¹˜å\d+ç«™/, '');
        } else {
            // å¤‡ç”¨æ–¹æ¡ˆï¼šä»æ•°æ®ä¸­ç”ŸæˆæŒ‡ä»¤
            if (currentData && currentData.buslines && currentData.buslines.length > 0) {
                var firstLine = currentData.buslines[0];
                var lineNames = [];
                if (firstLine.name) {
                    var lineName = firstLine.name.replace(/\([^)]*\)/g, ''); // å»æ‰æ‹¬å·å†…å®¹
                    lineNames.push(lineName);
                }
                if (lineNames.length > 0) {
                    elementInstruction = lineNames.join('/');
                    if (firstLine.departure_stop && firstLine.departure_stop.name) {
                        elementInstruction += 'ï¼Œä¸Šè½¦ç«™ï¼š' + firstLine.departure_stop.name;
                    }
                    if (firstLine.via_stops[1] && firstLine.via_stops[1].name) {
                        elementInstruction += 'ï¼Œä¸‹ä¸€ç«™ï¼š' + firstLine.via_stops[1].name;
                    }
                }
            }
        }
        if (!elementInstruction) {
            elementInstruction = 'ä¹˜åå…¬äº¤';
        }

        // ç”Ÿæˆå…¬äº¤ç«™ç‚¹åˆ—è¡¨
        busStopsHtml = renderBusStops(busSegment, routeIndex, index);
    }
    // å¤„ç†åœ°é“è·¯æ®µ
    else if (type === 'SUBWAY' || type === 'RAILWAY') {
        // ä¸ºåœ°é“å…ƒç´ åˆ›å»ºä¸€ä¸ªä¸“é—¨çš„segmentå¯¹è±¡ï¼Œä¸ä¾èµ–åŸå§‹segment
        var subwaySegment = {
            transit: currentData,
            bus: currentData,
            instruction: elementInstruction,
            transit_mode: type
        };
        
        // å°è¯•ä»åœ°é“è·¯æ®µæ•°æ®ä¸­æå–ä¿¡æ¯
        var formattedInstruction = formatSubwayInstruction(subwaySegment);
        if (formattedInstruction) {
            elementInstruction = formattedInstruction.replace(/ï¼Œä¹˜å\d+ç«™/, '');
        } else {
            // å¤‡ç”¨æ–¹æ¡ˆï¼šä»æ•°æ®ä¸­ç”ŸæˆæŒ‡ä»¤
            if (currentData && currentData.buslines && currentData.buslines.length > 0) {
                var lineNames = [];
                currentData.buslines.forEach(function(line) {
                    if (line.name) {
                        var lineName = line.name.replace(/\([^)]*\)/g, ''); // å»æ‰æ‹¬å·å†…å®¹
                        lineNames.push(lineName);
                    }
                });
                if (lineNames.length > 0) {
                    elementInstruction = lineNames.join('/');
                    if (currentData.buslines[0].departureStop && currentData.buslines[0].departureStop.name) {
                        elementInstruction += 'ï¼Œä¸Šè½¦ç«™ï¼š' + currentData.buslines[0].departureStop.name;
                    }
                    if (currentData.buslines[0].viaStops[1] && currentData.buslines[0].viaStops[1].name) {
                        elementInstruction += 'ï¼Œä¸‹ä¸€ç«™ï¼š' + currentData.buslines[0].viaStops[1].name;
                    }
                }
            }
        }
        if (!elementInstruction) {
            elementInstruction = 'ä¹˜ååœ°é“';
        }

        // ç”Ÿæˆåœ°é“ç«™ç‚¹åˆ—è¡¨
        subwayStopsHtml = renderSubwayStops(subwaySegment, routeIndex, index);
    }

    var stepHtml = `
                <div class="step-item">
                    <div class="step-icon ${iconClass}">${iconText}</div>
                    <div class="step-content">
                        <div class="step-instruction">${elementInstruction}</div>
                        <div class="step-details">
                            <div>
                                ${durationInfo ? '<span style="color: #4ec9b0;">æ—¶é—´ï¼š' + durationInfo + '</span>' : ''} 
                                ${distanceInfo ? '<span style="color: #569cd6;">è·ç¦»ï¼š' + distanceInfo + '</span>' : ''}
                            </div>
                            <div>
                                ${walkLink}
                            </div>
                        </div>
                        ${subwayStopsHtml}
                        ${busStopsHtml}
                    </div>
                </div>
            `;

    return stepHtml;
}

// æ¸²æŸ“è·¯çº¿
function renderRoute(route, index) {
    var transportTypes = getTransportSummary(route.segments);
    var actualCost = getActualCost(route);
    var walkingDistance = getWalkingDistance(route.segments);

    // ç”Ÿæˆäº¤é€šæ–¹å¼å¾½ç« 
    var transportBadges = transportTypes.map(function (type) {
        var badgeClass = type === 'æ­¥è¡Œ' ? 'walk' : (type === 'åœ°é“' ? 'metro' : 'bus');
        return `<span class="transport-badge ${badgeClass}">${type}</span>`;
    }).join('');

    // æ ¹æ®æ˜¯å¦æœ‰è´¹ç”¨ä¿¡æ¯æ¥å†³å®šæ˜¾ç¤ºå†…å®¹
    var costDisplay = actualCost !== null && actualCost !== undefined ?
        `<div class="route-cost">Â¥${actualCost}</div>` : '';

    var routeHtml = `
                <div class="route-item" data-route-index="${index}">
                    <div class="route-header" onclick="toggleRoute(${index})">
                        <div class="route-title">
                            <div class="expand-icon" id="expand-icon-${index}"></div>
                            #${index + 1}
                        </div>
                        <div class="route-summary">
                            <div class="route-time">${formatDuration(route.time)}</div>
                            <div class="route-distance">æ­¥è¡Œ${formatDistance(walkingDistance)}</div>
                            ${costDisplay}
                        </div>
                    </div>
                    <div class="route-steps" id="route-steps-${index}">
                        ${renderSteps(route.segments, index)}
                    </div>
                </div>
            `;
    return routeHtml;
}

// æŠ˜å /å±•å¼€è·¯çº¿
function toggleRoute(index) {
    var allRouteSteps = document.querySelectorAll('.route-steps');
    var allExpandIcons = document.querySelectorAll('.expand-icon');
    var allRouteHeaders = document.querySelectorAll('.route-header');

    // æŠ˜å æ‰€æœ‰å…¶ä»–è·¯çº¿
    for (var i = 0; i < allRouteSteps.length; i++) {
        if (i !== index) {
            allRouteSteps[i].classList.remove('expanded');
            allExpandIcons[i].classList.remove('expanded');
            allRouteHeaders[i].classList.remove('expanded');
        }
    }

    // åˆ‡æ¢å½“å‰è·¯çº¿
    var currentSteps = document.getElementById('route-steps-' + index);
    var currentIcon = document.getElementById('expand-icon-' + index);
    var currentHeader = currentSteps.previousElementSibling;

    if (currentSteps.classList.contains('expanded')) {
        // å¦‚æœå½“å‰å·²å±•å¼€ï¼Œåˆ™æŠ˜å 
        currentSteps.classList.remove('expanded');
        currentIcon.classList.remove('expanded');
        currentHeader.classList.remove('expanded');
    } else {
        // å±•å¼€å½“å‰è·¯çº¿
        currentSteps.classList.add('expanded');
        currentIcon.classList.add('expanded');
        currentHeader.classList.add('expanded');
    }
}

// æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
function showError(message) {
    var errorDiv = document.getElementById('error');
    errorDiv.textContent = message;
    errorDiv.classList.remove('hidden');

    setTimeout(function () {
        errorDiv.classList.add('hidden');
    }, 5000);
}

// æœç´¢è·¯çº¿ - Web APIç‰ˆæœ¬
function searchRoute() {
    // æ£€æŸ¥APIé…ç½®
    try {
        checkAmapAPILoaded();
        if (!window.AMAP_CONFIG || !window.AMAP_CONFIG.webApiKey) {
            throw new Error('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®Web API Key');
        }
    } catch (error) {
        showError(error.message);
        return;
    }
    
    var city = document.getElementById('cityinput').value.trim();
    var startKeyword = document.getElementById('startinput').value.trim();
    var endKeyword = document.getElementById('endinput').value.trim();

    // ä¿å­˜èµ·ç»ˆç‚¹åˆ°æœ¬åœ°å­˜å‚¨
    saveStartEnd();

    if (!city) {
        showError('è¯·å¡«å†™åŸå¸‚');
        return;
    }

    if (!startKeyword) {
        showError('è¯·è¾“å…¥å‡ºå‘åœ°');
        return;
    }

    if (!endKeyword) {
        showError('è¯·è¾“å…¥ç›®çš„åœ°');
        return;
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    document.getElementById('loading').classList.remove('hidden');
    document.getElementById('result').classList.add('hidden');
    document.getElementById('error').classList.add('hidden');
    document.getElementById('search-btn').disabled = true;

    // æœç´¢èµ·ç‚¹å’Œç»ˆç‚¹åæ ‡
    var startSearchPromise = new Promise(function (resolve) {
        if (startLocation) {
            resolve(startLocation);
        } else {
            searchLocation(startKeyword, city, true, resolve);
        }
    });

    var endSearchPromise = new Promise(function (resolve) {
        if (endLocation) {
            resolve(endLocation);
        } else {
            searchLocation(endKeyword, city, false, resolve);
        }
    });

    Promise.all([startSearchPromise, endSearchPromise]).then(function (locations) {
        var startLoc = locations[0];
        var endLoc = locations[1];

        if (!startLoc || !endLoc) {
            throw new Error('æ— æ³•æ‰¾åˆ°èµ·ç‚¹æˆ–ç»ˆç‚¹çš„ä½ç½®ä¿¡æ¯');
        }

        // è·å–å‡ºå‘æ—¶é—´
        var departureTime = getDepartureTimestamp();

        // ä½¿ç”¨Web APIè¿›è¡Œå…¬äº¤è·¯å¾„è§„åˆ’
        searchTransitRouteWebAPI(startLoc, endLoc, city, departureTime);

    }).catch(function (error) {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('search-btn').disabled = false;
        showError(error.message);
    });
}

// ä½¿ç”¨Web APIè¿›è¡Œå…¬äº¤è·¯å¾„è§„åˆ’
function searchTransitRouteWebAPI(startLoc, endLoc, city, departureTime) {
    // æ£€æŸ¥webApiKeyæ˜¯å¦å·²è®¾ç½®
    if (!window.AMAP_CONFIG || !window.AMAP_CONFIG.webApiKey) {
        throw new Error('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®Web API Key');
    }
    
    // æ„å»ºAPIè¯·æ±‚URL
    var baseUrl = 'https://restapi.amap.com/v5/direction/transit/integrated';
    var params = new URLSearchParams();

    // è·å–åŸå¸‚ç¼–ç ï¼Œä¼˜å…ˆä½¿ç”¨ç¼–ç ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ™ä½¿ç”¨åŸå§‹åŸå¸‚å
    var cityCode = getCurrentCityCode();
    var cityToUse = cityCode || city;

    // å¿…å¡«å‚æ•°
    params.append('key', window.AMAP_CONFIG.webApiKey);
    params.append('origin', startLoc.lng + ',' + startLoc.lat);
    params.append('destination', endLoc.lng + ',' + endLoc.lat);
    params.append('city1', cityToUse);
    params.append('city2', cityToUse);
    params.append('show_fields', 'cost');

    // å¯é€‰å‚æ•° - ç­–ç•¥å€¼å¿…é¡»ä½¿ç”¨æ•°å­—å­—ç¬¦ä¸²
    var strategyValue = getPolicyValue();
    // ç¡®ä¿ç­–ç•¥å€¼æ˜¯æœ‰æ•ˆçš„æ•°å­—å­—ç¬¦ä¸²ï¼ˆ0-8ï¼‰
    var validStrategies = ['0', '1', '2', '3', '4', '5', '7', '8'];
    var mappedStrategy = validStrategies.includes(strategyValue) ? strategyValue : '0';
    params.append('strategy', mappedStrategy);
    params.append('alternative_route', '8'); // è¿”å›5æ¡è·¯çº¿
    params.append('night_flag', '1'); // è€ƒè™‘å¤œç­è½¦

    // å¦‚æœæœ‰å‡ºå‘æ—¶é—´ï¼Œæ·»åŠ æ—¶é—´å‚æ•°
    if (departureTime) {
        var date = new Date(departureTime * 1000);
        var dateStr = date.getFullYear() + '-' +
            String(date.getMonth() + 1).padStart(2, '0') + '-' +
            String(date.getDate()).padStart(2, '0');
        var timeStr = String(date.getHours()).padStart(2, '0') + '-' +
            String(date.getMinutes()).padStart(2, '0');
        params.append('date', dateStr);
        params.append('time', timeStr);
    }

    // å‘é€è¯·æ±‚
    var requestUrl = baseUrl + '?' + params.toString();

    fetch(requestUrl)
        .then(function (response) {
            if (!response.ok) {
                throw new Error('HTTP ' + response.status + ': ' + response.statusText);
            }
            return response.json();
        })
        .then(function (data) {
            handleWebAPIResult(data);
        })
        .catch(function (error) {
            console.error('Web APIè¯·æ±‚é”™è¯¯:', error);
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('search-btn').disabled = false;
            showError('è·¯çº¿è§„åˆ’å¤±è´¥ï¼š' + error.message);
        });
}

// å¤„ç†Web APIè·¯çº¿æœç´¢ç»“æœ
function handleWebAPIResult(data) {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('search-btn').disabled = false;


    if (data.status === '1' && data.route && data.route.transits && data.route.transits.length > 0) {

        // æˆåŠŸè·å–è·¯çº¿ï¼Œæ·»åŠ åˆ°å†å²è®°å½•
        var startValue = document.getElementById('startinput').value.trim();
        var endValue = document.getElementById('endinput').value.trim();

        if (startValue) {
            updateSearchHistory(startValue, startValue, 'start');
        }
        if (endValue) {
            updateSearchHistory(endValue, endValue, 'end');
        }

        // è½¬æ¢Web APIæ•°æ®æ ¼å¼ä¸ºåŸæ¥çš„æ ¼å¼
        var convertedPlans = convertWebAPIToLegacyFormat(data.route.transits);

        var routesHtml = '';
        convertedPlans.forEach(function (plan, index) {
            routesHtml += renderRoute(plan, index);
        });

        document.getElementById('routes-container').innerHTML = routesHtml;
        document.getElementById('result').classList.remove('hidden');

    } else {
        var errorMsg = 'è·¯çº¿è§„åˆ’å¤±è´¥ï¼š';
        if (data.status !== '1') {
            errorMsg += 'APIçŠ¶æ€ç ï¼š' + data.status;
            if (data.info) {
                errorMsg += 'ï¼Œ' + data.info;
            }
            if (data.error_code) {
                errorMsg += 'ï¼ˆé”™è¯¯ä»£ç ï¼š' + data.error_code + 'ï¼‰';
            }
        } else if (!data.route) {
            errorMsg += 'æœªæ‰¾åˆ°è·¯çº¿æ•°æ®';
        } else if (!data.route.transits) {
            errorMsg += 'æœªæ‰¾åˆ°å…¬äº¤è·¯çº¿';
        } else if (data.route.transits.length === 0) {
            errorMsg += 'è¯¥è·¯çº¿æš‚æ— å…¬äº¤æ–¹æ¡ˆ';
        } else {
            errorMsg += 'æœªçŸ¥é”™è¯¯';
        }
        showError(errorMsg);
    }
}

// å°†Web APIæ•°æ®æ ¼å¼è½¬æ¢ä¸ºåŸæ¥çš„æ ¼å¼
function convertWebAPIToLegacyFormat(transits) {
    return transits.map(function (transit, transitIndex) {
        var segments = [];

        if (transit.segments) {
            segments = [];
            
            transit.segments.forEach(function (segment, index) {
                // å¤„ç†åŒ…å«å¤šç§äº¤é€šæ–¹å¼çš„è·¯æ®µ
                var processedSegments = [];
                
                // å¤„ç†æ­¥è¡Œè·¯æ®µ
                if (segment.walking) {
                    var walkingInstruction = 'æ­¥è¡Œ';
                    if (segment.walking.steps && segment.walking.steps.length > 0) {
                        var lastStep = segment.walking.steps[segment.walking.steps.length - 1];
                        walkingInstruction = lastStep.instruction || 'æ­¥è¡Œ';
                    }
                    
                    var walkingSegment = {
                        instruction: walkingInstruction,
                        duration: segment.walking.cost ? parseInt(segment.walking.cost.duration) || 0 : 0,
                        distance: parseInt(segment.walking.distance) || 0,
                        transit_mode: 'WALK',
                        time: segment.walking.cost ? parseInt(segment.walking.cost.duration) || 0 : 0,
                        walking: segment.walking
                    };

                    // å¤„ç†æ­¥è¡Œè·¯æ®µçš„è¯¦ç»†ä¿¡æ¯
                    if (segment.walking.steps) {
                        walkingSegment.transit = {
                            origin: segment.walking.origin ? segment.walking.origin.split(',').map(Number).reverse() : null,
                            destination: segment.walking.destination ? segment.walking.destination.split(',').map(Number).reverse() : null,
                            steps: segment.walking.steps
                        };
                    }
                    
                    processedSegments.push(walkingSegment);
                }
                
                // å¤„ç†å…¬äº¤è·¯æ®µï¼ˆåªåœ¨segmentä¸»è¦åŒ…å«å…¬äº¤æ•°æ®æ—¶å¤„ç†ï¼‰
                if (segment.bus && segment.bus.buslines && segment.bus.buslines.length > 0) {
                    // æ£€æŸ¥è¿™ä¸ªsegmentæ˜¯å¦ä¸»è¦æ˜¯å…¬äº¤segmentï¼ˆé¿å…é‡å¤å¤„ç†æ··åˆè·¯æ®µä¸­çš„å…¬äº¤ï¼‰
                    var isMainBusSegment = !segment.walking; // å¦‚æœæ²¡æœ‰æ­¥è¡Œæ•°æ®ï¼Œè¯´æ˜è¿™æ˜¯çº¯å…¬äº¤segment
                    
                    segment.bus.buslines.forEach(function(busline, buslineIndex) {
                        var lineName = busline.name || '';
                        var departureStop = busline.departure_stop;
                        var arrivalStop = busline.arrival_stop;
                        var viaStops = busline.via_stops || [];
                        
                        // æ£€æŸ¥æ˜¯å¦ä¸ºåœ°é“çº¿è·¯
                        var isSubway = busline.type && busline.type.includes('åœ°é“') || 
                                       busline.name && busline.name.includes('åœ°é“') ||
                                       busline.id && busline.id.includes('subway');
                        
                        var busSegment = {
                            instruction: lineName + ' åˆ° ' + (arrivalStop ? arrivalStop.name : 'ç»ˆç‚¹'),
                            duration: busline.cost ? parseInt(busline.cost.duration) || 0 : 0,
                            distance: parseInt(busline.distance) || 0,
                            transit_mode: isSubway ? 'SUBWAY' : 'BUS',
                            time: busline.cost ? parseInt(busline.cost.duration) || 0 : 0,
                            bus: segment.bus
                        };

                        // è®¾ç½®transitä¿¡æ¯ï¼Œæ¯æ¡çº¿è·¯å•ç‹¬å¤„ç†
                        busSegment.transit = {
                            lines: [busline], // åªåŒ…å«å½“å‰çº¿è·¯
                            on_station: departureStop,
                            off_station: arrivalStop,
                            via_stops: viaStops
                        };
                        
                        processedSegments.push(busSegment);
                    });
                }
                
                // å¤„ç†é“è·¯è·¯æ®µï¼ˆåœ°é“ï¼‰
                if (segment.railway) {
                    var railwaySegment = {
                        instruction: 'ä¹˜ååœ°é“',
                        duration: 0,
                        distance: 0,
                        transit_mode: 'SUBWAY',
                        time: 0,
                        railway: segment.railway
                    };
                    processedSegments.push(railwaySegment);
                }
                
                // å°†å¤„ç†å¥½çš„segmentsæ·»åŠ åˆ°æ€»çš„segmentsæ•°ç»„ä¸­
                processedSegments.forEach(function(processedSegment) {
                    segments.push(processedSegment);
                });
            });
        }
        return {
            time: transit.cost ? parseInt(transit.cost.duration) || 0 : 0,
            distance: parseInt(transit.distance) || 0,
            cost: transit.cost ? parseFloat(transit.cost.transit_fee) || 0 : 0,
            segments: segments
        };
    });
}



// ç»‘å®šæœç´¢æŒ‰é’®äº‹ä»¶
document.getElementById('search-btn').addEventListener('click', searchRoute);

// ç§»é™¤é‡å¤çš„å›è½¦äº‹ä»¶å¤„ç†ï¼Œå› ä¸ºè¾“å…¥æç¤ºåŠŸèƒ½å·²ç»å¤„ç†äº†å›è½¦é”®

document.getElementById('cityinput').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
        saveCity(this.value);
        document.getElementById('startinput').focus();
    }
});

// æ›´æ–°æœç´¢æœåŠ¡çš„åŸå¸‚
function updateSearchCity() {
    var city = getCurrentCity();
    if (city !== currentCity) {
        currentCity = city;
        setupAutocomplete();
    }
}
    </script>
</body>
</html>
